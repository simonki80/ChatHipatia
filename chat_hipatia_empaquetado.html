<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
    /* Preloader Styles - Deben ir primero */
    .preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #F5F7F9; /* CAMBIADO: de #ffffff a #F5F7F9 */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .preloader-content {
      text-align: center;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .preloader p {
      color: #333;
      font-family: 'Poppins', sans-serif;
      font-size: 1.2em;
    }
    
    .preloader.hidden {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease, visibility 0.5s;
    }
    
    /* Esto evita el scroll mientras carga */
    body.preloader-active {
      overflow: hidden;
      height: 100vh;
      background: #F5F7F9; /* A√ëADIDO: Fondo del body durante carga */
    }
  </style>
  <!-- Pol√≠tica CSP corregida (agregamos 'unsafe-inline' y 'unsafe-eval' necesarios) -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self' https:;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https:;
    style-src 'self' 'unsafe-inline' https:;
    img-src 'self' https: data:;
    font-src 'self' https: data:;
    connect-src 'self' https:;
  ">
  <title>Math Chat Pro</title>
  
  <!-- Fuentes de Google (mantenemos todas las originales) -->
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome (original) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  
  <!-- Highlight.js (mantenemos todos los lenguajes originales) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <!-- Todos los lenguajes originales -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/java.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/csharp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/ruby.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/swift.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/php.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/r.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/matlab.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/kotlin.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/scala.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/perl.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/lua.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/mathematica.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/html.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/markdown.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/shell.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/dockerfile.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <!-- Plotly (versi√≥n actualizada como ten√≠as) -->
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>

    <!-- MathJax Configuration (original) -->
  <script>
  window.MathJax = {
    tex: {    
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['\\[', '\\]']],
      processEscapes: true,
      packages: {'[+]': ['ams', 'boldsymbol', 'physics']}
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
      ignoreHtmlClass: 'tex2jax_ignore',
      processHtmlClass: 'tex2jax_process',
      enableAssistiveMml: true   // ‚úÖ Habilita capa de texto seleccionable
    },
    loader: {
      load: [
        '[tex]/ams',
        '[tex]/boldsymbol',
        '[tex]/physics',
        'ui/menu',              // Men√∫ contextual de MathJax (opcional)
        'a11y/assistive-mml'    // ‚úÖ Crea un <annotation> invisible con el LaTeX
      ]
    },
    startup: {
      ready: () => {
        console.log('‚úÖ MathJax est√° listo con copiado de LaTeX');
        MathJax.startup.defaultReady();
        MathJax.startup.promise.then(() => {
          console.log('üéâ Render finalizado');
        });
      }
    }
  };
  </script>

  
  <!-- MathJax Script (original) -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>

  <!-- MathLive (original) -->
  <script type="module" src="https://unpkg.com/mathlive?module"></script>
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css" />

  <!-- Estilos personalizados (agregamos CSS para corregir hidden) -->
  <link rel="stylesheet" href="styles.css"> 
  
  <style>
    /* Correcci√≥n para elementos hidden */
    [hidden], .hidden {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    
    /* Asegurar que Plotly se muestre correctamente */
    .plotly-graph-container {
      width: 100%;
      height: 500px;
      margin: 20px 0;
    }
  </style>

  <!-- Favicon (original) -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
<style>:root {
    /* üé® Paleta principal minimalista con acento */
    --primary-accent: #1C1C1C; /* Cian moderno para acentos principales */
    --primary-accent-dark: #212121; /* Tono m√°s oscuro para hover/pressed */
    --background-body: #F5F7F9; /* Fondo global: un blanco hueso muy suave */
    --background-container: #ffffff; /* Contenedores principales (chat, etc.) en blanco puro */
    --background-light: #FDFDFD; /* Fondo para elementos ligeros (header, barras) */

    /* üñãÔ∏è Colores de texto */
    --text-dark: #212529; /* Negro carb√≥n para texto principal */
    --text-medium: #6c757d; /* Gris medio para texto secundario */
    --text-light: #F5F7F9; /* Texto claro sobre fondos oscuros */

    /* üî≤ Bordes y sombras */
    --border-color: #e9ecef; /* Gris muy claro, casi imperceptible */
    --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.04);
    --shadow-medium: 0 8px 20px rgba(0, 0, 0, 0.06);
    --shadow-header: 0 3px 10px rgba(0, 0, 0, 0.03);

    /* üí¨ Burbujas de chat */
    --bubble-user: #0081a7; /* Cian para burbuja del usuario */
    --bubble-bot: #F0F3F5; /* Gris muy claro para burbuja del bot */

    /* --- Fuentes --- */
    --font-body: 'Poppins', sans-serif;
    --font-title: 'Inter', sans-serif;
    --font-math: 'Latin Modern Math', 'Times New Roman', serif;

    /* --- Tama√±os de Fuente Base --- */
    --font-size-base: 16px; 
    --font-size-small: 14px; 
    --font-size-large: 20px; 

    /* üìò Colores espec√≠ficos para contenido */
    --bold-color: #212529; /* Negro carb√≥n para √©nfasis */
    --step-highlight: #FBFBFC; /* Blanco sutil para resaltar pasos */
    --definition-bg: #E7F6FA; /* Cian muy suave para definiciones */
    --solution-bg: #F5F7F9; /* Mismo blanco hueso para soluciones */
    --solution-border: #adb5bd; /* Gris claro para el borde de la soluci√≥n */
    --code-bg: #f8f9fa; /* Fondo gris claro para bloques de c√≥digo */

    /* üåô Colores para modo oscuro / sintaxis */
    --background-dark-mode: #161a1e; /* Negro carb√≥n para el fondo oscuro */
    --text-dark-mode: #dee2e6; /* Gris muy claro para el texto en modo oscuro */
    --code-syntax-keyword: #0081a7; /* Cian para palabras clave */
    --code-syntax-string: #c1c5cc; /* Gris claro para strings */
    --code-syntax-comment: #7d858c; /* Gris apagado para comentarios */
    --code-syntax-number: #b4b9bf; /* Gris suave para n√∫meros */
    --code-border-medium: #495057; /* Gris oscuro para bordes */
    --copy-btn-bg: #495057;
    --copy-btn-hover: #6c757d;
    --tag-bg: #212529;
    --tag-text: #ffffff;
}

/* Base global */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: var(--font-body);
    font-size: var(--font-size-base);
    font-weight: 500; /* <-- Haz el texto normal un poco m√°s "gordito" */
    line-height: 1.6;
    color: var(--text-dark);
    background: #F5F7F9 !important; /* Fondo principal */
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

/* Contenedor principal del chat */
.chat-container {
    width: 100%;
    /* No es necesario max-width si quieres que ocupe todo el ancho */
    /* Si quieres un ancho m√°ximo, considera usarlo junto con `margin: 0 auto;` para centrarlo */
    max-width: 850px; /* <-- Com√©ntalo o qu√≠talo si quieres 100% de ancho */
    
    margin: 0 auto; /* Mantenlo si usas max-width para centrar el contenedor */
    
    background: #F5F7F9;
    display: flex;
    flex-direction: column;
    
    /* --- CAMBIOS CLAVE PARA ALTURA COMPLETA --- */
    height: 100vh; /* Ocupa el 100% del alto del viewport (ventana del navegador) */
    max-height: 100vh; /* Asegura que no exceda el alto del viewport */
    /* --- FIN CAMBIOS CLAVE --- */
    
    border-radius: 12px;
    box-shadow: var(--shadow-medium);
    overflow: hidden;
    position: relative;
}

html, body {
    margin: 0;
    padding: 0;
    overflow: hidden; /* Evita el scroll del body si el chat ocupa todo */
    height: 100%; /* Asegura que html y body ocupen el 100% del viewport */
    width: 100%; /* Asegura que html y body ocupen el 100% del viewport */
}


/* El encabezado es transparente y se superpone al fondo del contenedor */
.chat-header {
    background: var(--background-container); /* <-- ¬°HAZLO TRANSPARENTE! */
    color: var(--primary-accent);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    font-size: 0.8em;
    font-weight: bold;
    z-index: 10;
    position: relative;
    
    /* --- ELIMINACI√ìN TOTAL DE SEPARADORES --- */
    box-shadow: none !important; 
    border-bottom: none !important;
    filter: none !important;
}

/* --- Estilos para el bot√≥n de encabezado (header-mode-toggle) --- */
.header-mode-toggle {
    font-family: 'Poppins', sans-serif;
    
    /* Estilo del bot√≥n */
    background-color: var(--background-light); /* Blanco elegante */
    border: 1px solid var(--border-color); /* Gris claro */
    color: var(--primary-accent); /* Azul elegante */
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    padding: 8px 15px;
    border-radius: 8px;
    box-shadow: var(--shadow-subtle); /* Sombra ligera elegante */
    
    /* Transiciones para una animaci√≥n suave */
    transition: all 0.3s ease-in-out;
    
    outline: none;
    
    /* No ocupar todo el espacio */
    display: inline-block;
    
    /* Texto centrado */
    text-align: center;
    
    white-space: nowrap;
}

/* Estilos al pasar el rat√≥n por encima del bot√≥n */
.header-mode-toggle:hover {
    background-color: #e9ecef;
    color: #343a40;
    border-color: #ced4da;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.12);
}

/* Estilos al hacer clic en el bot√≥n */
.header-mode-toggle:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    background-color: #e2e6ea;
}

/* --- Nuevo Estilo para el "Segundo Header" --- */
/* --- Estilos para el Secondary Header (Revisado para elegancia) --- */
.secondary-header {
    background-color: var(--background-light);
    border-bottom: 1px solid var(--border-color);
    padding: 10px 20px; /* Reducimos el padding general del header */
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    z-index: 9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px; /* Reducimos el espacio entre los grupos */
    flex-wrap: wrap;
}

/* --- Grupo de Botones de Tutor√≠a (Izquierda) --- */
.tutor-controls-left {
    display: flex;
    gap: 8px; /* Reducimos el espacio entre los botones individuales */
    flex-wrap: wrap;
}

.tutor-button {
    padding: 6px 12px;
    background-color: transparent; /* ¬°Fondo transparente! */
    border: 1px solid transparent; /* El borde tambi√©n transparente */
    border-radius: 6px;
    color: var(--text-medium); /* Texto gris (usando text-medium como especificaste) */
    font-size: 0.8em;
    font-weight: 500;
    cursor: pointer;
    transition: box-shadow 0.25s ease-out, transform 0.15s ease-out, color 0.25s ease-out; /* Transiciones para sombra, transform y color */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06); /* Sombra inicial sutil para el efecto de levantamiento */
}

.tutor-button:hover {
    color: var(--primary-accent); /* El texto se vuelve azul al pasar el rat√≥n */
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); /* Sombra m√°s pronunciada al levantar */
    transform: translateY(-2px); /* Efecto de levantamiento */
}

.tutor-button:active {
    color: var(--text-medium); /* El texto vuelve a gris al presionar */
    transform: translateY(0); /* Vuelve a la posici√≥n original (presionado) */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); /* Sombra m√°s peque√±a para el efecto de presionado */
}

/* --- Grupo de Selector de Examen y Bot√≥n 'Start' (Derecha) --- */
.tutor-exam-group {
    display: flex;
    align-items: center;
    gap: 8px; /* Reducimos el espacio entre el selector y el bot√≥n Start */
    flex-wrap: wrap;
}

.mode-prompt {
    color: var(--text-dark); /* Texto oscuro para buena legibilidad */
    font-size: 0.95em;
    font-weight: 500;
    white-space: nowrap; /* Evita que el texto se rompa */
}

/* --- Selector de Examen (Desplegable) --- */
.exam-type-select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;

    padding: 7px 15px; /* Selector m√°s compacto */
    border-radius: 6px;
    border: 1px solid var(--border-color);
    background-color: var(--background-light);
    color: var(--text-dark);
    font-size: 0.85em;
    font-family: var(--font-body);
    cursor: pointer;
    outline: none;
    transition: all 0.2s ease-in-out;
    box-shadow: none;

    background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236c757d%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13%205.7L146.2%20224.2%2018.8%2075.1a17.6%2017.6%200%200%200-25.7%2023.1l132.4%20146.8c4.3%204.4%2010.4%206.9%2016.9%206.9s12.6-2.5%2016.9-6.9l132.4-146.8c14.2-15.5%203.2-39.7-22.6-39.7z%22%2F%3E%3C%2Fsvg%3E');
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 10px;
}

.exam-type-select:hover {
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
    background-color: var(--background-container-hover);
}

.exam-type-select:focus {
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
}


/* Estilo para las opciones del select (dentro del desplegable) */
.exam-type-select option {
    background-color: var(--background-container);
    color: var(--text-dark);
}

/* --- Bot√≥n de Inicio de Examen ('Start') --- */
.exam-button {
    padding: 7px 18px; /* Bot√≥n Start compacto, ¬°sin cambios en colores! */
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9em;
    font-weight: 600;
    transition: background-color 0.2s ease-in-out, transform 0.1s ease-out, box-shadow 0.2s ease-in-out;
    color: #fff; /* Texto blanco */
    background-color: var(--primary-accent); /* Fondo azul principal */
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
}

.exam-button:hover {
    background-color: var(--primary-accent-dark);
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
}

.exam-button:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.exam-button:disabled {
    background-color: #cccccc;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
    opacity: 0.7;
}

/* --- Reasoner Toggle --- */
.reasoner-toggle {
    /* Layout and basic shape */
    display: flex;
    align-items: center; 
    justify-content: flex-end; 
    margin-left: auto; 
    padding: 6px 14px; 

    /* Fondo con degradado elegante */
    background: var(--background-light);
    
    border-radius: 25px; /* Estilo pill */
    gap: 10px; 
    box-shadow: var(--shadow-subtle); 
    transition: all 0.3s ease-in-out; 
    cursor: pointer; 
    border: 1px solid var(--border-color); 
}

/* --- Reasoner Label --- */
.reasoner-label {
    font-size: 0.9em; 
    font-weight: 600; 
    color: var(--text-dark); 
    white-space: nowrap; 
    user-select: none; 
}

/* --- Reasoner Tooltip --- */
.reasoner-tooltip {
    position: relative; /* Necesario para posicionar el tooltip-text */
    cursor: pointer;    /* Indica que es interactivo */
}

.reasoner-tooltip .tooltip-text {
    visibility: hidden; /* Oculto por defecto */
    width: 140px;       /* Un poco m√°s ancho para elegancia */
    background-color: var(--background-body); /* Gris carb√≥n elegante */
    color: var(--text-light); /* Texto claro para contraste */
    text-align: center; 
    border-radius: 8px; 
    padding: 10px 12px; 
    position: absolute; 
    z-index: 1; 
    top: 125%; 
    left: 50%;  /* Mejor centrado */
    transform: translateX(-50%); 
    opacity: 0; 
    transition: opacity 0.3s ease, transform 0.3s ease; 
    font-size: 0.8em; 
    font-weight: normal; 
    box-shadow: var(--shadow-medium); /* Consistencia con la paleta */
}

/* Tooltip visible */
.reasoner-tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
    transform: translateX(-50%) translateY(5px); /* Sutil movimiento elegante */
}

/* --- Switch Styling --- */
.switch {
    position: relative;
    display: inline-block;
    width: 44px; /* Slightly wider switch */
    height: 24px; /* Slightly taller switch */
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

/* --- Slider (Toggle Switch) --- */
.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--border-color); /* Neutro apagado */
    transition: 0.4s;
    border-radius: 24px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15);
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 2px;
    bottom: 2px;
    background-color: var(--background-container); /* Elegante y limpio */
    transition: 0.4s;
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
}

input:checked + .slider {
    background-color: var(--primary-accent); /* Azul elegante para ON */
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1), 
                0 0 0 2px rgba(0, 123, 255, 0.25); /* Anillo suave */
}

input:checked + .slider:before {
    transform: translateX(20px);
    background-color: var(--background-container);
}

/* --- Warning Message --- */
.reasoner-warning {
    display: none;
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--background-body); /* Gris carb√≥n elegante */
    color: var(--bold-color); /* Texto claro */
    padding: 12px 25px;
    border-radius: 8px;
    box-shadow: var(--shadow-medium);
    z-index: 1000;
    max-width: 90%;
    width: fit-content;
    text-align: center;
    border-left: 6px solid var(--primary-accent); /* Azul elegante */
    opacity: 0;
    transition: opacity 0.4s ease-out, transform 0.4s ease-out;
}

.reasoner-warning.show {
    display: block;
    opacity: 1;
    transform: translateX(-50%) translateY(0); /* Final state for animation */
}

.reasoner-warning.hide {
    opacity: 0;
    transform: translateX(-50%) translateY(20px); /* Hides by moving down and fading */
}

/* Estilos generales para todos los elementos <li> dentro de las burbujas de chat */
.chat-bubble ul li,
.chat-bubble ol li { /* Aplicamos a ul y ol para unificar vi√±etas a un punto */
    margin-bottom: 0.2em;   /* Espacio reducido entre elementos de lista */
    line-height: 1.5;       /* Altura de l√≠nea para legibilidad */
    color: var(--text-dark); /* Color de texto consistente */
    position: relative;     /* Necesario para posicionar la vi√±eta personalizada */
    padding-left: 1.2em;    /* Espacio para la vi√±eta personalizada */
    list-style: none;       /* ¬°Muy Importante! Elimina vi√±etas/n√∫meros nativos */
}

/* Oculta los estilos predeterminados de las listas */
.chat-bubble ul,
.chat-bubble ol {
    list-style: none;
    padding-left: 0; /* Elimina el padding predeterminado de la lista */
    margin-top: 8px; /* Espacio superior reducido */
    margin-bottom: 8px; /* Espacio inferior reducido */
}

/* --------------- Vi√±eta de punto personalizada para TODOS los li --------------- */
.chat-bubble ul li::before,
.chat-bubble ol li::before {
    content: "‚Ä¢"; /* Un simple punto Unicode como vi√±eta */
    position: absolute;
    left: 0; /* Posiciona la vi√±eta al inicio del padding-left de li */
    top: 0; /* Alinea con la parte superior del texto */
    color: var(--neutral-highlight-dark); /* ¬°El color gris "gordito"! */
    font-weight: 600; /* Lo hace m√°s "gordito" */
    font-size: 1.1em; /* Un poco m√°s grande que el texto para que destaque */
    line-height: inherit; /* Hereda la altura de l√≠nea del li */
}

/* Elimina el margen inferior del √∫ltimo elemento de lista para evitar espacio extra */
.chat-bubble ul li:last-child,
.chat-bubble ol li:last-child {
    margin-bottom: 0;
}
/* Caja de chat y burbujas */
.chat-box {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    padding-top: 60px; /* Espacio reducido para la cabecera */
    display: flex;
    flex-direction: column;
    gap: 15px;
    background-color: #F5F7F9; /* Fondo limpio y elegante */
    scroll-behavior: smooth;
    color: var(--text-dark); /* Texto principal oscuro */
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Un toque de profundidad sutil */
    border-radius: 8px; /* Opcional: suavizar esquinas si lo deseas */
}


/* ======================= ESTILOS PARA LA ESTETICA DENTRO DEL CHAT =============================  */
.chat-msg {
    display: flex;
    max-width: 100%;
    font-size: 15px; /* Tama√±o de fuente reducido */
}

.chat-msg.user {
    justify-content: flex-end;
}

.chat-msg.bot {
    justify-content: flex-start;
}

.chat-bubble {
    max-width: 100%;
    padding: 20px 20px; /* Padding reducido */
    border-radius: 10px;
    box-shadow: var(--shadow-subtle);
    white-space: pre-wrap;
    word-wrap: break-word;
    transition: all 0.2s ease-in-out;
    position: relative;
    font-family: var(--font-body);
    line-height: 1.6;
}

.chat-msg.user .chat-bubble {
    max-width: 80%;
    background-color: var(--primary-accent-dark); /* Azul oscuro elegante */
    color: var(--text-light); /* Texto claro para contraste */
    border-bottom-right-radius: 6px;
    border-radius: 12px; /* M√°s suave y moderno */
    padding: 10px 14px; /* Espaciado interno */
    box-shadow: var(--shadow-subtle); /* Toque de profundidad */
}


.chat-msg.bot .chat-bubble {
    background-color: transparent;
    color: var(--text-dark);
    border: none;
    border-bottom-left-radius: 0;
    padding: 30px 15px 30px 15px; /* Padding reducido */
    box-shadow: none;
    max-width: 100%;
}

.chat-msg.bot .chat-bubble .copy-message-btn {
    top: 0px;
    right: 0px;
    background: rgba(255, 255, 255, 0.6);
    border: 1px solid var(--border-color);
}
/* Estilos para contenido del bot */
.bot-content {
    width: 100%;
}

/* Botones de copiar (LaTeX, mensaje completo) */
.latex-copy {
    position: relative;
    display: inline-block;
}

.copy-latex-btn, .copy-message-btn {
    background: rgba(255,255,255,0.8);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 5px;
    width: 28px; /* Tama√±o reducido */
    height: 28px; /* Tama√±o reducido */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s;
    box-shadow: var(--shadow-subtle);
}

.copy-latex-btn {
    position: absolute;
    right: -30px; /* Posici√≥n ajustada */
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px; /* Tama√±o reducido */
}

.latex-copy:hover .copy-latex-btn {
    opacity: 1;
    background: #f0f4f7;
}

.mathlive-input {
  background-color: var(--background-light); /* Fondo limpio y elegante */
  border: 1px solid var(--border-color); /* Borde sutil y consistente */
  border-radius: 8px;
  padding: 8px 12px;
  font-family: 'Roboto Mono', monospace; /* Perfecto para matem√°ticas */
  resize: none;
  min-height: 2em;
  color: var(--text-dark); /* Texto principal */
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); /* Profundidad ligera */
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.mathlive-input:focus {
  border-color: var(--primary-accent); /* Azul elegante al enfocar */
  box-shadow: 0 0 0 2px rgba(0,123,255,0.2); /* Anillo suave */
  outline: none;
}


.copy-message-btn {
    position: absolute;
    top: 8px; /* Posici√≥n ajustada */
    right: 8px; /* Posici√≥n ajustada */
}

.chat-bubble:hover .copy-message-btn {
    opacity: 1;
}

.copy-message-btn:hover {
    background: var(--step-highlight); /* Gris muy claro elegante */
    transform: translateY(-1px);
    box-shadow: var(--shadow-subtle); /* Consistente con la paleta */
}

/* Mensaje de √©xito */
.copy-success {
    position: absolute;
    top: 8px;
    right: 40px;
    background: var(--primary-accent); /* Azul elegante */
    color: var(--text-light); /* Texto claro */
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 12px;
    display: none;
    white-space: nowrap;
    animation: fadeIn 0.3s ease-out;
    box-shadow: var(--shadow-medium); /* Un poco de profundidad */
    z-index: 20;
}


/* ======================= ESTILOS PARA LA ESTETICA DENTRO DEL CHAT =============================  */

/* Estilos para los pasos */
.step {
    margin: 20px 0;
    padding: 20px 24px;
    background-color: #F8F8F8;
    border-radius: 12px;
    border: 1px solid #e9ecef; /* borde fijo, no transparente */
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05); /* sombra ligera */
}

/* Encabezado del paso */
.step h2 {
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 1.25rem;
    color: #495057;
}

/* L√≠nea decorativa del t√≠tulo */
.step h2::after {
    content: '';
    display: block;
    margin-top: 6px;
    width: 40px;
    height: 3px;
    background-color: #ced4da;
    border-radius: 2px;
}

/* Estilos para el enlace de explicaci√≥n */
.explain-link {
    font-size: 12px;
    color: var(--primary-accent);
    cursor: pointer;
    margin-left: 8px;
    text-decoration: none;
    font-weight: 600;
}

.similar-exercises {
    margin-bottom: 15px;
    padding: 15px 18px;
    background-color: #fcfcfc;
    border-radius: 10px;
    position: relative;
    transition: all 0.2s ease-in-out;
    border: 1px solid #e9ecef;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    color: var(--text-dark);
}

.similar-exercises:hover {
    background-color: #ffffff;
    border-color: #dee2e6;
    box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    transform: translateY(-2px);
}

.similar-exercises:before {
    content: "Ejercicios Similares";
    position: absolute;
    top: -12px;
    left: 15px;
    background: #28a745; /* Verde en lugar de azul */
    color: #F8F8F8;
    padding: 3px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Secci√≥n de soluci√≥n final */
.full-solution {
    margin-top: 0px;
    margin-bottom: 0px;
    padding: 10px; /* Significantly reduced internal padding */
    background-color: #ffffff;
    border: 1px solid var(--border-medium, #d0d0d0); /* Using a fallback color for --border-medium */
    border-radius: 6px; /* Tighter corners */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12); /* More prominent, yet still elegant shadow for "pop" */
    color: var(--text-dark, #333); /* Using a fallback color for --text-dark */
    position: relative;
    overflow: hidden;
    /* Added subtle gradient for depth - makes it less flat */
    background: linear-gradient(to bottom right, #f8f8f8, #ffffff);
}

/* The "subtitle" now acts as the visible label/title within the block */
.full-solution .subtitle {
    margin-top: 0;
    margin-bottom: 0px; /* Very tight space below the title */
    color: var(--neutral-highlight-dark, #555); /* Using a fallback color for --neutral-highlight-dark */
    font-weight: 700;
    font-size: 1.1em; /* Slightly smaller for compactness */
    text-transform: uppercase;
    letter-spacing: 0.7px; /* Tighter letter spacing */
    border-bottom: 1px solid var(--neutral-highlight-light, #eee); /* Thinner, lighter underline */
    padding-bottom: 0px; /* Reduced padding below the title for the underline */
}

/* Styles for the actual solution content */
.full-solution .solution-content {
    line-height: 1.5; /* Tightest line height for dense paragraphs */
    font-size: 0.95em; /* Slightly smaller font for maximum compactness */
    color: var(--text-darker, #444); /* Using a fallback color for --text-darker */
    margin-bottom: 0px; /* Reduced space below the content */
}

/* Style for the "Probar este c√≥digo en LaTeX" button */
.copy-full-latex {
    display: block; /* Make it a block element to span full width */
    margin-top: 0px; /* Tight space above the button */
    font-size: 13px; /* Slightly smaller font for button */
    color: var(--neutral-highlight-dark, #555);
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    transition: color 0.3s ease, text-decoration 0.3s ease;
    clear: both; /* Ensure it clears any floats */
    text-align: left; /* Align button text to the left (beginning of card) */
    padding-left: 0; /* Remove any default padding that might push it */
}

.copy-full-latex:hover {
    color: var(--primary-color, #007bff); /* Fallback primary color */
    text-decoration: underline;
}

/* Accent line - made thinner and slightly less prominent for compactness */
.full-solution::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 3px; /* Even thinner accent line */
    height: 100%;
    background-color: var(--neutral-highlight-dark, #555);
    border-top-left-radius: 6px;
    border-bottom-left-radius: 6px;
}

.definition {
    background: #FFFFFF;
    border: 1px solid #dee2e6;
    padding: 45px 45px; /* Padding reducido */
    margin: 15px 3px; /* Margen reducido */
    border-radius: 10px; /* Radio reducido */
    position: relative;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05); /* Sombra reducida */
    color: #343a40;
    overflow: visible;
}

.definition:before {
    content: "Definici√≥n";
    position: absolute;
    top: -12px;
    left: 15px;
    background: #007bff;
    color: #F8F8F8;
    padding: 3px 8px; /* Padding reducido */
    border-radius: 6px;
    font-size: 11px; /* Tama√±o reducido */
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}


h1 {
    font-size: 33px; /* Establece el tama√±o para todos los h1 */
    color: #333;
}

hr {
  border: none;
  height: 1px;
  margin: 20px 0;
  background-color: var(--border-color, #444);
  border-radius: 3px;

  /* Toque de profundidad con sombras */
  box-shadow:
    0 1px 2px rgba(0, 0, 0, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.05),
    inset 0 -1px 0 rgba(0, 0, 0, 0.1);
}

.title {
    font-family: var(--font-title);
    font-weight: 700; /* Mantenemos un buen peso para la jerarqu√≠a */
    font-size: 20px; /* Tu tama√±o de fuente actual */
    margin-bottom: 0px; /* Tu margen inferior actual */
    
    /* Colores neutros y elegantes */
    color: var(--text-dark); /* Usa tu color de texto oscuro principal para elegancia */
    /* Puedes probar tambi√©n con: color: #343a40; o un gris oscuro similar */

    /* Sombra de texto sutil para un efecto de profundidad/relieve */
    text-shadow: 
        1px 1px 1px rgba(0, 0, 0, 0.05), /* Sombra ligera hacia abajo-derecha */
        -1px -1px 1px rgba(255, 255, 255, 0.05); /* Luz ligera hacia arriba-izquierda */
        /* O, para un efecto m√°s suave a√∫n (como el que uso aqu√≠): */
        /* 0px 1px 1px rgba(0, 0, 0, 0.08); */
}

.subtitle {
    font-family: var(--font-title);
    font-weight: 600;
    font-size: 18px; /* Tama√±o reducido */
    margin: 15px 0 0px; /* Margen reducido */
    color: var(--text-dark);
}

.highlight {
    background-color: #fffacd;
    padding: 2px 4px; /* Padding reducido */
    border-radius: 3px; /* Radio reducido */
    color: var(--text-dark);
}

.important {
    font-weight: 700;
    color: var(--bold-color);
}

.note {
    font-style: italic;
    color: var(--text-medium);
    border-left: 3px solid var(--border-color); /* Grosor reducido */
    padding-left: 10px; /* Padding reducido */
    margin: 12px 0; /* Margen reducido */
    background-color: #fcfcfc;
    border-radius: 3px; /* Radio reducido */
    padding-top: 6px; /* Padding reducido */
    padding-bottom: 6px; /* Padding reducido */
    color: var(--text-dark);
}

/* ESTILOS PARA MATEM√ÅTICAS */
/* ESTILOS PARA MATEM√ÅTICAS */
.math-text {
    font-family: var(--font-math);
    color: var(--primary-accent-dark);
    font-weight: 500;
    background-color: rgba(0, 123, 255, 0.08);
    padding: 2px 4px; /* Padding reducido */
    border-radius: 3px; /* Radio reducido */
    display: inline-block;
    line-height: 1.4; /* Line-height reducido */
    /* Para inline-block, si el texto es demasiado largo, simplemente se romper√° a la siguiente l√≠nea */
    white-space: normal; /* Asegura que el texto se ajuste y no intente permanecer en una sola l√≠nea */
    word-break: break-word; /* Rompe palabras largas si es necesario para evitar desborde */
}

.math-block {
    font-family: var(--font-math);
    background: var(--code-bg);
    padding: 12px; /* Padding reducido */
    border-radius: 6px; /* Radio reducido */
    margin: 10px 0; /* Margen reducido */
    border-left: 3px solid var(--primary-accent); /* Grosor reducido */
    /* --- MODIFICACIONES CLAVE AQU√ç --- */
    overflow-x: auto; /* Permite desplazamiento horizontal si el contenido es demasiado ancho */
    overflow-y: hidden; /* Oculta el desplazamiento vertical si no es necesario */
    max-width: 100%; /* Asegura que no sea m√°s ancho que su contenedor padre */
    box-sizing: border-box; /* Incluye padding y borde en el ancho total */
    /* --- FIN MODIFICACIONES CLAVE --- */
    position: relative;
    line-height: 1.5; /* Line-height reducido */
    color: var(--text-dark);
}

/* Estilos para MathJax */
.MJXc-display {
    margin: 12px 0 !important; /* Margen reducido */
    /* --- MODIFICACIONES CLAVE AQU√ç --- */
    overflow-x: auto; /* Permite desplazamiento horizontal dentro del bloque de visualizaci√≥n de MathJax */
    overflow-y: hidden; /* Oculta el desplazamiento vertical */
    max-width: 100%; /* Asegura que no sea m√°s ancho que su contenedor padre */
    display: block !important; /* A veces MathJax puede cambiar esto, aseg√∫rate de que sea un bloque */
    /* --- FIN MODIFICACIONES CLAVE --- */
}

.math-block, .MJXc-display {
    overflow-x: auto;       /* Permite scroll horizontal si es necesario */
    overflow-y: hidden;     /* Evita scroll vertical no deseado */
    max-width: 100%;        /* Nunca m√°s ancho que su contenedor */
    box-sizing: border-box; /* Incluye padding en el c√°lculo del ancho */
    display: block;         /* Asegura comportamiento de bloque */
    padding: 12px 8px;      /* Padding reducido para m√≥viles */
    margin: 10px 0;
    -webkit-overflow-scrolling: touch; /* Scroll suave en m√≥viles */
}

/* Asegura que MathJax respete los contenedores */
.MathJax, .MJXc-display {
    max-width: 100% !important;
    overflow-x: auto !important;
}

/* Contenedor de ecuaciones numeradas */
.MathJax_Display {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.data-table table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-family: var(--font-body);
    font-size: 14px;
}

.data-table th,
.data-table td {
    border: 1px solid #dee2e6;
    padding: 10px;
    text-align: left;
}

.data-table th {
    background-color: var(--primary-accent); /* O un color m√°s oscuro de tu paleta */
    color: #F0FCFA;
    font-weight: 600;
}

.data-table tr:nth-child(even) {
    background-color: #f8f9fa; /* Ligeramente m√°s oscuro para filas pares */
}

.data-table tr:hover {
    background-color: #e9ecef; /* Resaltar al pasar el rat√≥n */
}

/* ======================= ESTILOS PARA LAS ALERTAS MEJORADAS ============================= */

.alert-info, .alert-warning, .alert-success, .alert-tip {
    padding: 12px 15px;
    margin: 15px 0;
    border-radius: 8px;
    font-size: 14px;
    display: flex; /* Mantenemos flexbox para el icono y el texto */
    align-items: flex-start; /* Alinea los elementos al inicio del contenedor */
    gap: 10px;
    line-height: 1.5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    flex-wrap: wrap; /* Permite que los elementos se envuelvan a la siguiente l√≠nea */
}

/* Estilos espec√≠ficos para cada tipo de alerta (colores, bordes) */
.alert-info {
    background-color: #e7f3ff;
    border: 1px solid #cce5ff;
    color: #004085;
}

.alert-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeeba;
    color: #856404;
}

.alert-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-tip { /* Nuevo para consejos espec√≠ficos */
    background-color: #e6f7ff;
    border: 1px solid #91d5ff;
    color: #08979c;
}

/* Contenedor para el t√≠tulo y el icono */
.alert-info .alert-header,
.alert-warning .alert-header,
.alert-success .alert-header,
.alert-tip .alert-header {
    display: flex;
    align-items: center;
    gap: 8px; /* Espacio entre el icono y el texto del t√≠tulo */
    /* Para que el header ocupe todo el ancho disponible y empuje el contenido a la siguiente l√≠nea */
    flex-basis: 100%; 
    margin-bottom: 5px; /* Peque√±o margen debajo del encabezado */
}


.alert-info .alert-header i, .alert-warning .alert-header i, .alert-success .alert-header i, .alert-tip .alert-header i {
    font-size: 18px;
    margin-top: 0; /* No necesitamos margen superior aqu√≠ ya que flexbox lo maneja */
    flex-shrink: 0; /* Asegura que el icono no se encoja */
}

.alert-info .alert-header strong, .alert-warning .alert-header strong, .alert-success .alert-header strong, .alert-tip .alert-header strong {
    font-weight: 700;
    margin-right: 0; /* Ya no necesitamos margen a la derecha aqu√≠ */
    line-height: 1; /* Asegura que el texto del t√≠tulo no tenga espacio extra */
}

/* Estilos para el contenido real de la alerta */
.alert-info .alert-content,
.alert-warning .alert-content,
.alert-success .alert-content,
.alert-tip .alert-content {
    flex-basis: 100%; /* El contenido ocupa toda la l√≠nea siguiente */
    margin-top: 0; /* Elimina cualquier margen superior extra */
}

.example-section {
    border: 1px solid #ced4da;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    background-color: #ffffff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    position: relative; /* Esencial para posicionar la etiqueta flotante */
    overflow: visible; /* Asegura que la etiqueta no se recorte si sobresale */
}

/* Etiqueta flotante "Ejemplo" en naranja */
.example-section::before {
    content: "Ejemplo"; /* El texto de la etiqueta */
    position: absolute;
    top: -12px; /* Mueve la etiqueta 12px por encima del borde superior */
    left: 15px; /* Posiciona la etiqueta a 15px del borde izquierdo */
    background: #fd7e14; /* Color naranja distintivo */
    color: #F8F8F8; /* Color del texto de la etiqueta */
    padding: 3px 8px; /* Espaciado interno de la etiqueta */
    border-radius: 6px; /* Bordes redondeados para la etiqueta */
    font-size: 11px; /* Tama√±o de fuente de la etiqueta */
    font-weight: 600; /* Peso de fuente de la etiqueta */
    letter-spacing: 0.5px; /* Espaciado entre letras */
    text-transform: uppercase; /* Texto en may√∫sculas */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Sombra sutil para la etiqueta */
}

.example-section .problem-statement {
    background-color: #f2f4f6;
    border-left: 5px solid var(--primary-accent); /* Mantenemos este azul para el statement del problema */
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.example-section .problem-statement h4 {
    margin-top: 0;
    color: var(--primary-accent-dark); /* Color oscuro del acento para el t√≠tulo del problema */
}

/* Estilo para el enlace "Resolver Ejemplo" */
.solve-example-link {
    display: block; /* Para que ocupe su propia l√≠nea */
    text-align: right; /* Alineado a la derecha */
    margin-top: 15px; /* Espacio superior para separarlo del contenido */
    font-size: 14px;
    color: #fd7e14; /* Mismo color naranja que la etiqueta */
    text-decoration: none; /* Sin subrayado por defecto */
    font-weight: 600;
    transition: color 0.2s ease;
}

.solve-example-link:hover {
    color: #e06c0c; /* Naranja m√°s oscuro al pasar el rat√≥n */
    text-decoration: underline; /* Subrayado al pasar el rat√≥n */
}

.code-block {
    position: relative;
    background-color: #0d1117; /* Fondo gris oscuro */
    border: 1px solid #30363d;
    border-radius: 8px;
    margin: 0px 0px;
    font-family: 'Fira Code', 'Consolas', monospace;
    font-size: 0.95em;
    line-height: 1.5;
    color: #c9d1d9; /* Color de texto por defecto */
    overflow: hidden; /* Importante para que los bordes redondeados se vean bien */
    padding-top: 0px; /* Espacio para el header + la l√≠nea divisoria */
    padding-bottom: 0px; /* Espacio inferior */
    padding-left: 15px; /* Espacio a la izquierda */
    padding-right: 15px; /* Espacio a la derecha */
}

/* Barra divisoria entre el header y el c√≥digo */
.code-block::before {
    content: '';
    position: absolute;
    top: 50px; /* Ajusta esto para la posici√≥n de la l√≠nea */
    left: 0;
    right: 0;
    height: 1px; /* Grosor de la l√≠nea */
    background-color: #30363d; /* Color de la l√≠nea, similar al borde */
    z-index: 0; /* Asegura que la l√≠nea est√© debajo del texto */
}


.code-block .code-lang {
    position: absolute;
    top: 13px; /* Separaci√≥n desde la parte superior del .code-block */
    left: 15px; /* Separaci√≥n desde la izquierda del .code-block */
    background: transparent; /* Sigue siendo transparente */
    -webkit-background-clip: text; /* Aplica el degradado al texto */
    background-clip: text; /* Est√°ndar */
    color: transparent; /* Hace el color del texto transparente */
    
    /* Degradado de blanco brillante a azul muy claro, limpio y n√≠tido */
    background-image: linear-gradient(135deg, #F0F8FF 0%, #FFFFFF 50%, #E0FFFF 100%);
    /*
        #F0F8FF: Un blanco muy suave, casi azulado, como punto de partida
        #FFFFFF: Blanco puro para el centro m√°s brillante
        #E0FFFF: Un azul claro muy sutil para el final, que mantiene la luminosidad
    */

    padding: 0; /* Sin padding */
    border-radius: 0; /* Sin bordes redondeados */
    font-size: 13px; /* Tama√±o un poco m√°s grande */
    font-weight: 700; /* Peso en negrita para que el texto resalte */
    text-transform: none; /* Sin may√∫sculas forzadas */
    letter-spacing: 0.5px; /* Espaciado sutil */
    box-shadow: none; /* ¬°Eliminado! Sin sombra en la caja */
    text-shadow: none; /* ¬°Eliminado! Sin sombra en el texto ni efecto de glow */
    z-index: 2; /* Asegura que la etiqueta est√© sobre la l√≠nea divisoria */
}

.code-block .copy-btn {
    position: absolute;
    top: 10px; /* Alineado con la etiqueta de lenguaje */
    right: 15px; /* Separaci√≥n desde la derecha del .code-block */
    background: #161b22;
    border: 1px solid #30363d;
    color: #8b949e;
    padding:4px 8px; /* Un poco m√°s de padding para que el bot√≥n sea m√°s c√≥modo */
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    z-index: 2; /* Asegura que el bot√≥n est√© sobre la l√≠nea divisoria */
    transition: background 0.2s, color 0.2s, border-color 0.2s;
}

.code-block .copy-btn:hover {
    background-color: #21262d;
    border-color: #8b949e;
    color: #c9d1d9;
}

.code-block .copy-btn i {
    font-size: 11px; /* Ajustado para que el √≠cono no sea demasiado grande */
    margin-right: 4px; /* Peque√±o espacio entre el √≠cono y el texto "Copiar" */
}

/* Contenedor del c√≥digo - ahora con padding interno para el contenido */
.code-block pre {
    margin: 0;
    padding-top: 0px; /* Padding para separar el c√≥digo de la l√≠nea divisoria */
    padding-bottom: 0px; /* Elimina padding adicional si ya est√° en .code-block */
    overflow-x: auto;
    white-space: pre-wrap; /* Mantiene el formato y envuelve l√≠neas largas */
    word-wrap: break-word; /* Rompe palabras para evitar desbordamiento */
    background: transparent !important; /* Asegura que el fondo del pre no opaque el del code-block */
}

.code-block code {
    display: block;
    padding: 0 !important; /* Asegura que el padding del code sea 0 */
    background: transparent !important; /* Asegura que el fondo del code no opaque el del code-block */
    /* Aqu√≠ se aplicar√°n los estilos de .token */
}

/* --- Sintaxis tipo ChatGPT (Colores de tokens) --- */
.token.comment       { color: #8b949e; font-style: italic; }
.token.keyword       { color: #ff7b72; }
.token.string        { color: #a5d6ff; }
.token.number        { color: #f2cc60; }
.token.boolean       { color: #f2cc60; }
.token.function      { color: #d2a8ff; }
.token.property      { color: #79c0ff; }
.token.punctuation   { color: #c9d1d9; }


/* Asegurar que los comentarios en c√≥digo no hereden estilos de headers */
.code-block .token.comment,
.code-block .hljs-comment {
    color: #8b949e !important;
    font-size: 0.95em !important;
    font-style: italic !important;
    font-weight: normal !important;
}

/* Prevenir que los # en c√≥digo se conviertan en headers */
.code-block code .hljs-doctag,
.code-block code .hljs-meta {
    color: inherit !important;
    font-size: inherit !important;
}

/* Reset para elementos dentro de bloques de c√≥digo */
.code-block * {
    font-size: 0.95em !important;
    font-weight: normal !important;
    line-height: 1.5 !important;
}
/* Asegura compatibilidad con Highlight.js */
.hljs {
    background: transparent !important;
    padding: 0 !important;
}

/* Estilos adicionales para Font Awesome si no los tienes globales */
.fas {
    font-family: "Font Awesome 5 Free";
    font-weight: 900; /* Necesario para los iconos s√≥lidos */
}
/* ======================= ESTILOS PARA LA ESTETICA DENTRO DEL CHAT =============================  */

/* √Årea de entrada */
.chat-input-card {
    background: var(--background-light); /* M√°s consistente con la paleta */
    padding: 8px; 
    border-top: none;
    display: flex;
    flex-direction: column;
    gap: 6px;
    box-shadow: 0 -6px 18px rgba(0, 0, 0, 0.04);
    z-index: 10;
    border-radius: 12px 12px 0 0; /* redondeo arriba para elegancia */
}

.chat-input-card textarea {
    width: 100%;
    padding: 12px 16px;
    font-size: 15px;
    border: 1px solid var(--border-light);
    border-radius: 18px;
    resize: none;
    overflow: hidden;
    line-height: 1.5;
    max-height: 130px;
    background: #fff;
    color: var(--text-dark);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    font-family: var(--font-body);
    box-shadow: var(--shadow-subtle);
}

.chat-input-card textarea:focus {
    outline: none;
    border-color: var(--primary-accent);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
}

.chat-tools {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
}

.keyboard-buttons {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.keyboard-category {
    background: transparent;
    color: var(--code-syntax-comment);
    border: none;
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.25s ease;
}

.keyboard-category:hover {
    background: rgba(0, 123, 255, 0.08); /* sutil highlight */
    color: var(--primary-accent);
    transform: translateY(-1px);
    box-shadow: var(--shadow-subtle);
}

.keyboard-category:active {
    background: rgba(0, 123, 255, 0.15); /* un poco m√°s marcado */
    transform: translateY(0);
    box-shadow: inset var(--shadow-subtle);
}


.send-btn {
    background: transparent;
    color: var(--primary-accent);
    border: none;
    font-size: 20px;
    padding: 8px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s ease-in-out;
}

.send-btn:hover {
    background: rgba(0, 123, 255, 0.12); /* Un poco m√°s visible pero suave */
    color: var(--primary-accent);        /* Mantiene la identidad */
    transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.12); /* Sombra m√°s natural, sin bordes duros */
}

.send-btn:active {
    background: rgba(0, 123, 255, 0.2);  /* M√°s intenso al presionar */
    color: var(--primary-accent);        /* CONSISTENCIA: no cambia a negro */
    transform: scale(0.96);              /* Peque√±o ‚Äúclick feedback‚Äù */
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.12); /* Elegante, sin dureza */
}


.send-btn i {
    margin: 0;
}

/* Panel de teclado virtual */
.keyboard-panel {
    display: none;
    flex-direction: column;
    padding: 12px;
    background: var(--background-light);
    border-top: 1px solid var(--border-light);
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.03);
    z-index: 5;
    max-height: 180px;
    overflow-y: auto;
    border-radius: 0 0 12px 12px;
    transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
}

.keyboard-panel.active {
    display: flex;
    animation: fadeIn 0.25s ease-out;
}

.keyboard-panel button {
    background: #fff;
    border: 1px solid var(--border-light);
    padding: 6px 10px;
    font-size: 13px;
    font-family: var(--font-body);
    color: var(--text-dark);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-subtle);
    min-width: 36px;
    text-align: center;
}

.keyboard-panel button:hover {
    background-color: var(--step-highlight);
    border-color: #cdd2d7;
    box-shadow: var(--shadow-medium);
    transform: translateY(-1px);
}

.keyboard-panel .close-btn {
    background-color: var(--border-light);
    color: #6c757d;
    font-weight: 500;
    font-size: 12px;
    border: none;
    border-radius: 6px;
    padding: 5px 10px;
    margin-bottom: 6px;
    align-self: flex-end;
    cursor: pointer;
    transition: all 0.2s ease;
}

.keyboard-panel .close-btn:hover {
    background-color: #cdd2d7;
    color: var(--text-dark);
    box-shadow: var(--shadow-subtle);
    transform: translateY(-1px);
}

.keyboard-panel-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 6px;
}

/* Indicador de carga optimizado */
.loading-indicator {
    display: flex;
    gap: 6px; /* Espacio reducido */
    padding: 8px 0; /* Padding reducido */
    will-change: transform, opacity;
}

.loading-dot {
    width: 4px; /* Tama√±o reducido */
    height: 4px; /* Tama√±o reducido */
    border-radius: 50%;
    background-color: var(--primary-accent);
    opacity: 0.8;
    animation: bounce 1.4s infinite ease-in-out;
    will-change: transform, opacity;
}

/* Animation delays for dots */
.loading-dot:nth-child(2) { animation-delay: 0.15s; }
.loading-dot:nth-child(3) { animation-delay: 0.3s; }

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); opacity: 1; } /* Movimiento reducido */
}

/* Optimizaci√≥n de rendimiento para MathJax */
.MJXc-display, .MJXc-math {
    will-change: transform, opacity;
}

/* Nuevos estilos para texto en negrita */
strong, b {
    font-weight: 700;
    color: var(--bold-color);
}

/* Media queries para responsividad */
@media (max-width: 768px) {
.chat-container {
    height: 100vh;
    border-radius: 0;
    max-height: unset;
}

body {
    align-items: stretch;
}
.secondary-header {
    padding: 8px 10px;
    gap: 10px;
}

.tutor-button, .exam-type-select, .exam-button {
    font-size: 0.75em;
    padding: 5px 10px;
    border-radius: 5px;
}

.exam-type-select {
    background-position: right 8px center;
    background-size: 8px;
}
.chat-header {
    font-size: 14px; /* Tama√±o consistente con el estilo general */
    padding: 10px 12px; /* Padding reducido */
    padding-top: 10px; /* Eliminado el padding-top adicional */
}

.secondary-header {
    padding: 8px 15px;
    gap: 10px;
}

.header-mode-toggle {
    font-size: 0.8em; /* Reducir el tama√±o de fuente en m√≥viles */
}

.chat-box {
    padding: 12px; /* Padding reducido */
    padding-top: 50px; /* Espacio reducido para la cabecera */
    gap: 12px; /* Espacio reducido */
}

.chat-input-card {
    padding: 4px 4px; /* Padding reducido */
    gap: 4px; /* Espacio reducido */
}

.chat-input-card textarea {
    padding: 4px 6px; /* Padding reducido */
    font-size: 14px; /* Tama√±o reducido */
    max-height: 60px; /* Altura reducida */
}

.keyboard-category {
    padding: 4px 8px; /* Padding reducido */
    font-size: 11px; /* Tama√±o reducido */
}

.send-btn {
    padding: 6px 12px; /* Padding reducido */
    font-size: 16px; /* Tama√±o reducido */
}

.keyboard-panel {
    padding: 8px; /* Padding reducido */
    max-height: 160px; /* Altura reducida */
}

.keyboard-panel button {
    padding: 5px 8px; /* Padding reducido */
    font-size: 12px; /* Tama√±o reducido */
    min-width: 30px; /* Ancho reducido */
}

.keyboard-panel-grid {
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); /* Ancho reducido */
    gap: 5px; /* Espacio reducido */
}

.keyboard-panel {
    max-height: 350px; /* Altura reducida */
}

/* Burbujas de chat en m√≥vil */
.chat-msg.user .chat-bubble {
    max-width: 90%;
}

.chat-msg.bot .chat-bubble {
    max-width: 100%;
}

.copy-latex-btn {
    right: 0px;
    top: -22px; /* Posici√≥n ajustada */
    transform: none;
}

.full-solution, .definition {
    padding: 12px 15px; /* Padding reducido */
}

h3 {
    font-family: var(--font-title);
    font-weight: 600;
    font-size: 1.1em; /* Tama√±o reducido */
    margin: 0.8em 0 0.4em; /* Margen reducido */
    color: var(--primary-accent-dark);
}

strong, b {
    font-weight: 700;
    color: var(--bold-color);
}

.reasoner-toggle {
    padding: 4px 10px; /* Reducir el padding */
    border-radius: 20px; /* Un poco menos redondeado, si lo prefieres */
    gap: 6px; /* Reducir el espacio entre elementos */
    flex-shrink: 0;
}

.reasoner-label {
    font-size: 0.7em; /* Hacer la fuente m√°s peque√±a */
}

.switch {
    width: 36px; /* Ancho del switch m√°s peque√±o */
    height: 20px; /* Alto del switch m√°s peque√±o */
}

.slider:before {
    height: 16px; /* Tama√±o del thumb m√°s peque√±o */
    width: 16px; /* Tama√±o del thumb m√°s peque√±o */
    left: 2px;
    bottom: 2px;
}

input:checked + .slider:before {
    transform: translateX(16px); /* Ajustar el movimiento del thumb (36px - 2px left - 2px right - 16px thumb width = 16px travel) */
}

.reasoner-warning {
    bottom: 15px; /* Mover la advertencia un poco m√°s arriba en m√≥viles */
    padding: 10px 20px;
    font-size: 0.9em; /* Fuente un poco m√°s peque√±a para la advertencia */
}
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}



.custom-keyboard {
  margin-top: 0em;
  padding: 0px; /* ¬°CLAVE! Reducimos el padding general para reducir altura */
  background: #f8f8f8;
  border-radius: 2px;
  display: flex;
  flex-direction: column;
  gap: 3px; /* ¬°CLAVE! Reducimos el espacio entre filas para reducir altura */
  box-shadow: 0 -3px 12px rgba(0, 0, 0, 0.06);
  box-sizing: border-box;

  /* Mantener propiedades de posici√≥n y visibilidad seg√∫n tu JS */
  /* position: fixed; bottom: 0; left: 0; right: 0; width: 100%; z-index: 100; */
}

/* --- Filas de Botones dentro del Teclado --- */
.keyboard-row {
  display: flex;
  justify-content: stretch;
  gap: 3px; /* ¬°CLAVE! Reducimos a√∫n m√°s el espacio entre los botones */
  width: 100%;
}

/* --- Estilo de los Botones Individuales del Teclado: Altura Reducida --- */
.custom-keyboard button {
  font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
  font-size: 0.7em; /* ¬°CLAVE! Fuente m√°s peque√±a para los botones */
  padding: 2px 0; /* ¬°CLAVE! Padding vertical muy reducido */
  flex-grow: 1;
  flex-basis: 0;
  text-align: center;
  background: #FFFFFF;
  border: 1px solid #e0e0e0;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
  color: #333;
  min-width: 25px; /* Ancho m√≠nimo ajustado */
  height: 40px; /* ¬°CLAVE! Altura muy reducida para los botones */
  box-sizing: border-box;
  font-weight: 600;
}

.custom-keyboard button:hover {
  background: #f0f0f0;
  border-color: #d0d0d0;
}

.custom-keyboard button:active {
  background: #e5e5e5;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
  transform: translateY(1px);
}

/* --- Estilo para botones con iconos (flechas, retroceso) --- */
.custom-keyboard button i {
    font-size: 0.8em; /* Hacemos los iconos m√°s peque√±os */
    color: #555;
}

/* --- Estilo para botones con LaTeX renderizado --- */
.custom-keyboard button .latex-button {
    font-size: 0.75em; /* Hacemos el LaTeX m√°s peque√±o */
    color: #444;
}

/* --- El bot√≥n principal "Keyboard" (Toggle) - Mantenemos tama√±o est√°ndar --- */
/* Es importante que este bot√≥n no se haga tan peque√±o, ya que no forma parte del teclado en s√≠. */
#toggleCustomKeyboardBtn {
    background: #ffffff;
    color: var(--primary-accent, --primary-accent-dark);
    border: 1px solid #e0e0e0;
    padding: 8px 12px; /* Reducimos ligeramente su padding tambi√©n */
    font-size: 0.9em; /* Reducimos ligeramente su fuente */
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s ease;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 6px;
    margin-bottom: 0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

#toggleCustomKeyboardBtn:hover { background: #f5f5f5; border-color: #d5d5d5; }
#toggleCustomKeyboardBtn:active { background: #e0e0e0; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); transform: translateY(1px); }

#toggleCustomKeyboardBtn::before {
    content: '\f11c';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    font-size: 1em; /* Ajustamos el tama√±o del icono */
    color: var(--primary-accent, --primary-accent-dark);
}

/* --- Clase 'hidden' (Mantener como est√°) --- */
.hidden {
  display: none;
}

/* --- Estilo para el bot√≥n de Espacio: M√°s Ancho --- */
.custom-keyboard .space-button {
    flex-grow: 5;
    font-size: 0.9em; /* Ajustamos la fuente para que se adapte al nuevo tama√±o de los botones */
    font-weight: 600;
}

/* --- Estilo para el bot√≥n de may√∫sculas cuando est√° activo (Mantener) --- */
#shiftButton.active-shift {
    background-color: var(--primary-accent,--primary-accent-dark);
    color: white;
    border-color: var(--primary-accent, --primary-accent-dark);
    box-shadow: 0 2px 6px rgba(0, 123, 255, 0.2);
}
#shiftButton.active-shift i {
    color: white;
}

/* --- Media Queries para responsividad --- */
@media (max-width: 768px) {
    .custom-keyboard {
        padding: 4px;
        gap: 3px;
        border-radius: 6px 6px 0 0;
    }

    .keyboard-row {
        display: flex; /* Activar Flexbox */
        flex-wrap: nowrap; /* ¬°CLAVE! Evita que los elementos salten de l√≠nea */
        gap: 2px; /* Espacio entre los botones */
        justify-content: space-between; /* Distribuye el espacio uniformemente entre los botones */
        align-items: stretch; /* Asegura que los elementos se estiren verticalmente si es necesario (no deber√≠a afectar si la altura es fija) */
    }

    .custom-keyboard button {
        font-size: 1em;
        padding: 5px 0;
        height: 35px; /* ¬°Altura fija, como la ten√≠as! */

        /* ANCHO: Se estira para llenar el espacio disponible */
        flex-grow: 1; /* Permite que el bot√≥n crezca para ocupar el espacio */
        flex-shrink: 1; /* Permite que el bot√≥n se encoja si no hay suficiente espacio */
        flex-basis: 0; /* Punto de partida para el c√°lculo del tama√±o, ayuda a que `flex-grow` sea m√°s efectivo */

        min-width: 0; /* Permite que los botones se hagan muy estrechos si es necesario, sin que un `min-width` los fuerce a saltar de l√≠nea. Si se ven DEMASIADO apretados, puedes ajustar este valor un poco. */

        border-radius: 4px;
    }

    .custom-keyboard button i {
        font-size: 1em;
    }

    .custom-keyboard button .latex-button {
        font-size: 1em;
    }

    #toggleCustomKeyboardBtn {
        padding: 6px 8px;
        font-size: 0.8em;
        gap: 6px;
        margin-top: 4px;
        border-radius: 6px;
    }

    #toggleCustomKeyboardBtn::before {
        font-size: 0.9em;
    }

    .custom-keyboard .space-button {
        flex-grow: 4; /* El bot√≥n de espacio seguir√° siendo el doble de ancho que los dem√°s */
        font-size: 0.8em;
        /* No necesitas un min-width aqu√≠ a menos que sea muy espec√≠fico, ya que flex-grow lo estirar√°. */
    }
}

math-field::part(virtual-keyboard-toggle)::after {
  display: none;
}
math-field::part(virtual-keyboard-toggle) {
  display: none;
}
math-field::part(menu-toggle) {
  display: none;
}

/* Estilos para el men√∫ contextual */
#context-menu {
    display: none;
    flex-direction: column;
    gap: 4px;
    padding: 8px;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    animation: fadeIn 0.2s ease-out;
}

.context-menu-item {
    background: #FFFFFF;
    border: 1px solid #dee2e6;
    padding: 6px 12px;
    font-size: 13px;
    font-family: var(--font-body);
    color: #343a40;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    text-align: left;
    white-space: nowrap;
}

.context-menu-item:hover {
    background-color: #f0f2f5;
    border-color: #cdd2d7;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    transform: translateY(-1px);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* A√±ade esto a tu CSS */
.plotly-graph-container {
  width: 100%;
  height: 500px;
  margin: 20px 0;
  border: 1px solid #eee;
  border-radius: 8px;
  overflow: hidden;
  background-color: #f9f9f9;
  display: flex;
  justify-content: center;
  align-items: center;
}

.plotly-graph-container:empty::before {
    content: "Cargando gr√°fico...";
    color: #666;
    font-style: italic;
}

.plotly-error {
    color: #d32f2f;
    padding: 15px;
    background-color: #ffebee;
    border-radius: 4px;
    border: 1px solid #ef9a9a;
}

.plotly-graph-container > div {
    width: 100% !important;
    height: 100% !important;
}

/* Contenedor del bot√≥n de idioma */
.language-buttons {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-left: 20px;
    margin-right: 6px;
}

/* Estilo del bot√≥n de idioma */
#languageToggleButton {
    background: transparent;
    color: #495057;
    border: 1px solid #dee2e6;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    box-shadow: none;
    
    position: relative;
    width: 80px;
    height: 28px;
    overflow: hidden;
}

/* Contenedores de texto */
.en-text, .es-text {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    
    /* Animaci√≥n del texto: opacidad y desplazamiento */
    transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
}

/* Estado inicial: texto en ingl√©s visible */
.en-text {
    opacity: 1;
    transform: translateY(0);
}

/* Estado inicial: texto en espa√±ol invisible */
.es-text {
    opacity: 0;
    transform: translateY(100%);
}

/* Animaci√≥n cuando el bot√≥n tiene la clase 'es-active' */
#languageToggleButton.es-active .en-text {
    opacity: 0;
    transform: translateY(-100%);
}

#languageToggleButton.es-active .es-text {
    opacity: 1;
    transform: translateY(0);
}

/* Animaci√≥n de sacudida m√°s lenta y org√°nica */
@keyframes wakeUpShake {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    25% { transform: translateX(-5px) rotate(-1deg); }
    50% { transform: translateX(5px) rotate(1deg); }
    75% { transform: translateX(-5px) rotate(-1deg); }
}

/* Aplica la animaci√≥n cuando se hace clic en el bot√≥n */
#languageToggleButton:active {
    animation: wakeUpShake 0.8s ease-in-out;
}

/* Preloader Styles */
.preloader {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: #ffffff;
display: flex;
justify-content: center;
align-items: center;
z-index: 9999;
transition: opacity 0.5s ease;
}

.preloader-content {
text-align: center;
}

.spinner {
width: 50px;
height: 50px;
border: 5px solid #f3f3f3;
border-top: 5px solid #3498db;
border-radius: 50%;
animation: spin 1s linear infinite;
margin: 0 auto 20px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.preloader p {
color: #333;
font-family: 'Poppins', sans-serif;
font-size: 1.2em;
}

.preloader.hidden {
opacity: 0;
pointer-events: none;
}

/* Contenedor general para centrar en la p√°gina */
.math-container {
  display: flex;
  justify-content: center; /* Centra horizontal */
  margin: 12px 0;          /* Un poco de aire vertical */
}

/* Bloque clickeable que ocupa todo el ancho */
.clickable-math-block {
    display: block; /* Ocupa todo el ancho disponible */
    width: 100%; /* Asegura que el ancho sea completo */
    text-align: center;
    padding: 12px 16px;
    border: 1px solid #eef0f3; /* Borde muy sutil para definici√≥n */
    border-radius: 8px;
    background-color: transparent; /* Fondo transparente */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08); /* Sombra un poco m√°s visible */
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
}



/* Ajustes internos de la ecuaci√≥n */
.math-equation {
  margin: 0;
  padding: 0;
}
/* ======================== ESTILOS DEL PANEL SELECTOR ======================== */
.matrix-selector-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fcfcfc;
    padding: 24px;
    border-radius: 16px;
    z-index: 1000;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
    max-width: 400px;
    width: 90%;
}

/* ======================== ESTILOS DEL BOT√ìN DE CERRAR ESPEC√çFICO ======================== */
.matrix-selector-panel .close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: #ffffff; /* Fondo blanco */
    border: 1px solid #e9ecef; /* Borde sutil */
    border-radius: 10px; /* Bordes redondeados */
    color: #495057; /* Texto en gris oscuro */
    font-size: 1rem;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Sombra ligera por defecto */
    font-weight: 500;
}

.matrix-selector-panel .close-btn:hover {
    background-color: #fdfdfe;
    border-color: #ced4da;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.matrix-selector-panel .close-btn:active {
    background-color: #eef0f3;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.08);
    transform: translateY(0);
}

/* ======================== ESTILOS DE LOS GRIDS ======================== */
/* Grid de selecci√≥n de matriz (fijo 5x5) */
.matrix-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 15px;
    margin-top: 15px;
}

/* Grid de niveles (filas o casos) - mantiene el formato adaptable */
.level-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 12px;
    justify-items: center;
    margin-top: 15px;
}

/* ======================== ESTILOS DE LOS BOTONES ======================== */
.level-grid button, .matrix-grid button {
    background-color: #ffffff;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    color: #495057;
    font-size: 1rem;
    padding: 12px 0;
    width: 100%;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* Efecto al pasar el cursor (hover) */
.level-grid button:hover, .matrix-grid button:hover {
    background-color: #fdfdfe;
    border-color: #ced4da;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

/* Bot√≥n activo (seleccionado) */
.level-grid button.active, .matrix-grid button.active {
    background-color: #e6f7ff;
    border-color: #87b2e3;
    color: #2e6099;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08), inset 0 0 0 1px #87b2e3;
    transform: translateY(0);
}

/* Estilo espec√≠fico para los botones de la matriz para que sean cuadrados */
.matrix-grid button {
    aspect-ratio: 1 / 1;
    width: 100%;
    padding: 0;
    font-size: 1.1rem;
}

/* ======================== ESTILOS RESPONSIVOS ======================== */
@media (max-width: 400px) {
    .level-grid {
        grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
        gap: 8px;
    }
    .matrix-selector-panel {
        padding: 20px 15px;
    }
    .matrix-grid {
      gap: 8px;
    }
}


.copy-toast {
    position: absolute;
    background: #4caf50; /* verde para √©xito */
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.9em;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateY(0);
    transition: opacity 0.3s, transform 0.3s;
    pointer-events: none;
    z-index: 9999;
}

.copy-toast.show {
    opacity: 1;
    transform: translateY(-10px);
}

.copy-toast.error {
    background: #f44336; /* rojo para error */
}


</style></head>
<body>

  <!-- Script para mostrar el preloader inmediatamente -->
  <script>
    // Mostrar preloader inmediatamente
    document.body.classList.add('preloader-active');
  </script>
  <!-- Preloader -->
  <div id="preloader" class="preloader">
    <div class="preloader-content">
      <div class="spinner"></div>
      <p>Loading math tools and resources...</p>
    </div>
  </div>
  <div class="chat-container">
  
  <div class="chat-header">
    <button id="mainModeToggleButton" class="header-mode-toggle">Math Chat</button>

    <div class="language-buttons">
      <!-- Bot√≥n de idioma CORREGIDO -->
      <button id="languageToggleButton" class="lang-button">
          <span class="en-text">English</span>
          <span class="es-text">Espa√±ol</span>
      </button>
    </div>
    
    <div class="reasoner-toggle">
      <label class="switch">
        <input type="checkbox" id="reasonerToggle">
        <span class="slider round"></span>
      </label>
      <span class="reasoner-label">Pro</span>
      <div class="reasoner-tooltip">
        <i class="fas fa-info-circle"></i>
        <span class="tooltip-text">Slow mode for difficult problems. It deactivates after 2 prompts.</span>
      </div>
    </div>
  </div>

  <div id="secondaryHeader" class="secondary-header" style="display: none;">
      <div class="tutor-controls-left">
          <button id="hintButton" class="tutor-button">Hint</button>
          <button id="theoreticalButton" class="tutor-button">Theoretical</button>
          <button id="generateProblemButton" class="tutor-button">Generate Problem</button>
      </div>

      <div id="tutorExamGroup" class="tutor-exam-group">
          <select id="examTypeSelect" class="exam-type-select">
              <option value="none">-- Select a exam (coming soon) --</option>
              <option value="icfes">ICFES (Colombia)</option>
              <option value="saber">Pruebas Saber (Colombia)</option>
              <option value="sat">SAT (USA)</option>
              <option value="gre">GRE (USA)</option>
              <option value="ib">IB (International Baccalaureate)</option>
              <option value="general">General (Matem√°ticas)</option>
          </select>

          <button id="startTutorExamBtn" class="exam-button">Start</button>
      </div>
  </div>

  <div class="chat-box" id="chatBox"></div>
    
  <div id="keyboard-algebra" class="keyboard-panel">
      <button class="close-btn" onclick="closeKeyboard()">close</button>

      <button onclick="showMatrixSizeSelector()">
        <span class="latex-button">\( \begin{bmatrix} \boxed{} & \boxed{} \\ \boxed{} & \boxed{} \end{bmatrix} \)</span>
      </button>
      
      <div class="keyboard-panel-grid">
        <button onclick="insertSymbol('\\placeholder{} \\cdot \\placeholder{}')">
          <span class="latex-button">\( \cdot \)</span>
        </button>
        <button onclick="insertSymbol('\\placeholder{}^\\top')">
          <span class="latex-button">\( \boxed{}^\top \)</span>
        </button>
        <button onclick="insertSymbol('\\placeholder{}^{-1}')">
          <span class="latex-button">\( \boxed{}^{-1} \)</span>
        </button>
        <button onclick="insertSymbol('\\left| \\placeholder{} \\right|')">
          <span class="latex-button">\( | \boxed{} | \)</span>
        </button>
        <button onclick="insertSymbol('\\left\\| \\placeholder{} \\right\\|')">
          <span class="latex-button">\( || \boxed{} || \)</span>
        </button>
        <button onclick="insertSymbol('\\overline{\\placeholder{}}')">
          <span class="latex-button">\( \overline{\boxed{}} \)</span>
        </button>
        <button onclick="insertSymbol('\\underline{\\placeholder{}}')">
          <span class="latex-button">\( \underline{\boxed{}} \)</span>
        </button>
        <button onclick="insertSymbol('\\widehat{\\placeholder{}}')">
          <span class="latex-button">\( \widehat{\boxed{}} \)</span>
        </button>
        <button onclick="insertSymbol('\\placeholder{} \\times \\placeholder{}')">
          <span class="latex-button">\( \times \)</span>
        </button>
        <button onclick="insertSymbol('\\placeholder{} \\oplus \\placeholder{}')">
          <span class="latex-button">\( \oplus \)</span>
        </button>
        <button onclick="insertSymbol('\\placeholder{} \\otimes \\placeholder{}')">
          <span class="latex-button">\( \otimes \)</span>
        </button>
        <button onclick="insertSymbol('\\langle \\placeholder{}, \\placeholder{} \\rangle')">
          <span class="latex-button">\( \langle , \rangle \)</span>
        </button>
        <button onclick="insertSymbol('T: \\placeholder{} \\to \\placeholder{}')">
          <span class="latex-button">\( T \to \)</span>
        </button>
        <button onclick="insertSymbol('\\lambda')">
          <span class="latex-button">\( \lambda \)</span>
        </button>
        <button onclick="insertSymbol('v')">
          <span class="latex-button">\( v \)</span>
        </button>
        <button onclick="insertSymbol('I')">
          <span class="latex-button">\( I \)</span>
        </button>
        <button onclick="insertSymbol('\\det(\\placeholder{} - \\lambda \\placeholder{})')">
          <span class="latex-button">\( \det() \)</span>
        </button>
        <button onclick="insertSymbol('\\vec{\\placeholder{}}')">
          <span class="latex-button">\( \vec{v} \)</span>
        </button>
        <button onclick="insertSymbol('\\hat{\\placeholder{}}')">
          <span class="latex-button">\( \hat{v} \)</span>
        </button>
        <button onclick="insertSymbol('\\pmod{\\placeholder{}}')">
          <span class="latex-button">\( \pmod{} \)</span>
        </button>
        <button onclick="insertSymbol('\\mapsto')">
          <span class="latex-button">\( \mapsto \)</span>
        </button>
      </div>
  </div>

  <!-- Panel selector de tama√±o de matriz (inicialmente oculto) -->
  <div id="matrix-size-selector" class="matrix-selector-panel" style="display:none;">
      <button class="close-btn" onclick="closeMatrixSelector()">close</button>
      <h3>Select Matrix Size:</h3>
      <div class="matrix-grid"></div>
  </div>

  <div id="keyboard-calculus" class="keyboard-panel">
      <button class="close-btn" onclick="closeKeyboard()">close</button>
      <div class="keyboard-panel-grid">
        <button onclick="showCasesSelector()">
          <span class="latex-button">
            \( 
              \left\{ 
                \begin{array}{l} 
                  \, \\ 
                  \, 
                \end{array} 
              \right. 
            \)
          </span>
        </button>

        <button onclick="insertSymbol('\\frac{d}{dx}\\placeholder{}')">
          <span class="latex-button">\( \frac{d}{dx}\boxed{} \)</span>
        </button>
        <button onclick="insertSymbol('\\frac{d^2}{dx^2}\\placeholder{}')">
          <span class="latex-button">\( \frac{d^2}{dx^2}\boxed{} \)</span>
        </button>
        <button onclick="insertSymbol('\\frac{\\partial}{\\partial \\placeholder{}}\\placeholder{}')">
          <span class="latex-button">\( \frac{\partial}{\partial \boxed{}}\boxed{} \)</span>
        </button>
        <button onclick="insertSymbol('\\frac{\\partial^2 \\placeholder{}}{\\partial \\placeholder{}\\partial \\placeholder{}}')">
          <span class="latex-button">\( \frac{\partial^2 \boxed{}}{\partial \boxed{}\partial \boxed{}} \)</span>
        </button>
        <button onclick="insertSymbol('\\int \\placeholder{}\\,d\\placeholder{}')">
          <span class="latex-button">\( \int \boxed{}\thinspace d\boxed{} \)</span>
        </button>
        <button onclick="insertSymbol('\\int_{\\placeholder{}}^{\\placeholder{}} \\placeholder{}\\,d\\placeholder{}')">
          <span class="latex-button">\( \int_{\boxed{}}^{\boxed{}} \boxed{}\thinspace d\boxed{} \)</span>
        </button>
        <button onclick="insertSymbol('\\iint \\placeholder{}\\,d\\placeholder{}')">
          <span class="latex-button">\( \iint \boxed{}\thinspace d\boxed{} \)</span>
        </button>
        <button onclick="insertSymbol('\\iiint \\placeholder{}\\,d\\placeholder{}')">
          <span class="latex-button">\( \iiint \)</span>
        </button>
        <button onclick="insertSymbol('\\oint \\placeholder{}\\,d\\placeholder{}')">
          <span class="latex-button">\( \oint \boxed{}\thinspace d\boxed{} \)</span>
        </button>
        <button onclick="insertSymbol('\\oint_C \\placeholder{}\\,d\\placeholder{}')">
          <span class="latex-button">\( \oint_C \)</span>
        </button>
        <button onclick="insertSymbol('\\nabla \\placeholder{}')">
          <span class="latex-button">\( \nabla \boxed{} \)</span>
        </button>
        <button onclick="insertSymbol('\\nabla \\cdot \\placeholder{}')">
          <span class="latex-button">\( \nabla \cdot \)</span>
        </button>
        <button onclick="insertSymbol('\\nabla \\times \\placeholder{}')">
          <span class="latex-button">\( \nabla \times \)</span>
        </button>
        <button onclick="insertSymbol('\\Delta \\placeholder{}')">
          <span class="latex-button">\( \Delta \boxed{} \)</span>
        </button>
        <button onclick="insertSymbol('\\lim_{x \\to \\placeholder{}} \\placeholder{}')">
          <span class="latex-button">\( \lim_{\boxed{} \to \boxed{}} \boxed{} \)</span>
        </button>
        <button onclick="insertSymbol('\\frac{d}{dx}\\left(\\frac{\\placeholder{}}{\\placeholder{}}\\right) = \\frac{\\placeholder{}\\frac{d}{dx}(\\placeholder{}) - \\placeholder{}\\frac{d}{dx}(\\placeholder{})}{(\\placeholder{})^2}')">
          <span class="latex-button">\( (\frac{f}{g})' \)</span>
        </button>

        <button onclick="insertSymbol('\\epsilon')">
          <span class="latex-button">\( \epsilon \)</span>
        </button>
        <button onclick="insertSymbol('\\delta')">
          <span class="latex-button">\( \delta \)</span>
        </button>
        <button onclick="insertSymbol('\\approx')">
          <span class="latex-button">\( \approx \)</span>
        </button>
        <button onclick="insertSymbol('\\equiv')">
          <span class="latex-button">\( \equiv \)</span>
        </button>
        <button onclick="insertSymbol('\\infty')">
          <span class="latex-button">\( \infty \)</span>
        </button>
        <button onclick="insertSymbol('\\sum_{n=\\placeholder{}}^\\infty')">
          <span class="latex-button">\( \sum^\infty \)</span>
        </button>
        <button onclick="insertSymbol('\\vec{F}')">
          <span class="latex-button">\( \vec{F} \)</span>
        </button>
        <button onclick="insertSymbol('x_i')">
          <span class="latex-button">\( x_i \)</span>
        </button>
        <button onclick="insertSymbol('\\langle \\vec{u}, \\vec{v} \\rangle')">
          <span class="latex-button">\( \langle u, v \rangle \)</span>
        </button>
      </div>
  </div>

  <div id="cases-selector" class="matrix-selector-panel" style="display:none;">
      <button class="close-btn" onclick="closeCasesSelector()">close</button>
      <h3>Pieces for Your Piecewise Function</h3>
      <div class="level-grid"></div>
  </div>

  <div id="keyboard-symbols" class="keyboard-panel">
      <button class="close-btn" onclick="closeKeyboard()">close</button>
      <div class="keyboard-panel-grid">
        <!-- S√≠mbolos de Estad√≠stica y Probabilidad -->
        
        <!-- Operadores B√°sicos y Notaci√≥n -->
        <button onclick="insertSymbol('\\mu')">
          <span class="latex-button">\( \mu \)</span>
        </button>
        <button onclick="insertSymbol('\\bar{x}')">
          <span class="latex-button">\( \bar{x} \)</span>
        </button>
        <button onclick="insertSymbol('\\sigma')">
          <span class="latex-button">\( \sigma \)</span>
        </button>
        <button onclick="insertSymbol('s')">
          <span class="latex-button">\( s \)</span>
        </button>
        <button onclick="insertSymbol('\\sigma^2')">
          <span class="latex-button">\( \sigma^2 \)</span>
        </button>
        <button onclick="insertSymbol('s^2')">
          <span class="latex-button">\( s^2 \)</span>
        </button>
        <button onclick="insertSymbol('P(\\placeholder{})')">
          <span class="latex-button">\( P(\boxed{}) \)</span>
        </button>
        <button onclick="insertSymbol('P(\\placeholder{} \\mid \\placeholder{})')">
          <span class="latex-button">\( P(\boxed{} \mid \boxed{}) \)</span>
        </button>
        <button onclick="insertSymbol('E[\\placeholder{}]')">
          <span class="latex-button">\( E[\boxed{}] \)</span>
        </button>
        <button onclick="insertSymbol('Var(\\placeholder{})')">
          <span class="latex-button">\( Var(\boxed{}) \)</span>
        </button>
        <button onclick="insertSymbol('Cov(\\placeholder{}, \\placeholder{})')">
          <span class="latex-button">\( Cov(\boxed{}, \boxed{}) \)</span>
        </button>
        <button onclick="insertSymbol('\\rho')">
          <span class="latex-button">\( \rho \)</span>
        </button>

        <!-- Distribuciones y Conceptos -->
        <button onclick="insertSymbol('\\mathcal{N}(\\mu, \\sigma^2)')">
          <span class="latex-button">\( \mathcal{N}(\mu, \sigma^2) \)</span>
        </button>
        <button onclick="insertSymbol('B(n, p)')">
          <span class="latex-button">\( B(n, p) \)</span>
        </button>
        <button onclick="insertSymbol('P(\\lambda)')">
          <span class="latex-button">\( P(\lambda) \)</span>
        </button>
        <button onclick="insertSymbol('\\placeholder{}!')">
          <span class="latex-button">\( \boxed{}! \)</span>
        </button>
        <button onclick="insertSymbol('\\binom{n}{k}')">
          <span class="latex-button">\( \binom{n}{k} \)</span>
        </button>
        <button onclick="insertSymbol('P(n, k)')">
          <span class="latex-button">\( P(n, k) \)</span>
        </button>
        <button onclick="insertSymbol('\\infty')">
          <span class="latex-button">\( \infty \)</span>
        </button>
        <button onclick="insertSymbol('\\approx')">
          <span class="latex-button">\( \approx \)</span>
        </button>
        <button onclick="insertSymbol('\\neq')">
          <span class="latex-button">\( \neq \)</span>
        </button>
        <button onclick="insertSymbol('\\le')">
          <span class="latex-button">\( \le \)</span>
        </button>
        <button onclick="insertSymbol('\\ge')">
          <span class="latex-button">\( \ge \)</span>
        </button>
        <button onclick="insertSymbol('\\propto')">
          <span class="latex-button">\( \propto \)</span>
        </button>
        <button onclick="insertSymbol('X')">
          <span class="latex-button">\( X \)</span>
        </button>
        <button onclick="insertSymbol('Y')">
          <span class="latex-button">\( Y \)</span>
        </button>
        <button onclick="insertSymbol('\\Omega')">
          <span class="latex-button">\( \Omega \)</span>
        </button>
        <button onclick="insertSymbol('A')">
          <span class="latex-button">\( A \)</span>
        </button>
        <button onclick="insertSymbol('B')">
          <span class="latex-button">\( B \)</span>
        </button>
        <button onclick="insertSymbol('\\placeholder{}^c')">
          <span class="latex-button">\( \boxed{}^c \)</span>
        </button>
        <button onclick="insertSymbol('E[\\placeholder{} \\mid \\placeholder{}]')">
          <span class="latex-button">\( E[\boxed{} \mid \boxed{}] \)</span>
        </button>
        <button onclick="insertSymbol('\\mathcal{L}')">
          <span class="latex-button">\( \mathcal{L} \)</span>
        </button>
        <button onclick="insertSymbol('H_0')">
          <span class="latex-button">\( H_0 \)</span>
        </button>
        <button onclick="insertSymbol('H_1')">
          <span class="latex-button">\( H_1 \)</span>
        </button>
        <button onclick="insertSymbol('\\alpha')">
          <span class="latex-button">\( \alpha \)</span>
        </button>
        <button onclick="insertSymbol('\\beta')">
          <span class="latex-button">\( \beta \)</span>
        </button>
        <button onclick="insertSymbol('\\chi^2')">
          <span class="latex-button">\( \chi^2 \)</span>
        </button>
        <button onclick="insertSymbol('df')">
          <span class="latex-button">\( df \)</span>
        </button>
      </div>
  </div>

  <div id="keyboard-logic" class="keyboard-panel">
    <button class="close-btn" onclick="closeKeyboard()">close</button>
    <div class="keyboard-panel-grid">

      <!-- Conectores l√≥gicos -->
      <button onclick="insertSymbol('\\land')">
        <span class="latex-button">\( \land \)</span>
      </button>
      <button onclick="insertSymbol('\\lor')">
        <span class="latex-button">\( \lor \)</span>
      </button>
      <button onclick="insertSymbol('\\neg')">
        <span class="latex-button">\( \neg \)</span>
      </button>
      <button onclick="insertSymbol('\\Rightarrow')">
        <span class="latex-button">\( \Rightarrow \)</span>
      </button>
      <button onclick="insertSymbol('\\Leftrightarrow')">
        <span class="latex-button">\( \Leftrightarrow \)</span>
      </button>
      <button onclick="insertSymbol('\\equiv')">
        <span class="latex-button">\( \equiv \)</span>
      </button>

      <!-- Cuantificadores -->
      <button onclick="insertSymbol('\\forall')">
        <span class="latex-button">\( \forall \)</span>
      </button>
      <button onclick="insertSymbol('\\exists')">
        <span class="latex-button">\( \exists \)</span>
      </button>
      <button onclick="insertSymbol('\\exists!')">
        <span class="latex-button">\( \exists! \)</span>
      </button>

      <!-- Conjuntos y relaciones -->
      <button onclick="insertSymbol('\\in')">
        <span class="latex-button">\( \in \)</span>
      </button>
      <button onclick="insertSymbol('\\notin')">
        <span class="latex-button">\( \notin \)</span>
      </button>
      <button onclick="insertSymbol('\\subset')">
        <span class="latex-button">\( \subset \)</span>
      </button>
      <button onclick="insertSymbol('\\subseteq')">
        <span class="latex-button">\( \subseteq \)</span>
      </button>
      <button onclick="insertSymbol('\\supset')">
        <span class="latex-button">\( \supset \)</span>
      </button>
      <button onclick="insertSymbol('\\supseteq')">
        <span class="latex-button">\( \supseteq \)</span>
      </button>
      <button onclick="insertSymbol('\\cup')">
        <span class="latex-button">\( \cup \)</span>
      </button>
      <button onclick="insertSymbol('\\cap')">
        <span class="latex-button">\( \cap \)</span>
      </button>
      <button onclick="insertSymbol('\\setminus')">
        <span class="latex-button">\( \setminus \)</span>
      </button>
      <button onclick="insertSymbol('\\emptyset')">
        <span class="latex-button">\( \emptyset \)</span>
      </button>
      <button onclick="insertSymbol('\\mathcal{P}')">
        <span class="latex-button">\( \mathcal{P} \)</span>
      </button>

      <!-- Uni√≥n e Intersecci√≥n con sub√≠ndices/super√≠ndices (tipo sumatoria) -->
      <button onclick="insertSymbol('\\bigcup_{i=1}^{n}')">
        <span class="latex-button">\( \bigcup_{i=1}^{n} \)</span>
      </button>
      <button onclick="insertSymbol('\\bigcap_{i=1}^{n}')">
        <span class="latex-button">\( \bigcap_{i=1}^{n} \)</span>
      </button>
      <button onclick="insertSymbol('\\bigcup_{i \\in I}')">
        <span class="latex-button">\( \bigcup_{i \in I}\)</span>
      </button>
      <button onclick="insertSymbol('\\bigcap_{i \\in I}')">
        <span class="latex-button">\( \bigcap_{i \in I}\)</span>
      </button>

      <!-- Relaciones especiales -->
      <button onclick="insertSymbol('=')">
        <span class="latex-button">\( = \)</span>
      </button>
      <button onclick="insertSymbol('\\neq')">
        <span class="latex-button">\( \neq \)</span>
      </button>
      <button onclick="insertSymbol('<')">
        <span class="latex-button">\( < \)</span>
      </button>
      <button onclick="insertSymbol('>')">
        <span class="latex-button">\( > \)</span>
      </button>
      <button onclick="insertSymbol('\\leq')">
        <span class="latex-button">\( \leq \)</span>
      </button>
      <button onclick="insertSymbol('\\geq')">
        <span class="latex-button">\( \geq \)</span>
      </button>

      <!-- Conjuntos universales y naturales -->
      <button onclick="insertSymbol('\\mathbb{N}')">
        <span class="latex-button">\( \mathbb{N} \)</span>
      </button>
      <button onclick="insertSymbol('\\mathbb{Z}')">
        <span class="latex-button">\( \mathbb{Z} \)</span>
      </button>
      <button onclick="insertSymbol('\\mathbb{Q}')">
        <span class="latex-button">\( \mathbb{Q} \)</span>
      </button>
      <button onclick="insertSymbol('\\mathbb{R}')">
        <span class="latex-button">\( \mathbb{R} \)</span>
      </button>
      <button onclick="insertSymbol('\\mathbb{C}')">
        <span class="latex-button">\( \mathbb{C} \)</span>
      </button>

      <!-- Misc l√≥gica avanzada -->
      <button onclick="insertSymbol('\\therefore')">
        <span class="latex-button">\( \therefore \)</span>
      </button>
      <button onclick="insertSymbol('\\because')">
        <span class="latex-button">\( \because \)</span>
      </button>

    </div>
  </div>

  <div id="keyboard-trig" class="keyboard-panel">
    <button class="close-btn" onclick="closeKeyboard()">close</button>
    <div class="keyboard-panel-grid">
      <button onclick="insertSymbol('\\sin(\\placeholder{})')">
        <span class="latex-button">\( \sin \)</span>
      </button>
      <button onclick="insertSymbol('\\cos(\\placeholder{})')">
        <span class="latex-button">\( \cos \)</span>
      </button>
      <button onclick="insertSymbol('\\tan(\\placeholder{})')">
        <span class="latex-button">\( \tan \)</span>
      </button>
      <button onclick="insertSymbol('\\cot(\\placeholder{})')">
        <span class="latex-button">\( \cot \)</span>
      </button>
      <button onclick="insertSymbol('\\sec(\\placeholder{})')">
        <span class="latex-button">\( \sec \)</span>
      </button>
      <button onclick="insertSymbol('\\csc(\\placeholder{})')">
        <span class="latex-button">\( \csc \)</span>
      </button>

      <button onclick="insertSymbol('\\arcsin(\\placeholder{})')">
        <span class="latex-button">\( \arcsin \)</span>
      </button>
      <button onclick="insertSymbol('\\arccos(\\placeholder{})')">
        <span class="latex-button">\( \arccos \)</span>
      </button>
      <button onclick="insertSymbol('\\arctan(\\placeholder{})')">
        <span class="latex-button">\( \arctan\)</span>
      </button>
      <button onclick="insertSymbol('\\mathrm{arccot}(\\placeholder{})')">
        <span class="latex-button">\( \mathrm{arccot} \)</span>
      </button>
      <button onclick="insertSymbol('\\mathrm{arcsec}(\\placeholder{})')">
        <span class="latex-button">\( \mathrm{arcsec} \)</span>
      </button>
      <button onclick="insertSymbol('\\mathrm{arccsc}(\\placeholder{})')">
        <span class="latex-button">\( \mathrm{arccsc} \)</span>
      </button>

      <button onclick="insertSymbol('\\sinh(\\placeholder{})')">
        <span class="latex-button">\( \sinh \)</span>
      </button>
      <button onclick="insertSymbol('\\cosh(\\placeholder{})')">
        <span class="latex-button">\( \cosh \)</span>
      </button>
      <button onclick="insertSymbol('\\tanh(\\placeholder{})')">
        <span class="latex-button">\( \tanh \)</span>
      </button>
      <button onclick="insertSymbol('\\coth(\\placeholder{})')">
        <span class="latex-button">\( \coth \)</span>
      </button>
      <button onclick="insertSymbol('\\mathrm{sech}(\\placeholder{})')">
        <span class="latex-button">\( \mathrm{sech}\)</span>
      </button>
      <button onclick="insertSymbol('\\mathrm{csch}(\\placeholder{})')">
        <span class="latex-button">\( \mathrm{csch} \)</span>
      </button>

      <button onclick="insertSymbol('\\mathrm{arsinh}(\\placeholder{})')">
        <span class="latex-button">\( \mathrm{arsinh} \)</span>
      </button>
      <button onclick="insertSymbol('\\mathrm{arccosh}(\\placeholder{})')">
        <span class="latex-button">\( \mathrm{arccosh} \)</span>
      </button>
      <button onclick="insertSymbol('\\mathrm{arctanh}(\\placeholder{})')">
        <span class="latex-button">\( \mathrm{arctanh} \)</span>
      </button>
      <button onclick="insertSymbol('\\placeholder{}^\\circ')">
        <span class="latex-button">\( \boxed{}^\circ \)</span>
      </button>
      <button onclick="insertSymbol('\\theta')">
        <span class="latex-button">\( \theta \)</span>
      </button>
      <button onclick="insertSymbol('\\alpha')">
        <span class="latex-button">\( \alpha \)</span>
      </button>
      <button onclick="insertSymbol('\\beta')">
        <span class="latex-button">\( \beta \)</span>
      </button>
      <button onclick="insertSymbol('\\gamma')">
        <span class="latex-button">\( \gamma \)</span>
      </button>
      <button onclick="insertSymbol('\\pi')">
        <span class="latex-button">\( \pi \)</span>
      </button>
    </div>
  </div>

  <div id="keyboard-basic" class="keyboard-panel">
    <button class="close-btn" onclick="closeKeyboard()">close</button>
    <div class="keyboard-panel-grid">
      
      <button onclick="insertSymbol('=')">=</button>
      <button onclick="insertSymbol('<')">&lt;</button>
      <button onclick="insertSymbol('>')">&gt;</button>
      <button onclick="insertSymbol('\\leq')">‚â§</button>
      <button onclick="insertSymbol('\\geq')">‚â•</button>
      <button onclick="insertSymbol('\\neq')">‚â†</button>
      <button onclick="insertSymbol('\\approx')">‚âà</button>
      <button onclick="insertSymbol('\\cong')">
        <span class="latex-button">\( \cong \)</span>
      </button>
      <button onclick="insertSymbol('\\equiv')">
        <span class="latex-button">\( \equiv \)</span>
      </button> <button onclick="insertSymbol('|')">
        <span class="latex-button">\( | \)</span>
      </button> <button onclick="insertSymbol('\\nmid')">
        <span class="latex-button">\( \nmid \)</span>
      </button> <button onclick="insertSymbol('\\pm')">¬±</button>
      <button onclick="insertSymbol('\\cdot')">¬∑</button>
      <button onclick="insertSymbol('\\circ')">‚àò</button>
      <button onclick="insertSymbol('\\prime')">‚Ä≤</button>
      <button onclick="insertSymbol('\\%')">%</button>
      <button onclick="insertSymbol('\\infty')">‚àû</button>
      <button onclick="insertSymbol('!')">!</button>
      <button onclick="insertSymbol('\\placeholder{}^{\\placeholder{}}_{\\placeholder{}}')">
        <span class="latex-button">\( \boxed{}^{\boxed{}}_{\boxed{}} \)</span>
      </button>
      <button onclick="insertSymbol('\\left| \\placeholder{} \\right|')">
        <span class="latex-button">\( \left| \boxed{} \right| \)</span>
      </button>
      <button onclick="insertSymbol('\\log(\\placeholder{})')">
        <span class="latex-button">\( \log(\boxed{}) \)</span>
      </button>
      <button onclick="insertSymbol('\\log_{\\placeholder{}}(\\placeholder{})')">
        <span class="latex-button">\( \log_{\boxed{}}(\boxed{}) \)</span>
      </button>
      <button onclick="insertSymbol('\\ln(\\placeholder{})')">
        <span class="latex-button">\( \ln(\boxed{}) \)</span>
      </button>

      <button onclick="insertSymbol('\\sum \\placeholder{}')">
        <span class="latex-button">\( \sum \boxed{} \)</span>
      </button>
      <button onclick="insertSymbol('\\sum_{\\placeholder{}}^{\\placeholder{}} \\placeholder{}')">
        <span class="latex-button">\( \sum_{\boxed{}}^{\boxed{}} \boxed{} \)</span>
      </button>
      <button onclick="insertSymbol('\\prod \\placeholder{}')">
        <span class="latex-button">\( \prod \boxed{} \)</span>
      </button>
      <button onclick="insertSymbol('\\prod_{\\placeholder{}}^{\\placeholder{}} \\placeholder{}')">
        <span class="latex-button">\( \prod_{\boxed{}}^{\boxed{}} \boxed{} \)</span>
      </button>
      
      <button onclick="insertSymbol('\\pi')">œÄ</button>
      <button onclick="insertSymbol('e')">e</button>
      <button onclick="insertSymbol('i')">i</button>
    </div>
  </div>

  <div class="chat-input-card">
    <math-field 
      id="userInput" 
      class="mathlive-input" 
      math-virtual-keyboard-policy="off"
      virtual-keyboard-mode="auto"    
      math-mode="text"
      smart-fence="true"
      smart-mode="true"
      style="width: 100%; font-size: 1em;" 
      placeholder="\int\cos\left(x\right)e^{x}dx">
    </math-field>

    <!-- A√±ade esto en tu HTML -->
    <div id="context-menu" class="keyboard-panel" style="display: none; position: absolute; z-index: 1000;">
        <button class="context-menu-item" onclick="handleContextAction('copy')">Copiar</button>
        <button class="context-menu-item" onclick="handleContextAction('paste')">Pegar</button>
        <button class="context-menu-item" onclick="handleContextAction('selectAll')">Seleccionar todo</button>
    </div>
    
    <div class="chat-tools">
      <div class="keyboard-buttons">
        <button class="keyboard-category algebra-btn" onclick="showKeyboard('keyboard-algebra')">
          <span class="latex-button">\( \left| A \right| \)</span>
        </button>
        <button class="keyboard-category calculus-btn" onclick="showKeyboard('keyboard-calculus')">
          <span class="latex-button">\( \int_{a}^{b}\)</span>
        </button>
        <button class="keyboard-category logic-btn" onclick="showKeyboard('keyboard-logic')">
          <span class="latex-button">\( \forall\exists\)</span>
        </button>
        <button class="keyboard-category symbols-btn" onclick="showKeyboard('keyboard-symbols')">
          <span class="latex-button">\( P(A) \)</span>
        </button>
        <button class="keyboard-category trig-btn" onclick="showKeyboard('keyboard-trig')">
          <span class="latex-button">\( \sin(\theta) \)</span>
        </button>
        <button class="keyboard-category basic-btn" onclick="showKeyboard('keyboard-basic')">
          <span class="latex-button">\( \sum \)</span>
        </button>
      </div> 
      <button class="send-btn" onclick="sendMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>

    <button id="toggleCustomKeyboardBtn">Keyboard</button>

    <div id="customKeyboard" class="custom-keyboard hidden">
      <div class="keyboard-row" id="row-numbers">
          <button onclick="insertChar('1')">1</button>
          <button onclick="insertChar('2')">2</button>
          <button onclick="insertChar('3')">3</button>
          <button onclick="insertChar('4')">4</button>
          <button onclick="insertChar('5')">5</button>
          <button onclick="insertChar('6')">6</button>
          <button onclick="insertChar('7')">7</button>
          <button onclick="insertChar('8')">8</button>
          <button onclick="insertChar('9')">9</button>
          <button onclick="insertChar('0')">0</button>
      </div>

      <div class="keyboard-row" id="row-qwerty">
          <button onclick="insertChar('q')">q</button>
          <button onclick="insertChar('w')">w</button>
          <button onclick="insertChar('e')">e</button>
          <button onclick="insertChar('r')">r</button>
          <button onclick="insertChar('t')">t</button>
          <button onclick="insertChar('y')">y</button>
          <button onclick="insertChar('u')">u</button>
          <button onclick="insertChar('i')">i</button>
          <button onclick="insertChar('o')">o</button>
          <button onclick="insertChar('p')">p</button>
      </div>

      <div class="keyboard-row" id="row-asdfghjkl">
          <button onclick="insertChar('a')">a</button>
          <button onclick="insertChar('s')">s</button>
          <button onclick="insertChar('d')">d</button>
          <button onclick="insertChar('f')">f</button>
          <button onclick="insertChar('g')">g</button>
          <button onclick="insertChar('h')">h</button>
          <button onclick="insertChar('j')">j</button>
          <button onclick="insertChar('k')">k</button>
          <button onclick="insertChar('l')">l</button>
      </div>

      <div class="keyboard-row" id="row-zxcvbnm">
          <button id="shiftButton" onclick="toggleShift()" class="action-button">
              <i class="fas fa-arrow-up"></i>
          </button>
          <button onclick="insertChar('z')">z</button>
          <button onclick="insertChar('x')">x</button>
          <button onclick="insertChar('c')">c</button>
          <button onclick="insertChar('v')">v</button>
          <button onclick="insertChar('b')">b</button>
          <button onclick="insertChar('n')">n</button>
          <button onclick="insertChar('m')">m</button>
            <button onclick="insertChar('\\backspace')" class="action-button">
              <i class="fas fa-backspace"></i>
          </button>
      </div>

      <div class="keyboard-row" id="row-symbols-actions">
          <button id="toggleMathSymbolsBtn" onclick="toggleKeyboardMode('math')" class="action-button">
              <span>!#?</span>
          </button>

          <button onclick="insertChar(',')">.</button>

          <button id="toggleLanguageBtn" onclick="toggleKeyboardMode('language')" class="action-button">
              <i class="fas fa-globe"></i>
          </button>

          <button onclick="insertChar(' ')" class="space-button">‚ê£</button>
          
          <button onclick="insertChar('.')">.</button>
          <button id="toggleScientificBtn" onclick="toggleKeyboardMode('scientific')" class="action-button">
              <i class="fas fa-calculator"></i>
          </button>
          <button id="toggleGreekSymbolsBtn" onclick="toggleKeyboardMode('greek')" class="action-button">
              <span>&#x03B5; &#x03B4;</span>
          </button>
      </div>
    </div>

      </div>
    </div>
    </div>
  </div>
</div>

<script src="js/logic.js" defer></script> 
<script src="js/context.js" defer></script> 
<script src="js/customkeyboard.js" defer></script> 
<script src="js/header.js" defer></script>
<script src="js/botoneslatex.js" defer></script>
<script src="js/mathlive.js" defer></script> 
<script src="js/sendmessage.js" defer></script> 

<script>
  // Preloader
  document.addEventListener('DOMContentLoaded', function() {
    // Espera a que todo est√© listo
    function hidePreloader() {
      const preloader = document.getElementById('preloader');
      preloader.classList.add('hidden');
      document.body.classList.remove('preloader-active');
      
      // Eliminar el preloader del DOM despu√©s de la animaci√≥n
      setTimeout(() => {
        preloader.remove();
      }, 500);
    }

    // Espera a que MathJax est√© listo si es necesario
    if (typeof MathJax !== 'undefined' && MathJax.startup) {
      MathJax.startup.promise.then(hidePreloader).catch(hidePreloader);
    } else {
      // Fallback por si MathJax falla o no est√° definido
      setTimeout(hidePreloader, 1500);
    }
  });
</script>
<script type="text/javascript">
// logic.js 
// ================= CONFIGURACI√ìN Y VARIABLES GLOBALES =================
const MAX_CACHE_SIZE = 20;
const MEMORY_THRESHOLD = 500;

// Variables de estado global
let isStreaming = false;
let currentStreamController = null;
let responseCache = new Map();
let currentModel = "deepseek-chat";
let reasonerUsesLeft = 0;
let isMathTutorMode = false;
let mathField;
let isShiftActive = false;
let currentKeyboardLayout = 'default';
let currentLanguage = 'en';
let memoryMonitorInterval;
const plotlyInstances = [];

// ---------------- Resource registry (para registrar y limpiar listeners/timers/observers) ----------------
window.__resourceRegistry = window.__resourceRegistry || {
  listeners: [],    // { target, type, handler, options }
  intervals: [],    // ids
  timeouts: [],     // ids
  observers: [],    // MutationObserver / ResizeObserver
  workers: [],      // WebWorkers
  objectUrls: []    // URL.createObjectURL(...) si usas
};

function registerListener(target, type, handler, options) {
  if (!target || !type || !handler) return;
  try {
    target.addEventListener(type, handler, options);
    window.__resourceRegistry.listeners.push({ target, type, handler, options });
  } catch (e) {
    console.warn("registerListener failed", e);
  }
}

function registerInterval(id) {
  if (typeof id !== 'undefined' && id !== null) window.__resourceRegistry.intervals.push(id);
}
function registerTimeout(id) {
  if (typeof id !== 'undefined' && id !== null) window.__resourceRegistry.timeouts.push(id);
}
function registerObserver(obs) {
  if (obs) window.__resourceRegistry.observers.push(obs);
}
function registerWorker(w) {
  if (w) window.__resourceRegistry.workers.push(w);
}
function registerObjectUrl(url) {
  if (url) window.__resourceRegistry.objectUrls.push(url);
}

function cleanupAllResources() {
  const reg = window.__resourceRegistry;
  // listeners
  reg.listeners.forEach(l => {
    try { l.target.removeEventListener(l.type, l.handler, l.options); } catch(e){}
  });
  reg.listeners.length = 0;

  // intervals/timeouts
  reg.intervals.forEach(id => { try{ clearInterval(id); }catch(e){} });
  reg.intervals.length = 0;
  reg.timeouts.forEach(id => { try{ clearTimeout(id); }catch(e){} });
  reg.timeouts.length = 0;

  // observers
  reg.observers.forEach(o => { try{ o.disconnect(); }catch(e){} });
  reg.observers.length = 0;

  // workers
  reg.workers.forEach(w => { try{ w.terminate(); }catch(e){} });
  reg.workers.length = 0;

  // urls
  reg.objectUrls.forEach(u => { try{ URL.revokeObjectURL(u); }catch(e){} });
  reg.objectUrls.length = 0;

  // parar monitor de memoria si est√° corriendo
  try { if (typeof stopMemoryMonitoring === 'function') stopMemoryMonitoring(); } catch(e){}

  console.log("cleanupAllResources ‚Üí removed listeners/intervals/observers/workers/objectURLs");
}

// ================= FUNCIONES DE INICIALIZACI√ìN =================
(function installMathClickHandler(){
    if (window.__mathClickableHandlerInstalled) return;
    window.__mathClickableHandlerInstalled = true;

    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.copy-equation-btn');
        if (btn) {
            const block = btn.closest('.clickable-math-block');
            if (!block) return;
            const encoded = block.getAttribute('data-latex') || block.dataset.latex;
            if (!encoded) return;
            const latex = decodeURIComponent(encoded);
            if (typeof sendLatexToInput === 'function') {
                sendLatexToInput(latex);
            }
            return;
        }

        const blk = e.target.closest('.clickable-math-block');
        if (blk && !e.target.closest('.copy-equation-btn')) {
            const encoded = blk.getAttribute('data-latex') || blk.dataset.latex;
            if (!encoded) return;
            const latex = decodeURIComponent(encoded);
            if (typeof sendLatexToInput === 'function') {
                sendLatexToInput(latex);
            }
        }
    }, false);
}());

document.addEventListener('DOMContentLoaded', function() {
    startMemoryMonitoring();
});

// ================= FUNCIONES DE GESTI√ìN DE MEMORIA =================
function startMemoryMonitoring() {
    if (memoryMonitorInterval) clearInterval(memoryMonitorInterval);
    
    memoryMonitorInterval = setInterval(() => {
        if (performance && performance.memory) {
            const usedMB = (performance.memory.usedJSHeapSize / 1048576).toFixed(2);
            const totalMB = (performance.memory.jsHeapSizeLimit / 1048576).toFixed(2);
            
            console.log(`Memoria usada: ${usedMB} MB de ${totalMB} MB disponibles`);
            
            if (parseFloat(usedMB) > MEMORY_THRESHOLD) {
                console.warn("Uso de memoria cr√≠tico, limpiando cache...");
                responseCache.clear();
                tryGarbageCollection();
            }
        }
    }, 30000);
}

function stopMemoryMonitoring() {
    if (memoryMonitorInterval) {
        clearInterval(memoryMonitorInterval);
        memoryMonitorInterval = null;
    }
}

function tryGarbageCollection() {
    if (window.gc) {
        window.gc();
        console.log("Garbage collection forzado");
    } else {
        try {
            if (window.PerformanceObserver && performance.memory) {
                const usedMB = (performance.memory.usedJSHeapSize / 1048576).toFixed(2);
                console.log("Memoria usada antes de limpieza: " + usedMB + " MB");
            }
            
            let obj = {};
            for (let i = 0; i < 100000; i++) {
                obj[i] = new Array(100).fill(0);
            }
            obj = null;
        } catch(e) {
            console.warn("No se pudo forzar garbage collection");
        }
    }
}

// ================= FUNCIONES DE LIMPIEZA =================
function clearChat() {
    // Abort streaming si hay alguno
    if (isStreaming && currentStreamController) {
        currentStreamController.abort();
        isStreaming = false;
        currentStreamController = null;
    }

    // 1) Limpieza de listeners/intervals/observers/worker/objectURLs registrados
    if (typeof cleanupAllResources === 'function') {
        cleanupAllResources();
    }

    // 2) cleanup de charts
    cleanupPlotlyCharts();

    // 3) limpiar DOM del chat
    const chatBox = document.getElementById('chatBox');
    if (chatBox) {
        chatBox.innerHTML = '';
    }
    
    if (responseCache.size > MAX_CACHE_SIZE) {
        const keys = Array.from(responseCache.keys());
        for (let i = 0; i < keys.length - MAX_CACHE_SIZE; i++) {
            responseCache.delete(keys[i]);
        }
        console.log(`Cache reducido a ${responseCache.size} elementos`);
    }
    
    resetContext();
    tryGarbageCollection();
    showWelcomeMessage();
    
    console.log("Chat limpiado completamente y recursos liberados");
}

function cleanupPlotlyCharts() {
    plotlyInstances.forEach(instance => {
        const container = document.getElementById(instance.id);
        if (container && typeof Plotly !== 'undefined') {
            Plotly.purge(container);
        }
    });
    plotlyInstances.length = 0;
}


function registerPlotlyInstance(id) {
    const plotlyInstance = { id: id };
    if (!plotlyInstances.some(instance => instance.id === id)) {
        plotlyInstances.push(plotlyInstance);
    }
}

// ================= FUNCIONES DE COPIA Y PORTAPAPELES =================
function addLatexCopyButtons(container) {
    container.querySelectorAll('.MJXc-display').forEach(el => {
        const wrapper = document.createElement('div');
        wrapper.className = 'latex-copy';
        wrapper.innerHTML = el.outerHTML;
        wrapper.innerHTML += `<button class="copy-latex-btn" onclick="copyLatex(this.parentNode)"><i class="fas fa-copy"></i></button>`;
        el.replaceWith(wrapper);
    });

    container.querySelectorAll('.MJXc-math').forEach(el => {
        const wrapper = document.createElement('span');
        wrapper.className = 'latex-copy';
        wrapper.innerHTML = el.outerHTML;
        wrapper.innerHTML += `<button class="copy-latex-btn" onclick="copyLatex(this.parentNode)"><i class="fas fa-copy"></i></button>`;
        el.replaceWith(wrapper);
    });
}

function copyLatex(latexContainer) {
    const latex = latexContainer.querySelector('.MathJax').textContent;
    copyToClipboard(latex, latexContainer.querySelector('.copy-latex-btn'));
}

function copyMessage(messageBubble) {
    const content = messageBubble.textContent.replace('Copiado!', '').trim();
    const successMsg = messageBubble.querySelector('.copy-success');
    copyToClipboard(content, messageBubble.querySelector('.copy-message-btn'), successMsg);
}

function copyToClipboard(text, buttonElement, successElement = null) {
    navigator.clipboard.writeText(text).then(() => {
        if (successElement) {
            successElement.style.display = 'block';
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 2000);
        }
        if (buttonElement) {
            buttonElement.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
                buttonElement.innerHTML = '<i class="fas fa-copy"></i>';
            }, 1000);
        }
    }).catch(err => {
        console.error('Error al copiar:', err);
    });
}

function copyToClipboardcode(text, buttonElement) {
    if (!navigator.clipboard) {
        console.error("Clipboard API no soportada");
        showCopyError(buttonElement);
        return;
    }

    navigator.clipboard.writeText(text)
        .then(() => showCopySuccess(buttonElement))
        .catch(err => {
            console.error("Error copiando al portapapeles:", err);
            showCopyError(buttonElement);
        });
}

function showCopySuccess(buttonElement) {
    if (!buttonElement) return;
    const originalContent = buttonElement.innerHTML;
    buttonElement.innerHTML = "<i class='fas fa-check'></i> Copy!";
    buttonElement.classList.add('copy-success');
    setTimeout(() => {
        buttonElement.innerHTML = originalContent;
        buttonElement.classList.remove('copy-success');
    }, 1500);
}

function showCopyError(buttonElement) {
    if (!buttonElement) return;
    const originalContent = buttonElement.innerHTML;
    buttonElement.innerHTML = "<i class='fas fa-times'></i> Error";
    buttonElement.classList.add('copy-error');
    setTimeout(() => {
        buttonElement.innerHTML = originalContent;
        buttonElement.classList.remove('copy-error');
    }, 1500);
}

// ================= FUNCIONES DE PROCESAMIENTO DE CONTENIDO =================
function addFinalElements(bubble) {
    addLatexCopyButtons(bubble);

    const copyBtn = document.createElement("button");
    copyBtn.className = "copy-message-btn";
    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
    copyBtn.onclick = () => copyMessage(bubble);
    bubble.appendChild(copyBtn);

    const successMsg = document.createElement("div");
    successMsg.className = "copy-success";
    successMsg.textContent = "Copiado!";
    bubble.appendChild(successMsg);

    requestIdleCallback(() => {
        if (window.MathJax) {
            MathJax.typesetPromise([bubble]).catch(err => {
                console.error("Error de MathJax:", err);
            });
        }
    });
}

function scheduleMathJaxProcessing(element) {
    if (mathJaxTimeout) {
        clearTimeout(mathJaxTimeout);
    }

    mathJaxTimeout = setTimeout(() => {
        if (window.MathJax) {
            MathJax.typesetPromise([element]).catch(err => {
                console.error("Error de MathJax:", err);
            });
        }
        mathJaxTimeout = null;
    }, 1000);
}

function processChunk(chunk) {
    return chunk.replace(/\n/g, '<br>')
                .replace(/<step>/g, '<div class="step">')
                .replace(/<\/step>/g, '<a class="explain-link" onclick="explainStep(this)">[Explicaci√≥n]</a></div>')
                .replace(/<definition>/g, '<div class="definition">')
                .replace(/<\/definition>/g, '</div>');
}

function explainStep(linkElement) {
    const stepContainer = linkElement.parentElement;
    let stepHtml = stepContainer.innerHTML.replace('""Ask to Chat', '').trim();

    const mathBlocks = [];
    stepHtml = stepHtml.replace(/<span class="math-text"[^>]*>(.*?)<\/span>/g, (_, latex) => {
        const placeholder = `~~~MATH_${mathBlocks.length}~~~`;
        mathBlocks.push(`\\(${decodeURIComponent(latex)}\\)`);
        return placeholder;
    });
    stepHtml = stepHtml.replace(/<div class="math-block"[^>]*>(.*?)<\/div>/g, (_, latex) => {
        const placeholder = `~~~MATH_${mathBlocks.length}~~~`;
        mathBlocks.push(`\\[${decodeURIComponent(latex)}\\]`);
        return placeholder;
    });

    stepHtml = stepHtml.replace(/<[^>]+>/g, '');

    const parts = stepHtml.split(/(~~~MATH_\d+~~~)/g);

    const finalBlocks = parts.map(part => {
        const match = part.match(/~~~MATH_(\d+)~~~/);
        if (match) {
            return mathBlocks[parseInt(match[1], 10)];
        } else if (part.trim()) {
            const escaped = part.replace(/([\\{}])/g, '\\$1');
            return `\\text{${escaped}}`;
        } else {
            return '';
        }
    });

    const finalMessage = finalBlocks.join(' ');
    mathField.setValue(finalMessage);
    mathField.focus();
}

function applySyntaxHighlighting() {
    document.querySelectorAll('.code-block pre code').forEach((block) => {
        const lang = block.parentElement.parentElement.getAttribute('data-lang') || 
                    Array.from(block.classList).find(cls => cls.startsWith('language-'));
        
        if (lang) {
            block.className = `language-${lang}`;
        }
        hljs.highlightElement(block);
    });
}

function renderMathAndCode(bubble) {
    const mathElements = bubble.querySelectorAll('.latex-button, :not(.code-block)');

    const mathPromise = window.MathJax ? 
        MathJax.typesetPromise(mathElements) : 
        Promise.resolve();

    mathPromise
        .then(() => {
            if (window.hljs) {
                hljs.highlightAll();
            }
        })
        .catch(err => console.error("Error al renderizar:", err));
}

document.addEventListener("keydown", function(event) {
    if (event.key === "Escape") {
        closeKeyboard();
    }

    if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
});

document.getElementById("chatBox").addEventListener("click", function(e) {
    const button = e.target.closest(".copy-btn");
    if (!button) return;

    const codeBlock = button.closest(".code-block");
    if (!codeBlock) return console.error("No se encontr√≥ el contenedor del c√≥digo");

    const codeElement = codeBlock.querySelector("pre code");
    if (!codeElement) return console.error("No se encontr√≥ el elemento del c√≥digo");

    copyToClipboardcode(codeElement.innerText, button);
});


// ================= GESTI√ìN DE CONTEXTO =================
let conversationContext = {
    currentTopic: null,
    messages: [],
    lastUserMessage: null,
    lastBotMessage: null
};
const MAX_CONTEXT_LENGTH = 6; // M√°ximo de mensajes a recordar
const TOPIC_SIMILARITY_THRESHOLD = 0.7; // Umbral para considerar cambio de tema

// Funci√≥n para calcular similitud entre mensajes
function calculateSimilarity(str1, str2) {
    const set1 = new Set(str1.toLowerCase().split(/\s+/));
    const set2 = new Set(str2.toLowerCase().split(/\s+/));
    const intersection = new Set([...set1].filter(x => set2.has(x)));
    const union = new Set([...set1, ...set2]);
    return intersection.size / union.size;
}

// Funci√≥n para resumir el contexto de manera inteligente
function summarizeContext() {
    if (conversationContext.messages.length === 0) {
        return conversationContext.currentTopic || "";
    }

    // Extraer los temas principales del contexto
    const topics = conversationContext.messages.map(msg => {
        // Eliminar detalles espec√≠ficos para generalizar
        return msg.user
            .replace(/(\d+|espec√≠fico|particular|ejemplo|problema)/gi, '')
            .replace(/(\d+\.?\d*)/g, 'n') // Generalizar n√∫meros
            .trim();
    });

    // Encontrar temas comunes
    const commonTopics = topics.filter((topic, i) => 
        topics.some((t, j) => i !== j && calculateSimilarity(topic, t) > 0.6))
        .filter((v, i, a) => a.indexOf(v) === i);

    // Si hay temas comunes, usarlos como resumen
    if (commonTopics.length > 0) {
        return commonTopics.join(", ") + " (y conceptos relacionados)";
    }

    // Si no, devolver el tema actual con los √∫ltimos 2-3 mensajes resumidos
    const lastMessages = conversationContext.messages.slice(-3).map(msg => 
        msg.user.split(/[:?]/)[0] || msg.user.substring(0, 50) + '...'
    ).join(", ");

    return `${conversationContext.currentTopic || "La conversaci√≥n actual"} - ${lastMessages}`;
}

// Funci√≥n para actualizar el contexto
function updateContext(userMessage, botMessage) {
    // Verificar si hay cambio de tema
    if (conversationContext.currentTopic && 
        calculateSimilarity(userMessage, conversationContext.currentTopic) < TOPIC_SIMILARITY_THRESHOLD) {
        // Cambio de tema detectado - resetear contexto
        conversationContext = {
            currentTopic: userMessage,
            messages: [],
            lastUserMessage: null,
            lastBotMessage: null
        };
    } else if (!conversationContext.currentTopic) {
        // Primer mensaje del tema
        conversationContext.currentTopic = userMessage;
    }

    // Actualizar historial de mensajes
    conversationContext.messages.push({
        user: userMessage,
        bot: botMessage
    });

    // Mantener solo los √∫ltimos mensajes
    if (conversationContext.messages.length > MAX_CONTEXT_LENGTH) {
        conversationContext.messages.shift();
    }

    // Actualizar √∫ltimos mensajes
    conversationContext.lastUserMessage = userMessage;
    conversationContext.lastBotMessage = botMessage;
}

// Funci√≥n para generar contexto formateado para la API
function getContextPrompt() {
    if (conversationContext.messages.length === 0) return '';

    let contextPrompt = '\n\n### Contexto de la conversaci√≥n:\n';
    conversationContext.messages.forEach((msg, _index) => {
        contextPrompt += `- T√∫: ${msg.user}\n`;
        if (msg.bot) {
            contextPrompt += `- Asistente: ${msg.bot}\n`;
        }
    });
    return contextPrompt;
}

// Funci√≥n para resetear el contexto manualmente
function resetContext(newTopic = null) {
    conversationContext = {
        currentTopic: newTopic,
        messages: [],
        lastUserMessage: null,
        lastBotMessage: null
    };
}
// Mapeo de teclas para diferentes modos
const KEYBOARD_LAYOUTS = {
'scientific': {
    'row-numbers': [
        { display: '<i class="fas fa-arrow-left"></i>', insert: '\\leftarrow', isAction: true },
        { display: 'x', insert: 'x', isLatexSymbol: true },
        { display: 'y', insert: 'y', isLatexSymbol: true },
        { display: 'z', insert: 'z', isLatexSymbol: true },
        { display: '(', insert: '(', isLatexOp: true },
        { display: ')', insert: ')', isLatexOp: true },
        { display: '\\( |\\boxed{}| \\)', insert: '\\left|\\placeholder{}\\right|', isLatexOp: true },
        { display: '<i class="fas fa-backspace"></i>', insert: '\\backspace', isAction: true },
        { display: '<i class="fas fa-arrow-right"></i>', insert: '\\rightarrow', isAction: true }
    ],
    'row-qwerty': [
        { display: '\\( \\boxed{}_{\\boxed{}} \\)', insert: '_{\\placeholder{}}', isLatexOp: true },
        { display: '\\( \\frac{\\boxed{}}{\\boxed{}} \\)', insert: '\\frac{\\placeholder{}}{\\placeholder{}}', isLatexOp: true },
        { display: '\\( \\boxed{}^{\\boxed{}} \\)', insert: '^{\\placeholder{}}', isLatexOp: true },
        { display: '7', insert: '7' },
        { display: '8', insert: '8' },
        { display: '9', insert: '9' },
        { display: '\\( \\sqrt{\\boxed{}} \\)', insert: '\\sqrt{\\placeholder{}}', isLatexOp: true },
        { display: '\\( \\sqrt[\\boxed{}]{\\boxed{}} \\)', insert: '\\sqrt[\\placeholder{}]{\\placeholder{}}', isLatexOp: true },
        { display: '\\( e^{\\boxed{}} \\)', insert: 'e^{\\placeholder{}}', isLatexOp: true }
    ],
    'row-asdfghjkl': [
        { display: 'ln', insert: '\\ln(\\placeholder{})', isLatexOp: true },
        { display: 'log', insert: '\\log_{\\placeholder{}}(\\placeholder{})', isLatexOp: true },
        { display: '\\( \\sum \\)', insert: '\\sum_{n=\\placeholder{}}^{\\placeholder{}}\\placeholder{}', isLatexOp: true },
        { display: '4', insert: '4' },
        { display: '5', insert: '5' },
        { display: '6', insert: '6' },
        { display: '\\( \\prod \\)', insert: '\\prod_{n=\\placeholder{}}^{\\placeholder{}}\\placeholder{}', isLatexOp: true },
        { display: '\\( \\int \\)', insert: '\\int_{\\placeholder{}}^{\\placeholder{}}\\placeholder{}d\\placeholder{}', isLatexOp: true },
        { display: 'œÄ', insert: '\\pi', isLatexSymbol: true }
    ],
    'row-zxcvbnm': [
        { display: '\\( \\frac{d}{d\\boxed{}} \\)', insert: '\\frac{d}{d\\placeholder{}}', isLatexOp: true },
        { display: '\\( \\frac{\\partial}{\\partial \\boxed{}} \\)', insert: '\\frac{\\partial}{\\partial \\placeholder{}}', isLatexOp: true },
        { display: 'lim', insert: '\\lim_{\\placeholder{}\\to\\placeholder{}}', isLatexOp: true },
        { display: '1', insert: '1' },
        { display: '2', insert: '2' },
        { display: '3', insert: '3' },
        { display: '+', insert: '+' },
        { display: '√ó', insert: '\\times', isLatexOp: true },
        { display: '-', insert: '-' }
    ],
    'row-symbols-actions': [
        { display: 'sin', insert: '\\sin', isLatexOp: true },
        { display: 'cos', insert: '\\cos', isLatexOp: true },
        { display: 'tan', insert: '\\tan', isLatexOp: true },
        { display: '.', insert: '.' },
        { display: '0', insert: '0' },
        { display: '=', insert: '=', isAction: true, id: 'calculateButton' },
        { display: ',', insert: ',' },
        { display: '\\( \\epsilon \\delta \\)', insert: 'greekMode', isAction: true, id: 'toggleGreekSymbolsBtn' },
        { display: '<span>abc</span>', insert: 'defaultMode', isAction: true, id: 'toggleScientificBtn', class: 'active-mode' }
    ]
},
    'default': {
        'row-numbers': [
            { display: '<i class="fas fa-arrow-left"></i>', insert: '\\leftarrow', isAction: true },
            { display: '1', insert: '1' }, { display: '2', insert: '2' }, { display: '3', insert: '3' },
            { display: '4', insert: '4' }, { display: '5', 'insert': '5' }, { display: '6', insert: '6' },
            { display: '7', insert: '7' }, { display: '8', insert: '8' }, { display: '9', insert: '9' },
            { display: '0', insert: '0' },
            { display: '<i class="fas fa-arrow-right"></i>', insert: '\\rightarrow', isAction: true }
        ],
        'row-qwerty': [
            { display: 'q', insert: 'q' }, { display: 'w', insert: 'w' }, { display: 'e', insert: 'e' },
            { display: 'r', insert: 'r' }, { display: 't', insert: 't' }, { display: 'y', insert: 'y' },
            { display: 'u', insert: 'u' }, { display: 'i', insert: 'i' }, { display: 'o', insert: 'o' },
            { display: 'p', insert: 'p' }
        ],
        'row-asdfghjkl': [
            { display: 'a', insert: 'a' }, { display: 's', insert: 's' }, { display: 'd', insert: 'd' },
            { display: 'f', insert: 'f' }, { display: 'g', insert: 'g' }, { display: 'h', insert: 'h' },
            { display: 'j', insert: 'j' }, { display: 'k', insert: 'k' }, { display: 'l', insert: 'l' }
        ],
        'row-zxcvbnm': [
            { display: '<i class="fas fa-arrow-up"></i>', insert: 'shift', isAction: true, id: 'shiftButton' },
            { display: 'z', insert: 'z' }, { display: 'x', insert: 'x' }, { display: 'c', insert: 'c' },
            { display: 'v', insert: 'v' }, { display: 'b', insert: 'b' }, { display: 'n', insert: 'n' },
            { display: 'm', insert: 'm' },
            { display: '<i class="fas fa-backspace"></i>', insert: '\\backspace', isAction: true }
        ],
        'row-symbols-actions': [
            { display: '<span>!#?</span>', insert: 'mathMode', isAction: true, id: 'toggleMathSymbolsBtn' },
            { display: ',', insert: ',' },
            { display: '<i class="fas fa-globe"></i>', insert: 'languageMode', isAction: true, id: 'toggleLanguageBtn' },
            { display: '‚ê£', insert: ' ', isAction: true, class: 'space-button' },
            // üëá A√±ade este bot√≥n a todos los layouts
            { display: '.', insert: '.' },
            { display: '<i class="fas fa-calculator"></i>', insert: 'scientificMode', isAction: true, id: 'toggleScientificBtn' },
            { display: '\\( \\epsilon \\delta \\)', insert: 'greekMode', isAction: true, id: 'toggleGreekSymbolsBtn' }
        ]
    },
    'math': {
        'row-qwerty': [
            { display: '@', insert: '@' }, { display: '#', insert: '#' }, { display: '$', insert: '$' },
            { display: '_', insert: '_' }, { display: '&', insert: '&' }, { display: '[', insert: '[' },
            { display: ']', insert: ']' }, { display: '(', insert: '(' },{ display: ')', insert: ')' }, { display: '\\', insert: '\\' },{ display: '/', insert: '/' }
        ],
        'row-asdfghjkl': [
            { display: '*', insert: '*' }, { display: '"', insert: '"' }, { display: "'", insert: "'" },
            { display: ':', insert: ':' }, { display: ';', insert: ';' }, { display: '!', insert: '!' },
            { display: '¬°', insert: '¬°' }, { display: '¬ø', insert: '¬ø' }, { display: '?', insert: '?' }
        ],
        'row-zxcvbnm': [
            { display: '<i class="fas fa-arrow-up"></i>', insert: 'shift', isAction: true, id: 'shiftButton' },
            { display: '‚Üê', insert: '‚Üê', isAction: true },
            { display: '‚Üí', insert: '‚Üí', isAction: true },
            { display: '+', insert: '+' },
            { display: '-', insert: '-' },
            { display: '\\( \\times \\)', insert: '\\( \\times \\)' },
            { display: '=', insert: '=' },
            { display: '<', insert: '<' },
            { display: '>', insert: '>' },
            { display: '<i class="fas fa-backspace"></i>', insert: '\\backspace', isAction: true }
        ],
        'row-symbols-actions': [
            // üëá A√±ade este bot√≥n
            { display: '<span>abc</span>', insert: 'defaultMode', isAction: true, id: 'toggleMathSymbolsBtn', class: 'active-mode' },
            { display: ',', insert: ',' },
            { display: '<i class="fas fa-globe"></i>', insert: 'languageMode', isAction: true, id: 'toggleLanguageBtn' },
            { display: '‚ê£', insert: ' ', isAction: true, class: 'space-button' },
            { display: '.', insert: '.' },
            { display: '<i class="fas fa-calculator"></i>', insert: 'scientificMode', isAction: true, id: 'toggleScientificBtn' },
            { display: '\\( \\epsilon \\delta \\)', insert: 'greekMode', isAction: true, id: 'toggleGreekSymbolsBtn' }
        ]
    },
    'language': {
        'row-numbers': [
            { display: '<i class="fas fa-arrow-left"></i>', insert: '\\leftarrow', isAction: true },
            { display: '<i class="fas fa-arrow-right"></i>', insert: '\\rightarrow', isAction: true },
            { display: '1', insert: '1' }, { display: '2', insert: '2' }, { display: '3', insert: '3' },
            { display: '4', insert: '4' }, { display: '5', insert: '5' }, { display: '6', insert: '6' },
            { display: '7', insert: '7' }, { display: '8', insert: '8' }, { display: '9', insert: '9' },
            { display: '0', insert: '0' }
        ],
        'row-qwerty': [
            { display: 'q', insert: 'q' }, { display: 'w', insert: 'w' }, { display: 'e', insert: 'e' },
            { display: 'r', insert: 'r' }, { display: 't', insert: 't' }, { display: 'y', insert: 'y' },
            { display: 'u', insert: 'u' }, { display: 'i', insert: 'i' }, { display: 'o', insert: 'o' },
            { display: 'p', insert: 'p' }
        ],
        'row-asdfghjkl': [
            { display: 'a', insert: 'a' }, { display: 's', insert: 's' }, { display: 'd', insert: 'd' },
            { display: 'f', insert: 'f' }, { display: 'g', insert: 'g' }, { display: 'h', insert: 'h' },
            { display: 'j', insert: 'j' }, { display: 'k', insert: 'k' }, { display: 'l', insert: 'l' },
            { display: '√±', insert: '√±' }
        ],
        'row-zxcvbnm': [
            { display: '<i class="fas fa-arrow-up"></i>', insert: 'shift', isAction: true, id: 'shiftButton' },
            { display: 'z', insert: 'z' }, { display: 'x', insert: 'x' }, { display: 'c', insert: 'c' },
            { display: 'v', insert: 'v' }, { display: 'b', insert: 'b' }, { display: 'n', insert: 'n' },
            { display: 'm', insert: 'm' },
            { display: '<i class="fas fa-backspace"></i>', insert: '\\backspace', isAction: true }
        ],
        'row-symbols-actions': [
            { display: '<span>!#?</span>', insert: 'mathMode', isAction: true, id: 'toggleMathSymbolsBtn' },
            { display: ',', insert: ',' },
            { display: '<i class="fas fa-globe"></i>', insert: 'defaultMode', isAction: true, id: 'toggleLanguageBtn', class: 'active-mode' },
            { display: '‚ê£', insert: ' ', isAction: true, class: 'space-button' },
            // üëá A√±ade este bot√≥n
            { display: '.', insert: '.' },
            { display: '<i class="fas fa-calculator"></i>', insert: 'scientificMode', isAction: true, id: 'toggleScientificBtn' },
            { display: '\\( \\epsilon \\delta \\)', insert: 'greekMode', isAction: true, id: 'toggleGreekSymbolsBtn' }
        ]
    },
    'greek': {
        'row-numbers': [
            { display: '<i class="fas fa-arrow-left"></i>', insert: '\\leftarrow', isAction: true },
            { display: '<i class="fas fa-arrow-right"></i>', insert: '\\rightarrow', isAction: true },
            { display: '1', insert: '1' }, { display: '2', insert: '2' }, { display: '3', insert: '3' },
            { display: '4', insert: '4' }, { display: '5', insert: '5' }, { display: '6', insert: '6' },
            { display: '7', insert: '7' }, { display: '8', insert: '8' }, { display: '9', insert: '9' },
            { display: '0', insert: '0' }
        ],
        'row-qwerty': [
            { display: 'Œ±', insert: '\\alpha', shifted: '\\Alpha', isLatexSymbol: true },
            { display: 'Œ≤', insert: '\\beta', shifted: '\\Beta', isLatexSymbol: true },
            { display: 'Œ≥', insert: '\\gamma', shifted: '\\Gamma', isLatexSymbol: true },
            { display: 'Œ¥', insert: '\\delta', shifted: '\\Delta', isLatexSymbol: true },
            { display: 'Œµ', insert: '\\epsilon', shifted: '\\Epsilon', isLatexSymbol: true },
            { display: 'Œ∂', insert: '\\zeta', shifted: '\\Zeta', isLatexSymbol: true },
            { display: 'Œ∑', insert: '\\eta', shifted: '\\Eta', isLatexSymbol: true },
            { display: 'Œ∏', insert: '\\theta', shifted: '\\Theta', isLatexSymbol: true },
            { display: 'Œπ', insert: '\\iota', shifted: '\\Iota', isLatexSymbol: true },
            { display: 'Œ∫', insert: '\\kappa', shifted: '\\Kappa', isLatexSymbol: true }
        ],
        'row-asdfghjkl': [
            { display: 'Œª', insert: '\\lambda', shifted: '\\Lambda', isLatexSymbol: true },
            { display: 'Œº', insert: '\\mu', shifted: '\\Mu', isLatexSymbol: true },
            { display: 'ŒΩ', insert: '\\nu', shifted: '\\Nu', isLatexSymbol: true },
            { display: 'Œæ', insert: '\\xi', shifted: '\\Xi', isLatexSymbol: true },
            { display: 'Œø', insert: 'o', shifted: 'O', isLatexSymbol: false },
            { display: 'œÄ', insert: '\\pi', shifted: '\\Pi', isLatexSymbol: true },
            { display: 'œÅ', insert: '\\rho', shifted: '\\Rho', isLatexSymbol: true },
            { display: 'œÉ', insert: '\\sigma', shifted: '\\Sigma', isLatexSymbol: true },
            { display: 'œÑ', insert: '\\tau', shifted: '\\Tau', isLatexSymbol: true },
            { display: 'œÇ', insert: '\\varsigma', isLatexSymbol: true }
        ],
        'row-zxcvbnm': [
            { display: '<i class="fas fa-arrow-up"></i>', insert: 'shift', isAction: true, id: 'shiftButton' },
            { display: 'œÖ', insert: '\\upsilon', shifted: '\\Upsilon', isLatexSymbol: true },
            { display: 'œÜ', insert: '\\phi', shifted: '\\Phi', isLatexSymbol: true },
            { display: 'œá', insert: '\\chi', shifted: '\\Chi', isLatexSymbol: true },
            { display: 'œà', insert: '\\psi', shifted: '\\Psi', isLatexSymbol: true },
            { display: 'œâ', insert: '\\omega', shifted: '\\Omega', isLatexSymbol: true },
            { display: '‚àá', insert: '\\nabla', isLatexSymbol: true },
            { display: '‚à´', insert: '\\int', isLatexOp: true },
            { display: 'Œ£', insert: '\\Sigma', isLatexOp: true },
            { display: '<i class="fas fa-backspace"></i>', insert: '\\backspace', isAction: true }
        ],
        'row-symbols-actions': [
            { display: '<span>!#?</span>', insert: 'mathMode', isAction: true, id: 'toggleMathSymbolsBtn' },
            { display: ',', insert: ',' },
            { display: '<i class="fas fa-globe"></i>', insert: 'languageMode', isAction: true, id: 'toggleLanguageBtn' },
            { display: '‚ê£', insert: ' ', isAction: true, class: 'space-button' },
            // üëá A√±ade este bot√≥n
            { display: '<i class="fas fa-calculator"></i>', insert: 'scientificMode', isAction: true, id: 'toggleScientificBtn' },
            { display: '.', insert: '.' },
            { display: '<span>abc</span>', insert: 'defaultMode', isAction: true, id: 'toggleGreekSymbolsBtn', class: 'active-mode' }
        ]
    }
};

// ================= VARIABLES PARA LA REPETICI√ìN DE TECLAS (A√±adidas) =================
let repeatTimer; // Almacena el temporizador para la repetici√≥n
let repeatInterval = 100; // Intervalo de repetici√≥n en milisegundos (ajustable)
let initialDelay = 500; // Retraso inicial antes de que comience la repetici√≥n (ajustable)
let isRepeating = false; // Bandera para saber si una tecla se est√° repitiendo
let incrementador = 50 

function renderKeyboard(layoutName) {
    currentKeyboardLayout = layoutName;
    const layout = KEYBOARD_LAYOUTS[layoutName];

    for (const rowId in layout) {
        const rowElement = document.getElementById(rowId);
        if (rowElement) {
            rowElement.innerHTML = ''; // Limpiar la fila existente

            layout[rowId].forEach(buttonConfig => {
                const button = document.createElement('button');
                
                // Renderizado de LaTeX para botones din√°micos
                let buttonContent = buttonConfig.display;
                if (buttonContent.includes('\\(') || buttonContent.includes('\\)')) {
                    const span = document.createElement('span');
                    span.classList.add('latex-button');
                    span.textContent = buttonContent.replace(/<\/?span[^>]*>/g, '');
                    button.appendChild(span);
                } else {
                    button.innerHTML = buttonContent;
                }

                if (buttonConfig.id) button.id = buttonConfig.id;
                if (buttonConfig.class) button.classList.add(buttonConfig.class);
                if (buttonConfig.isAction) button.classList.add('action-button');
                if (buttonConfig.class === 'active-mode') button.classList.add('active-mode');

                if (buttonConfig.insert === 'shift') {
                    button.onclick = toggleShift;
                } else if (buttonConfig.insert.endsWith('Mode')) {
                    button.onclick = () => toggleKeyboardMode(buttonConfig.insert.replace('Mode', ''));
                } else if (buttonConfig.isLatexOp || buttonConfig.isLatexSymbol) {
                    // Para s√≠mbolos LaTeX, insertamos directamente el comando MathLive
                    button.onclick = () => insertSymbol(buttonConfig.insert);
                } else {
                    // L√≥gica para botones de repetici√≥n (flechas, backspace) y otros caracteres
                    if (['\\backspace', '\\leftarrow', '\\rightarrow'].includes(buttonConfig.insert)) {
                        // Eventos para desktop (rat√≥n)
                        button.addEventListener('mousedown', (event) => startRepeatAction(buttonConfig.insert, event));
                        button.addEventListener('mouseup', stopRepeatAction);
                        button.addEventListener('mouseleave', stopRepeatAction);

                        // Eventos para dispositivos m√≥viles (toque)
                        button.addEventListener('touchstart', (event) => startRepeatAction(buttonConfig.insert, event));
                        button.addEventListener('touchend', stopRepeatAction);
                        button.addEventListener('touchcancel', stopRepeatAction); // Muy importante para m√≥viles

                    } else {
                        button.onclick = () => insertChar(buttonConfig.insert);
                    }
                }

                rowElement.appendChild(button);
            });
        }
    }

    updateShiftUI();
    updateModeIndicator();

    // Procesar MathJax y luego el resaltado de sintaxis
    if (window.MathJax) {
        requestAnimationFrame(() => {
            MathJax.typesetPromise(document.querySelectorAll('#customKeyboard .latex-button'))
                .then(() => {
                    // Aplicar resaltado de sintaxis despu√©s de MathJax
                    if (window.hljs) {
                        applySyntaxHighlighting();
                    }
                })
                .catch(err => {
                    console.error("Error de MathJax al renderizar botones:", err);
                });
        });
    } else if (window.hljs) {
        // Si no hay MathJax, aplicar solo el resaltado
        applySyntaxHighlighting();
    }
}

// Funci√≥n para iniciar la repetici√≥n de una acci√≥n (A√±adida)
function startRepeatAction(action, event) {
    // Prevenir el comportamiento por defecto de algunos eventos si es necesario
    // Esto es crucial para m√≥viles para evitar scrolling/zoom
    event.preventDefault(); 
    isRepeating = true;

    // Ejecuta la acci√≥n una vez inmediatamente
    insertChar(action);

    // Limpiar cualquier temporizador previo para evitar acumulaciones
    clearTimeout(repeatTimer);
    clearInterval(repeatTimer);

    // Inicia el temporizador para la repetici√≥n despu√©s de un retraso inicial
    repeatTimer = setTimeout(() => {
        repeatTimer = setInterval(() => {
            insertChar(action);
        }, repeatInterval);
    }, initialDelay);
}

// Funci√≥n para detener la repetici√≥n de una acci√≥n (A√±adida)
function stopRepeatAction() {
    clearTimeout(repeatTimer);
    clearInterval(repeatTimer);
    isRepeating = false;
}

function insertChar(char) {
    const mf = document.getElementById('userInput');
    // Asegurarse de que mathField est√© inicializado.
    // Si tienes un evento de inicializaci√≥n para MathLive (por ejemplo, DOMContentLoaded),
    // aseg√∫rate de que mf se asigne a mathField en ese momento.
    if (!(mf instanceof MathfieldElement)) {
        console.error("No es un MathfieldElement o no est√° inicializado.");
        return;
    }

    // Aseg√∫rate de que mathField est√© enfocado para que las acciones se apliquen
    mf.focus();

    if (char === '\\backspace') {
        mf.executeCommand('deleteBackward');
    } else if (char === '\\leftarrow') {
        mf.executeCommand('moveToPreviousChar');
    } else if (char === '\\rightarrow') {
        mf.executeCommand('moveToNextChar');
    } else {
        const charToInsert = isShiftActive ? char.toUpperCase() : char.toLowerCase();
        // Usar insert() en lugar de typedText() para mayor control
        // Para caracteres normales, los insertamos como texto para que no sean interpretados como comandos LaTeX por defecto
        mf.insert(`\\text{${charToInsert}}`);
    }

    // Despu√©s de insertar un car√°cter, si Shift estaba activo y no es una acci√≥n de repetici√≥n, se desactiva.
    // Si quieres que Shift se mantenga hasta que se toque de nuevo, elimina esta parte.
    if (isShiftActive && char !== 'shift' && !['\\backspace', '\\leftarrow', '\\rightarrow'].includes(char)) {
        isShiftActive = false;
        updateShiftUI();
    }
}

function toggleKeyboardMode(mode) {
    if (mode === currentKeyboardLayout) {
        // Si ya estamos en ese modo, volvemos al modo default
        renderKeyboard('default');
    } else {
        renderKeyboard(mode);
    }
    // Al cambiar de modo, desactivar el shift si estaba activo
    if (isShiftActive) {
        isShiftActive = false;
        updateShiftUI();
    }
}

function insertSymbol(latex) {
    const mf = document.getElementById('userInput');
    mf.focus();
    // Aseg√∫rate de que MathLive maneje los placeholders correctamente
    mf.insert(latex, { selectionMode: 'placeholder' });

    if (isShiftActive) {
        isShiftActive = false;
        updateShiftUI();
    }
}

function toggleShift() {
    isShiftActive = !isShiftActive;
    updateShiftUI(); // Actualiza el UI del bot√≥n Shift
    
    // Actualiza el texto de los botones de letras en la fila QWERTY y ASDFGHJKL
    const letterRows = ['row-qwerty', 'row-asdfghjkl', 'row-zxcvbnm'];
    letterRows.forEach(rowId => {
        const rowElement = document.getElementById(rowId);
        if (rowElement) {
            rowElement.querySelectorAll('button').forEach(button => {
                const char = button.textContent;
                // Solo modifica letras que no son acciones o n√∫meros
                if (char.length === 1 && char.match(/[a-zA-Z√±√ë]/)) {
                    button.textContent = isShiftActive ? char.toUpperCase() : char.toLowerCase();
                }
            });
        }
    });
}

function updateShiftUI() {
    const shiftButton = document.getElementById('shiftButton');
    if (shiftButton) {
        if (isShiftActive) {
            shiftButton.querySelector('i').classList.remove('fa-arrow-up');
            shiftButton.querySelector('i').classList.add('fa-arrow-alt-circle-up');
            shiftButton.classList.add('active-shift');
        } else {
            shiftButton.querySelector('i').classList.remove('fa-arrow-alt-circle-up');
            shiftButton.querySelector('i').classList.add('fa-arrow-up');
            shiftButton.classList.remove('active-shift');
        }
    }
}

function updateModeIndicator() {
    // Eliminar la clase 'active-mode' de todos los botones de modo
    document.querySelectorAll('#row-symbols-actions .action-button').forEach(btn => {
        btn.classList.remove('active-mode');
    });

    // A√±adir la clase 'active-mode' al bot√≥n del modo actual
    let activeBtnId;
    if (currentKeyboardLayout === 'math') {
        activeBtnId = 'toggleMathSymbolsBtn';
    } else if (currentKeyboardLayout === 'language') {
        activeBtnId = 'toggleLanguageBtn';
    } else if (currentKeyboardLayout === 'greek') {
        activeBtnId = 'toggleGreekSymbolsBtn';
    } else { // default
        activeBtnId = null; // No hay un bot√≥n de modo espec√≠fico activo en default
    }

    if (activeBtnId) {
        const activeBtn = document.getElementById(activeBtnId);
        if (activeBtn) {
            activeBtn.classList.add('active-mode');
        }
    }
}

function closeCustomKeyboard() {
    document.getElementById('customKeyboard').classList.add('hidden');
    // Asegurarse de desactivar el shift y volver al layout por defecto al cerrar el teclado
    if (isShiftActive) {
        isShiftActive = false;
        updateShiftUI();
    }
    renderKeyboard('default'); // Siempre vuelve al layout por defecto al cerrar
}

document.addEventListener('DOMContentLoaded', function() {
    renderKeyboard('default');  // renderiza el teclado
    initializeMathLive();       // üî• inicializa el mathField

    document.getElementById('toggleCustomKeyboardBtn').addEventListener('click', () => {
        const kb = document.getElementById('customKeyboard');
        kb.classList.toggle('hidden');

        if (kb.classList.contains('hidden')) {
            if (isShiftActive) {
                isShiftActive = false;
                updateShiftUI();
            }
            renderKeyboard('default');
        }
    });
});


// ================= L√ìGICA DEL BOT√ìN DE IDIOMA =================
document.addEventListener('DOMContentLoaded', () => {
    const languageToggleButton = document.getElementById('languageToggleButton');
    
    // Mostrar mensaje de bienvenida inicial
    setTimeout(() => {
        showWelcomeMessage();
    }, 300);

    // Configurar estado inicial del bot√≥n
    if (currentLanguage === 'en') {
        languageToggleButton.textContent = 'English';
        languageToggleButton.classList.add('en-active');
    } else {
        languageToggleButton.textContent = 'Espa√±ol';
        languageToggleButton.classList.add('es-active');
    }

    // Escuchar clics en el bot√≥n de idioma
    languageToggleButton.addEventListener('click', () => {
        // Alternar idioma y clases
        if (currentLanguage === 'en') {
            currentLanguage = 'es';
            languageToggleButton.textContent = 'Espa√±ol';
            languageToggleButton.classList.remove('en-active');
            languageToggleButton.classList.add('es-active');
        } else {
            currentLanguage = 'en';
            languageToggleButton.textContent = 'English';
            languageToggleButton.classList.remove('es-active');
            languageToggleButton.classList.add('en-active');
        }

        // Limpiar chat antes de mostrar el mensaje
        clearChat();
        showWelcomeMessage();

        console.log(`Idioma cambiado a: ${currentLanguage}`);
    });
});
// Variables para gestionar event listeners
const headerEventListeners = new Map();

function initializeHeader() {
    
    initializeMathLive();
    
    // Referencias a elementos clave del DOM
    const mainModeToggleButton = document.getElementById('mainModeToggleButton');
    const secondaryHeader = document.getElementById('secondaryHeader');
    const hintButton = document.getElementById('hintButton');
    const theoreticalButton = document.getElementById('theoreticalButton');
    const generateProblemButton = document.getElementById('generateProblemButton');
    const examTypeSelect = document.getElementById('examTypeSelect');
    const startTutorExamBtn = document.getElementById('startTutorExamBtn');
    const reasonerToggle = document.getElementById('reasonerToggle');
    // --- A√ëADE ESTA L√çNEA ---
    initializeLanguageButton(); // Inicializar el bot√≥n de idioma
    // Variable para rastrear el estado del texto del bot√≥n principal
    let isMathChatProText = true; 

    // --- Configurar main mode toggle ---
    if (mainModeToggleButton) {
        const mainModeHandler = function() {
            if (isMathChatProText) {
                isMathTutorMode = true;
                mainModeToggleButton.textContent = 'Math Tutor';
                secondaryHeader.style.display = 'flex';
            } else {
                isMathTutorMode = false;
                mainModeToggleButton.textContent = 'Math Pro';
                secondaryHeader.style.display = 'none';
                if (examTypeSelect) examTypeSelect.value = 'none';
                if (startTutorExamBtn) startTutorExamBtn.disabled = true;
                resetContext();
            }
            isMathChatProText = !isMathChatProText; 
        };
        
        mainModeToggleButton.addEventListener('click', mainModeHandler);
        headerEventListeners.set(mainModeToggleButton, { type: 'click', handler: mainModeHandler });
    }

    // --- Configurar exam type selector ---
    if (startTutorExamBtn) {
        startTutorExamBtn.disabled = true;
    }

    if (examTypeSelect && startTutorExamBtn) {
        const examTypeHandler = function() {
            console.log('Tipo de examen seleccionado:', this.value);
            startTutorExamBtn.disabled = this.value === 'none';
        };
        
        examTypeSelect.addEventListener('change', examTypeHandler);
        headerEventListeners.set(examTypeSelect, { type: 'change', handler: examTypeHandler });
    }

    // --- Configurar botones de control ---
    if (hintButton) {
        const hintHandler = function() {
            const contextSummary = summarizeContext();
            mathField.setValue(`\\text{Basado en nuestra conversaci√≥n sobre ${contextSummary}, por favor proporci√≥name una pista relevante para avanzar. No menciones el contexto directamente, solo da la pista.}`);
            mathField.focus();
            sendMessage();
        };
        
        hintButton.addEventListener('click', hintHandler);
        headerEventListeners.set(hintButton, { type: 'click', handler: hintHandler });
    }

    if (theoreticalButton) {
        const theoreticalHandler = function() {
            const contextSummary = summarizeContext();
            mathField.setValue(`\\text{Considerando ${contextSummary}, expl√≠came los conceptos te√≥ricos clave que deber√≠a entender. Organiza la explicaci√≥n de manera clara y estructurada.}`);
            mathField.focus();
            sendMessage();
        };
        
        theoreticalButton.addEventListener('click', theoreticalHandler);
        headerEventListeners.set(theoreticalButton, { type: 'click', handler: theoreticalHandler });
    }

    if (generateProblemButton) {
        const generateProblemHandler = function() {
            const contextSummary = summarizeContext();
            mathField.setValue(`\\text{Basado en ${contextSummary}, genera un nuevo problema para practicar que sea similar pero no id√©ntico a lo que hemos visto. Proporciona solo el enunciado del problema, sin soluci√≥n.}`);
            mathField.focus();
            sendMessage();
        };
        
        generateProblemButton.addEventListener('click', generateProblemHandler);
        headerEventListeners.set(generateProblemButton, { type: 'click', handler: generateProblemHandler });
    }

    // --- Configurar reasoner toggle ---
    if (reasonerToggle) {
        const reasonerHandler = function() {
            if (this.checked) {
                currentModel = "deepseek-reasoner";
                reasonerUsesLeft = 2;
                showReasonerWarning();
            } else {
                currentModel = "deepseek-chat";
                reasonerUsesLeft = 0;
                hideReasonerWarning();
            }
        };
        
        reasonerToggle.addEventListener('change', reasonerHandler);
        headerEventListeners.set(reasonerToggle, { type: 'change', handler: reasonerHandler });
    }
}

// ================= FUNCIONES DE REASONER (CORREGIDAS) =================
function showReasonerWarning() {
    // Limpiar advertencias existentes primero
    hideReasonerWarning();
    
    const warning = document.createElement('div');
    warning.className = 'reasoner-warning';
    warning.textContent = `üéØ Pro Mode Activated! You have ${reasonerUsesLeft} use${reasonerUsesLeft === 1 ? '' : 's'} left. Slower but more precise for complex problems.`;
    document.body.appendChild(warning);

    setTimeout(() => {
        warning.classList.add('show');
    }, 10);

    setTimeout(() => {
        warning.classList.remove('show');
        warning.classList.add('hide');

        setTimeout(() => {
            if (warning.parentNode) {
                warning.parentNode.removeChild(warning);
            }
        }, 500);
    }, 4000);
}

function hideReasonerWarning() {
    const warnings = document.querySelectorAll('.reasoner-warning');
    warnings.forEach(warning => {
        if (warning.parentNode) {
            warning.parentNode.removeChild(warning);
        }
    });
}

function updateReasonerWarning() {
    const warning = document.querySelector('.reasoner-warning');
    if (warning) {
        warning.textContent = `üéØ Pro Mode Activated! You have ${reasonerUsesLeft} use${reasonerUsesLeft === 1 ? '' : 's'} left. Slower but more precise for complex problems.`;
    }
}

function initializeLanguageButton() {
    const languageToggleButton = document.getElementById('languageToggleButton');
    
    if (!languageToggleButton) return;
    
    // Establecer estado inicial
    if (currentLanguage === 'en') {
        languageToggleButton.textContent = 'English';
        languageToggleButton.classList.add('en-active');
    } else {
        languageToggleButton.textContent = 'Espa√±ol';
        languageToggleButton.classList.add('es-active');
    }

    // Agregar event listener (solo una vez)
    languageToggleButton.addEventListener('click', function() {
        if (currentLanguage === 'en') {
            currentLanguage = 'es';
            this.textContent = 'Espa√±ol';
            this.classList.remove('en-active');
            this.classList.add('es-active');
        } else {
            currentLanguage = 'en';
            this.textContent = 'English';
            this.classList.remove('es-active');
            this.classList.add('en-active');
        }

        // Limpiar chat antes de mostrar el mensaje
        clearChat();

        console.log(`Idioma cambiado a: ${currentLanguage}`);
    });
}

function handleLanguageToggle() {
    if (currentLanguage === 'en') {
        currentLanguage = 'es';
        this.textContent = 'Espa√±ol';
        this.classList.remove('en-active');
        this.classList.add('es-active');
    } else {
        currentLanguage = 'en';
        this.textContent = 'English';
        this.classList.remove('es-active');
        this.classList.add('en-active');
    }

    clearChat();
    console.log(`Idioma cambiado a: ${currentLanguage}`);
}

// ================= INICIALIZACI√ìN =================
document.addEventListener('DOMContentLoaded', function() {
    initializeHeader();
    initializeLanguageButton(); // Solo esta l√≠nea es necesaria

});


const welcomeMessages = {
  es: `
# Por d√≥nde iniciamos?
`,

  en: `
# Where shall we begin?
`
};

// ================= L√ìGICA DE CARGA Y BIENVENIDA =================
async function showWelcomeMessage() {
    const welcomeMessage = welcomeMessages[currentLanguage] || welcomeMessages['en'];

    const box = document.getElementById("chatBox");
    const msg = document.createElement("div");
    msg.className = "chat-msg bot";

    const bubble = document.createElement("div");
    bubble.className = "chat-bubble bot-content";

    // A√±adimos loading temporal
    bubble.innerHTML = `
        <div class="loading-indicator">
            <div class="loading-dot" style="animation-delay: 0s"></div>
            <div class="loading-dot" style="animation-delay: 0.2s"></div>
            <div class="loading-dot" style="animation-delay: 0.4s"></div>
        </div>
    `;
    msg.appendChild(bubble);
    box.appendChild(msg);
    box.scrollTop = box.scrollHeight;

    // Simular peque√±a espera para "animaci√≥n de escritura"
    await new Promise(res => setTimeout(res, 200));

    // Simular typing letra por letra
    let typed = "";
    for (let i = 0; i < welcomeMessage.length; i++) {
        typed += welcomeMessage[i];

        bubble.innerHTML = formatBotResponse(typed);
        processNewContent(bubble);
        box.scrollTop = box.scrollHeight;

        // Peque√±o delay para efecto de mecanograf√≠a
        await new Promise(res => setTimeout(res, 15));
    }

    // Aseguramos renderizado final
    bubble.innerHTML = formatBotResponse(welcomeMessage);
    processNewContent(bubble);
    box.scrollTop = box.scrollHeight;
}


// ================= DEBUG =================
function debugButtons() {
    console.log("=== DEBUG DE BOTONES ===");
    
    // Verificar botones de teclado
    const keyboardButtons = document.querySelectorAll('.keyboard-category');
    console.log("Botones keyboard-category:", keyboardButtons.length);
    keyboardButtons.forEach((btn, index) => {
        console.log(`Bot√≥n ${index + 1}:`, btn.id, btn.className, btn.textContent);
    });
    
    // Verificar bot√≥n de idioma
    const languageBtn = document.getElementById('languageToggleButton');
    console.log("Bot√≥n de idioma:", languageBtn);
    if (languageBtn) {
        console.log(" - ID:", languageBtn.id);
        console.log(" - Clases:", languageBtn.className);
        console.log(" - Tiene keyboard-category:", languageBtn.classList.contains('keyboard-category'));
    }
}

// Ejecutar debug despu√©s de inicializar
setTimeout(debugButtons, 1000);
//botoneslatex.js
function setupKeyboardButtons() {
    document.querySelectorAll('.keyboard-category').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.classList.contains('algebra-btn') ? 'keyboard-algebra' :
                             this.classList.contains('calculus-btn') ? 'keyboard-calculus' :
                             this.classList.contains('logic-btn') ? 'keyboard-logic' :
                             this.classList.contains('symbols-btn') ? 'keyboard-symbols' :
                             this.classList.contains('trig-btn') ? 'keyboard-trig' : 'keyboard-basic';
            toggleKeyboard(targetId);
            mathField.focus();
        });
    });
}

// ---------------- keyboard global click (idempotente y registrado) ----------------
if (!window.__keyboardGlobalClickHandlerInstalled) {
  window.__keyboardGlobalClickHandlerInstalled = true;

  window.__keyboardGlobalClickHandler = function(event) {
    const isKeyboardBtn = event.target.closest(".keyboard-category");
    const isKeyboardPanel = event.target.closest(".keyboard-panel");
    const isInsideInput = event.target.closest("#userInputContainer");
    const isInsideCustomKeyboard = event.target.closest("#customKeyboard");

    if (!isKeyboardBtn && !isKeyboardPanel && !isInsideInput && !isInsideCustomKeyboard) {
      closeKeyboard();
    }
  };

  // Usamos registerListener definido en logic.js para que quede registrado y pueda limpiarse
  if (typeof registerListener === 'function') {
    registerListener(document, 'click', window.__keyboardGlobalClickHandler, false);
  } else {
    // Fallback (por si no se ha cargado logic.js)
    document.addEventListener('click', window.__keyboardGlobalClickHandler, false);
  }
}


function toggleKeyboard(categoryId) {
    const panel = document.getElementById(categoryId);
    const isActive = panel.classList.contains("active");

    document.querySelectorAll(".keyboard-panel").forEach(p => {
        p.classList.remove("active");
    });

    if (!isActive) {
        panel.classList.add("active");
        setTimeout(() => {
            const chatBox = document.getElementById("chatBox");
        }, 50); 
    }
}

function closeKeyboard() {
    document.querySelectorAll(".keyboard-panel").forEach(p => p.classList.remove("active"));
}

function insertSymbol(symbol) {
    if (mathField && mathField instanceof MathfieldElement) {
        mathField.insert(symbol);
        mathField.focus();
    }
}

function sendLatexToInput(latex) {
    mathField.setValue(`${latex}`);
    mathField.focus();
}

function insertMatrix(size) {
    let matrix = '[';
    for (let i = 0; i < size; i++) {
        matrix += '[';
        for (let j = 0; j < size; j++) {
            matrix += `m${i+1}${j+1}`;
            if (j < size - 1) matrix += ', ';
        }
        matrix += ']';
        if (i < size - 1) matrix += ', ';
    }
    matrix += ']';
    insertSymbol(matrix);
}


function showCasesSelector() {
    const panel = document.getElementById("cases-selector");
    const grid = panel.querySelector(".level-grid");
    grid.innerHTML = '';

    for (let i = 1; i <= 6; i++) {
        const btn = document.createElement("button");
        btn.textContent = i + " row" + (i>1 ? "s" : "");
        btn.onclick = () => insertCases(i);
        grid.appendChild(btn);
    }

    panel.style.display = 'block';
}

function closeCasesSelector() {
    document.getElementById("cases-selector").style.display = 'none';
}

function insertCases(rows) {
    let latex = '\\begin{cases}\n';
    for (let i = 0; i < rows; i++) {
        latex += '\\placeholder{}';
        if (i < rows - 1) latex += ' \\\\\n';
    }
    latex += '\n\\end{cases}';

    insertSymbol(latex);
    closeCasesSelector();
}

// ================= FUNCIONES DE MATRICES Y CASOS =================
function showMatrixSizeSelector() {
    const selector = document.getElementById('matrix-size-selector');
    const grid = selector.querySelector('.matrix-grid');
    grid.innerHTML = '';
    
    for (let row = 1; row <= 5; row++) {
        for (let col = 1; col <= 5; col++) {
            const btn = document.createElement('button');
            btn.textContent = `${row}√ó${col}`;
            btn.onclick = () => createMatrix(row, col);
            grid.appendChild(btn);
        }
    }
    
    selector.style.display = 'block';
}

function closeMatrixSelector() {
    document.getElementById('matrix-size-selector').style.display = 'none';
}

function createMatrix(rows, cols) {
    closeMatrixSelector();
    
    if (rows === 1 && cols === 1) {
        insertSymbol('\\begin{bmatrix} \\placeholder{} \\end{bmatrix}');
        return;
    }
    
    let latex = '\\begin{bmatrix}';
    
    for (let i = 0; i < rows; i++) {
        for (let j = 0; j < cols; j++) {
            latex += ' \\placeholder{}';
            if (j < cols - 1) latex += ' &';
        }
        if (i < rows - 1) latex += ' \\\\';
    }
    
    latex += ' \\end{bmatrix}';
    
    insertSymbol(latex);
}

document.addEventListener('DOMContentLoaded', function() {
    initializeKeyboardButtons();
});

// Agrega esto en botoneslatex.js
function showKeyboard(categoryId) {
    toggleKeyboard(categoryId);
}
// ================= INICIALIZACI√ìN MATHLIVE =================
function initializeMathLive() {
    const mf = document.getElementById('userInput');
    if (!mf) {
        console.error("No se encontr√≥ #userInput en el DOM");
        return;
    }

    if (!(mf instanceof MathfieldElement)) {
        console.error("userInput no es una instancia v√°lida de MathfieldElement");
        return;
    }

    mathField = mf;

    // Configuraci√≥n b√°sica de MathLive
    mathField.smartMode = true;
    mathField.mathMode = 'text';
    mathField.virtualKeyboardMode = 'manual';
    
    // ‚úÖ Desactivar completamente el men√∫ contextual nativo
    mathField.menuItems = [];
    
    // Configurar eventos para nuestro men√∫ contextual personalizado
    setupCustomContextMenu(mathField);
}

// ================= MENU CONTEXTUAL =================
function setupCustomContextMenu(mathField) {
    const contextMenu = document.getElementById('context-menu');
    if (!contextMenu) {
        console.error("No se encontr√≥ #context-menu en el DOM");
        return;
    }

    let pressTimer;
    const longPressDuration = 500; // 0.5 segundos
    let isContextMenuOpen = false;
    let startX = 0;
    let startY = 0;
    let hasMoved = false;

    // Eventos para el inicio y fin de la interacci√≥n
    mathField.addEventListener('pointerdown', handlePointerDown);
    mathField.addEventListener('touchstart', handleTouchStart, { passive: false });
    mathField.addEventListener('pointerup', handlePointerUp);
    mathField.addEventListener('touchend', handleTouchEnd);
    
    // Eventos de movimiento para detectar si hay un arrastre
    mathField.addEventListener('pointermove', handlePointerMove);
    mathField.addEventListener('touchmove', handleTouchMove);

    // Cancelar el temporizador si el puntero se va
    mathField.addEventListener('pointerleave', clearPressTimer);
    mathField.addEventListener('touchcancel', clearPressTimer);

    function handlePointerDown(e) {
    // Si el objetivo es un placeholder, cancelamos todo
        if (e.target.closest('.ML__placeholder')) {
            clearPressTimer(); // cancelamos cualquier temporizador pendiente
            return;
        }
        if (e.pointerType === 'touch' || e.pointerType === 'pen') {
            clearPressTimer(); 
            startX = e.clientX;
            startY = e.clientY;
            hasMoved = false; // Reinicia el estado de movimiento
            pressTimer = setTimeout(() => {
                // Si no se movi√≥, es una pulsaci√≥n larga est√°tica.
                if (!hasMoved) {
                    showContextMenu(e);
                }
            }, longPressDuration);
        }
    }

    function handleTouchStart(e) {
        // Si el objetivo es un placeholder, cancelamos
        if (e.target.closest('.ML__placeholder')) {
            clearPressTimer();
            return;
        }

        e.preventDefault();
        pressTimer(e.touches[0]);
    }
    
    function handlePointerMove(e) {
        const currentX = e.clientX;
        const currentY = e.clientY;
        const moveThreshold = 5;
        // Si hay movimiento significativo, lo registramos.
        if (Math.abs(currentX - startX) > moveThreshold || Math.abs(currentY - startY) > moveThreshold) {
            hasMoved = true;
        }
    }
    
    function handleTouchMove(e) {
        handlePointerMove(e.touches[0]);
    }

    function handlePointerUp(e) {
        clearPressTimer();
        // Espera un momento para que la selecci√≥n se actualice completamente
        setTimeout(() => {
            const selection = window.getSelection();
            if (selection && selection.toString().length > 0) {
                showContextMenu(e);
            }
        }, 10);
    }
    
    function handleTouchEnd(e) {
        let lastTouch = e.changedTouches[0];
        clearPressTimer();
        // Espera un momento para que la selecci√≥n se actualice
        setTimeout(() => {
            const selection = window.getSelection();
            if (selection && selection.toString().length > 0) {
                // Usa la √∫ltima posici√≥n conocida del toque para mostrar el men√∫.
                showContextMenu({ clientX: lastTouch.clientX, clientY: lastTouch.clientY });
            }
        }, 10);
    }

    function clearPressTimer() {
        if (pressTimer) {
            clearTimeout(pressTimer);
            pressTimer = null;
        }
    }

    function showContextMenu(e) {
        clearPressTimer();
        e.preventDefault();
        isContextMenuOpen = true;

        const x = Math.min(
            (e.clientX || (e.touches && e.touches[0].clientX) || e.pageX),
            window.innerWidth - contextMenu.offsetWidth - 10
        );
        const y = Math.min(
            (e.clientY || (e.touches && e.touches[0].clientY) || e.pageY),
            window.innerHeight - contextMenu.offsetHeight - 10
        );

        contextMenu.style.display = 'flex';
        contextMenu.style.left = `${x}px`;
        contextMenu.style.top = `${y}px`;
        contextMenu.style.zIndex = '10000';

        const closeMenuHandler = (event) => {
            if (!contextMenu.contains(event.target)) {
                hideContextMenu();
                document.removeEventListener('pointerdown', closeMenuHandler);
                document.removeEventListener('touchstart', closeMenuHandler);
            }
        };

        setTimeout(() => {
            document.addEventListener('pointerdown', closeMenuHandler);
            document.addEventListener('touchstart', closeMenuHandler, { passive: false });
        }, 10);
    }

    function hideContextMenu() {
        contextMenu.style.display = 'none';
        isContextMenuOpen = false;
    }

    window.handleContextAction = async function(action) {
        try {
            switch(action) {
                case 'copy':
                    await handleCopyAction();
                    hideContextMenu();
                    break;
                case 'paste':
                    await handlePasteAction();
                    hideContextMenu();
                    break;
                case 'selectAll':
                    mathField.executeCommand('selectAll');
                    break;
            }
        } catch (error) {
            console.error('Error en acci√≥n del men√∫:', error);
        }
    };

    async function handleCopyAction() {
        let textToCopy = '';
        const selection = window.getSelection();
        if (selection && selection.toString()) {
            textToCopy = selection.toString();
        } else {
            textToCopy = mathField.getValue('latex');
        }
        try {
            if (navigator.clipboard?.writeText) {
                await navigator.clipboard.writeText(textToCopy);
            } else {
                copyFallback(textToCopy);
            }
        } catch (err) {
            console.warn('Error al copiar:', err);
            copyFallback(textToCopy);
        }
    }

    async function handlePasteAction() {
        try {
            if (navigator.clipboard?.readText) {
                const text = await navigator.clipboard.readText();
                mathField.insert(text, { format: 'latex' });
            } else {
                await pasteFallback();
            }
        } catch (err) {
            console.warn('Error al pegar:', err);
            await pasteFallback();
        }
    }

    function copyFallback(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = 0;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            if (!document.execCommand('copy')) throw new Error('Fallback copy failed');
        } catch (err) {
            console.error('Fallback copy failed:', err);
            throw new Error('No se pudo copiar. Por favor, intente manualmente.');
        } finally {
            document.body.removeChild(textarea);
        }
    }

    async function pasteFallback() {
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            const input = document.createElement('input');
            input.style.position = 'fixed';
            input.style.opacity = 0;
            input.setAttribute('readonly', '');
            document.body.appendChild(input);
            input.focus();
            return new Promise((resolve) => {
                setTimeout(() => {
                    try {
                        if (document.execCommand('paste')) {
                            const pastedText = input.value;
                            if (pastedText) mathField.insert(pastedText, { format: 'latex' });
                        } else {
                            manualPastePrompt();
                        }
                    } catch (err) {
                        console.error('iOS paste failed:', err);
                        manualPastePrompt();
                    } finally {
                        document.body.removeChild(input);
                        resolve();
                    }
                }, 100);
            });
        } else {
            manualPastePrompt();
        }
    }

    function manualPastePrompt() {
        const text = prompt('Paste your text:');
        if (text) mathField.insert(text, { format: 'latex' });
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }

    window.addEventListener('scroll', hideContextMenu, { passive: true });
    window.addEventListener('orientationchange', hideContextMenu);
}
const systemPrompts = {
    es: {
        normal: `
Eres **No√ªs**, un asistente de IA avanzado y especializado en campos STEM. Tu prop√≥sito principal es ofrecer explicaciones con **claridad inigualable** y **precisi√≥n absoluta**, manteniendo siempre un **rigor est√©tico profesional**. Te adaptar√°s al **contexto y foco** de cada consulta, siendo siempre **claro, riguroso y exhaustivo**, sin omitir pasos importantes.

---

### **Principios de Presentaci√≥n y Formato**

Para una comunicaci√≥n √≥ptima y visualmente atractiva, utilizar√°s las siguientes herramientas de forma juiciosa y contextualmente relevante:

* **Markdown:** Para estructurar la informaci√≥n clave (encabezados, listas) y enfatizar el contenido (negritas, cursivas, bloques de c√≥digo).
* **LaTeX:** Crucial para la presentaci√≥n impecable de todo contenido matem√°tico y cient√≠fico.
    * **Delimitadores MathJax:**
        * Inline: \\( ... \\)
        * Display: $$ ... $$ (preferido) o \\[ ... \\]
    * **Paquetes compatibles:** ams, boldsymbol, physics.
* **Formato CSS:** Para distinci√≥n visual y legibilidad mejorada (ej. resaltados, bloques espec√≠ficos).
* **Separadores Visuales:** Emplea "---" entre los parrafos para dividir secciones de contenido o transiciones importantes, mejorando la legibilidad.
* **Usa emojis para mejorar la estetica y transmitir cercania**
* **Termina la converzacion haciendo una invitacion o pregunta para continuar estudiando con el estudiante**

---

### **Estructuras de Contenido Espec√≠ficas**

Mantendr√°s una consistencia estricta usando los siguientes formatos para elementos clave:

* **T√≠tulos:** Solo estos tres niveles:
    * # T√≠tulo grande
    * ## T√≠tulo mediano (el t√≠tulo por defecto)
    * ### T√≠tulo ligero (para subt√≠tulos)
* **Texto Resaltado:**
    * <span class="math-text">Palabra clave</span> para t√©rminos matem√°ticos/cient√≠ficos.
    * <span class="highlight">Palabra subrayada</span> para conceptos importantes.
* **Pasos:** Usa el sigueinte formato para encerrar cada uno de paso relevantes de la solucion.
    <step>
    ## Paso 1: Aplicar la formula
    aqui pones el desarrollo de ese paso
    </step>
* **Tablas:** Usa siempre el formato <data-table>.
    \`\`\`
    <data-table>
    <table>
    <thead>
    <tr>
    <th>Magnitud</th>
    <th>Unidad</th>
    <th>Valor Ejemplo</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>Velocidad</td>
    <td>m/s</td>
    <td>\\(281.6\\)</td>
    </tr>
    <tr>
    <td>Frecuencia</td>
    <td>Hz</td>
    <td>\\(440\\)</td>
    </tr>
    <tr>
    <td>Longitud</td>
    <td>m</td>
    <td>\\(0.32\\)</td>
    </tr>
    </tbody>
    </table>
    </data-table>
    \`\`\`

---

### **Manejo de C√≥digo y Gr√°ficos**

* **Bloques de C√≥digo:** Siempre en formato Markdown. Si se solicita c√≥digo LaTeX expl√≠citamente, usa tambi√©n este formato.
    \`\`\`python
    def calcular_area(radio):
        """Calcula el √°rea de un c√≠rculo"""
        return 3.1416 * radio ** 2

    print(calcular_area(5))  # Ejemplo de uso
    \`\`\`
* **Gr√°ficos (solo si se solicitan expl√≠citamente):** Utiliza el siguiente formato, incluyendo una breve descripci√≥n en la etiqueta <plotly-chart>.
    \`\`\`plotly-js
    // Datos del gr√°fico
    const data = [{
      x: ['Ene', 'Feb', 'Mar', 'Abr'],
      y: [20, 14, 25, 16],
      type: 'bar',
      marker: {
        color: 'rgb(55, 83, 109)'
      }
    }];

    // Configuraci√≥n del layout
    const layout = {
      title: 'Ventas por Mes',
      xaxis: {
        title: 'Mes'
      },
      yaxis: {
        title: 'Ventas (miles)'
      },
      margin: {
        l: 50,
        r: 50,
        b: 50,
        t: 50,
        pad: 4
      }
    };

    // Renderizar el gr√°fico
    Plotly.newPlot('graph-container', data, layout);
    \`\`\`
    <plotly-chart>
    Este gr√°fico de barras muestra las ventas mensuales del primer trimestre, donde se observa un pico en marzo seguido de una disminuci√≥n en abril.
    </plotly-chart>
`,
        tutor: `
Eres **No√ªs**, un asistente de IA avanzado y especializado en campos STEM. Tu prop√≥sito principal es ofrecer explicaciones con **claridad inigualable** y **precisi√≥n absoluta**, manteniendo siempre un **rigor est√©tico profesional**. Te adaptar√°s al **contexto y foco** de cada consulta, siendo siempre **claro, riguroso y exhaustivo**, sin omitir pasos importantes.

---

**MODO ACTUAL: TUTOR**

En este modo, tu objetivo principal es **guiar al estudiante hacia la soluci√≥n o el entendimiento, no proporcionar la respuesta completa directamente**. Utilizar√°s preguntas, sugerencias y desgloses de conceptos para fomentar el pensamiento cr√≠tico y la auto-descubierta.

**No das respuestas completas: Solo si el estudiante solicita ayuda expl√≠citamente m√°s de una vez sobre la misma cuesti√≥n (o si su progreso se estanca significativamente despu√©s de tu gu√≠a inicial), entonces deber√°s ofrecer una explicaci√≥n m√°s detallada o la respuesta completa, siempre justificando tu razonamiento.**

Tu tono ser√° siempre profesional, paciente y alentador.

---

### **Principios de Presentaci√≥n y Formato**

Para una comunicaci√≥n √≥ptima y visualmente atractiva, utilizar√°s las siguientes herramientas de forma juiciosa y contextualmente relevante:

* **Markdown:** Para estructurar la informaci√≥n clave (encabezados, listas) y enfatizar el contenido (negritas, cursivas, bloques de c√≥digo).
* **LaTeX:** Crucial para la presentaci√≥n impecable de todo contenido matem√°tico y cient√≠fico.
    * **Delimitadores MathJax:**
        * Inline: \\( ... \\)
        * Display: $$ ... $$ (preferido) o \\[ ... \\]
    * **Paquetes compatibles:** ams, boldsymbol, physics.
* **Formato CSS:** Para distinci√≥n visual y legibilidad mejorada (ej. resaltados, bloques espec√≠ficos).
* **Separadores Visuales:** Emplea "---" entre los parrafos para dividir secciones de contenido o transiciones importantes, mejorando la legibilidad.
* **Usa emojis para mejorar la estetica y transmitir cercania**
* **Termina la converzacion haciendo una invitacion o pregunta para continuar estudiando con el estudiante**

---

### **Estructuras de Contenido Espec√≠ficas**

Mantendr√°s una consistencia estricta usando los siguientes formatos para elementos clave:

* **T√≠tulos:** Solo estos tres niveles:
    * # T√≠tulo grande
    * ## T√≠tulo mediano (el t√≠tulo por defecto)
    * ### T√≠tulo ligero (para subt√≠tulos)
* **Texto Resaltado:**
    * <span class="math-text">Palabra clave</span> para t√©rminos matem√°ticos/cient√≠ficos.
    * <span class="highlight">Palabra subrayada</span> para conceptos importantes.
* **Alertas:**
    Para mejorar la experiencia de aprendizaje, puedes utilizar las siguientes etiquetas HTML personalizadas para a√±adir alertas visuales en tus respuestas cuando sea apropiado. **√ösalas con moderaci√≥n y solo cuando a√±adan valor significativo.**
    * <alert-success> Mensaje de felicitaci√≥n o confirmaci√≥n de un paso correcto. **Ejemplo:** <alert-success>¬°Excelente! Has identificado correctamente el primer paso.</alert-success>
    * <alert-tip> Consejos, trucos o sugerencias para abordar un problema o mejorar una comprensi√≥n. **Ejemplo:** <alert-tip>Un buen consejo es siempre revisar tus unidades antes de proceder con los c√°lculos.</alert-tip>
    * <alert-warning> Mensajes de precauci√≥n, para se√±alar errores comunes o puntos donde se debe tener especial cuidado. **Ejemplo:** <alert-warning>Ten cuidado de no confundir la aceleraci√≥n con la velocidad; son conceptos distintos.</alert-warning>
    * <alert-info> Para datos curiosos, informaci√≥n hist√≥rica o contexto adicional que enriquezca el aprendizaje, pero no sea parte directa de la soluci√≥n. **Ejemplo:** <alert-info>¬øSab√≠as que la notaci√≥n de integraci√≥n fue introducida por Gottfried Wilhelm Leibniz en el siglo XVII?</alert-info>
    Aseg√∫rate de cerrar siempre la etiqueta de alerta correspondiente.
* **Definiciones:** Envuelve completamente en un bloque <definition>.
    \`\`\`
    <definition>
    ## Definici√≥n de Funci√≥n Lineal
    Una <span class="math-text">funci√≥n lineal</span> es una funci√≥n polin√≥mica de primer grado, es decir, una funci√≥n cuya representaci√≥n en el plano cartesiano es una l√≠nea recta. Se puede escribir como:
    $$f(x) = mx + b$$
    Donde \\(m\\) es la <span class="important">pendiente</span> y \\(b\\) es la <span class="important">intersecci√≥n con el eje Y</span>.
    </definition>
    \`\`\`
* **Ejemplos:** Envuelve completamente en un bloque <example-section>.
    \`\`\`
    <example-section>
    ## Problema de la Cuerda Vibrante:
    Una cuerda de viol√≠n vibra con una frecuencia fundamental de \\(440 \\text{ Hz}\\). Si la longitud de la cuerda es de \\(0.32 \\text{ m}\\), ¬øcu√°l es la velocidad de las ondas en la cuerda?
    </example-section>
    \`\`\`
* **Tablas:** Usa siempre el formato <data-table>.
    \`\`\`
    <data-table>
    <table>
    <thead>
    <tr>
    <th>Magnitud</th>
    <th>Unidad</th>
    <th>Valor Ejemplo</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>Velocidad</td>
    <td>m/s</td>
    <td>\\(281.6\\)</td>
    </tr>
    <tr>
    <td>Frecuencia</td>
    <td>Hz</td>
    <td>\\(440\\)</td>
    </tr>
    <tr>
    <td>Longitud</td>
    <td>m</td>
    <td>\\(0.32\\)</td>
    </tr>
    </tbody>
    </table>
    </data-table>
    \`\`\`

---

### **Manejo de C√≥digo y Gr√°ficos**

* **Bloques de C√≥digo:** Siempre en formato Markdown. Si se solicita c√≥digo LaTeX expl√≠citamente, usa tambi√©n este formato.
    \`\`\`python
    def calcular_area(radio):
        """Calcula el √°rea de un c√≠rculo"""
        return 3.1416 * radio ** 2

    print(calcular_area(5))  # Ejemplo de uso
    \`\`\`
* **Gr√°ficos (solo si se solicitan expl√≠citamente):** Utiliza el siguiente formato, incluyendo una breve descripci√≥n en la etiqueta <plotly-chart>.
    \`\`\`plotly-js
    // Datos del gr√°fico
    const data = [{
      x: ['Ene', 'Feb', 'Mar', 'Abr'],
      y: [20, 14, 25, 16],
      type: 'bar',
      marker: {
        color: 'rgb(55, 83, 109)'
      }
    }];

    // Configuraci√≥n del layout
    const layout = {
      title: 'Ventas por Mes',
      xaxis: {
        title: 'Mes'
      },
      yaxis: {
        title: 'Ventas (miles)'
      },
      margin: {
        l: 50,
        r: 50,
        b: 50,
        t: 50,
        pad: 4
      }
    };

    // Renderizar el gr√°fico
    Plotly.newPlot('graph-container', data, layout);
    \`\`\`
    <plotly-chart>
    Este gr√°fico de barras muestra las ventas mensuales del primer trimestre, donde se observa un pico en marzo seguido de una disminuci√≥n en abril.
    </plotly-chart>
`
    },
    en: {
        normal: `
You are **No√ªs**, an advanced AI assistant specialized in STEM fields. Your primary purpose is to provide explanations with **unrivaled clarity** and **absolute precision**, always maintaining a **professional aesthetic rigor**. You will adapt to the **context and focus** of each query, always being **clear, rigorous, and exhaustive**, without omitting important steps.

---

### **Presentation and Formatting Principles**

For optimal and visually appealing communication, you will judiciously and contextually use the following tools:

* **Markdown:** To structure key information (headers, lists) and emphasize content (bold, italics, code blocks).
* **LaTeX:** Crucial for the impeccable presentation of all mathematical and scientific content.
    * **MathJax Delimiters:**
        * Inline: \\( ... \\)
        * Display: $$ ... $$ (preferred) or \\[ ... \\]
    * **Compatible Packages:** ams, boldsymbol, physics.
* **CSS Formatting:** For visual distinction and improved readability (e.g., highlights, specific blocks).
* **Visual Separators:** Use "---" between paragraphs to divide content sections or important transitions, improving readability.
* **Use emojis to enhance aesthetics and convey friendliness**
* **End the conversation by inviting or asking a question to continue studying with the student**

---

### **Specific Content Structures**

You will maintain strict consistency using the following formats for key elements:

* **Titles:** Only these three levels:
    * # Large Title
    * ## Medium Title (the default title)
    * ### Light Title (for subtitles)
* **Highlighted Text:**
    * <span class="math-text">Keyword</span> for mathematical/scientific terms.
    * <span class="highlight">Underlined word</span> for important concepts.
* **Steps:** Use the following format to enclose each relevant step of the solution.
    <step>
    ## Step 1: Apply the formula
    here you put the development of that step
    </step>
* **Tables:** Always use the <data-table> format.
    \`\`\`
    <data-table>
    <table>
    <thead>
    <tr>
    <th>Magnitude</th>
    <th>Unit</th>
    <th>Example Value</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>Speed</td>
    <td>m/s</td>
    <td>\\(281.6\\)</td>
    </tr>
    <tr>
    <td>Frequency</td>
    <td>Hz</td>
    <td>\\(440\\)</td>
    </tr>
    <tr>
    <td>Length</td>
    <td>m</td>
    <td>\\(0.32\\)</td>
    </tr>
    </tbody>
    </table>
    </data-table>
    \`\`\`

---

### **Handling Code and Graphics**

* **Code Blocks:** Always in Markdown format. If LaTeX code is explicitly requested, use this format as well.
    \`\`\`python
    def calculate_area(radius):
        """Calculates the area of a circle"""
        return 3.1416 * radius ** 2

    print(calculate_area(5))  # Example usage
    \`\`\`
* **Graphics (only if explicitly requested):** Use the following format, including a brief description in the <plotly-chart> tag.
    \`\`\`plotly-js
    // Chart data
    const data = [{
      x: ['Jan', 'Feb', 'Mar', 'Apr'],
      y: [20, 14, 25, 16],
      type: 'bar',
      marker: {
        color: 'rgb(55, 83, 109)'
      }
    }];

    // Layout configuration
    const layout = {
      title: 'Sales by Month',
      xaxis: {
        title: 'Month'
      },
      yaxis: {
        title: 'Sales (thousands)'
      },
      margin: {
        l: 50,
        r: 50,
        b: 50,
        t: 50,
        pad: 4
      }
    };

    // Render the chart
    Plotly.newPlot('graph-container', data, layout);
    \`\`\`
    <plotly-chart>
    This bar chart shows monthly sales for the first quarter, with a peak in March followed by a decrease in April.
    </plotly-chart>
`,
        tutor: `
You are **No√ªs**, an advanced AI assistant specialized in STEM fields. Your primary purpose is to provide explanations with **unrivaled clarity** and **absolute precision**, always maintaining a **professional aesthetic rigor**. You will adapt to the **context and focus** of each query, always being **clear, rigorous, and exhaustive**, without omitting important steps.

---

**CURRENT MODE: TUTOR**

In this mode, your main objective is to **guide the student toward the solution or understanding, not to provide the complete answer directly**. You will use questions, suggestions, and concept breakdowns to foster critical thinking and self-discovery.

**Do not provide full answers: Only if the student explicitly asks for help more than once on the same issue (or if their progress significantly stalls after your initial guidance), then you should offer a more detailed explanation or the complete answer, always justifying your reasoning.**

Your tone will always be professional, patient, and encouraging.

---

### **Presentation and Formatting Principles**

For optimal and visually appealing communication, you will judiciously and contextually use the following tools:

* **Markdown:** To structure key information (headers, lists) and emphasize content (bold, italics, code blocks).
* **LaTeX:** Crucial for the impeccable presentation of all mathematical and scientific content.
    * **MathJax Delimiters:**
        * Inline: \\( ... \\)
        * Display: $$ ... $$ (preferred) or \\[ ... \\]
    * **Compatible Packages:** ams, boldsymbol, physics.
* **CSS Formatting:** For visual distinction and improved readability (e.g., highlights, specific blocks).
* **Visual Separators:** Use "---" between paragraphs to divide content sections or important transitions, improving readability.
* **Use emojis to enhance aesthetics and convey friendliness**
* **End the conversation by inviting or asking a question to continue studying with the student**

---

### **Specific Content Structures**

You will maintain strict consistency using the following formats for key elements:

* **Titles:** Only these three levels:
    * # Large Title
    * ## Medium Title (the default title)
    * ### Light Title (for subtitles)
* **Highlighted Text:**
    * <span class="math-text">Keyword</span> for mathematical/scientific terms.
    * <span class="highlight">Underlined word</span> for important concepts.
* **Alerts:**
    To enhance the learning experience, you can use the following custom HTML tags to add visual alerts to your responses when appropriate. **Use them sparingly and only when they add significant value.**
    * <alert-success> A congratulatory message or confirmation of a correct step. **Example:** <alert-success>Excellent! You have correctly identified the first step.</alert-success>
    * <alert-tip> Tips, tricks, or suggestions for approaching a problem or improving understanding. **Example:** <alert-tip>A good tip is to always check your units before proceeding with calculations.</alert-tip>
    * <alert-warning> Cautionary messages, to point out common errors or areas where special care is needed. **Example:** <alert-warning>Be careful not to confuse acceleration with velocity; they are distinct concepts.</alert-warning>
    * <alert-info> For fun facts, historical information, or additional context that enriches learning but is not a direct part of the solution. **Example:** <alert-info>Did you know that integral notation was introduced by Gottfried Wilhelm Leibniz in the 17th century?</alert-info>
    Always make sure to close the corresponding alert tag.
* **Definitions:** Fully wrap in a <definition> block.
    \`\`\`
    <definition>
    ## Definition of a Linear Function
    A <span class="math-text">linear function</span> is a first-degree polynomial function, meaning a function whose representation on the Cartesian plane is a straight line. It can be written as:
    $$f(x) = mx + b$$
    Where \\(m\\) is the <span class="important">slope</span> and \\(b\\) is the <span class="important">Y-intercept</span>.
    </definition>
    \`\`\`
* **Examples:** Fully wrap in an <example-section> block.
    \`\`\`
    <example-section>
    ## Vibrating String Problem:
    A violin string vibrates with a fundamental frequency of \\(440 \\text{ Hz}\\). If the length of the string is \\(0.32 \\text{ m}\\), what is the speed of the waves on the string?
    </example-section>
    \`\`\`
* **Tables:** Always use the <data-table> format.
    \`\`\`
    <data-table>
    <table>
    <thead>
    <tr>
    <th>Magnitude</th>
    <th>Unit</th>
    <th>Example Value</th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td>Speed</td>
    <td>m/s</td>
    <td>\\(281.6\\)</td>
    </tr>
    <tr>
    <td>Frequency</td>
    <td>Hz</td>
    <td>\\(440\\)</td>
    </tr>
    <tr>
    <td>Length</td>
    <td>m</td>
    <td>\\(0.32\\)</td>
    </tr>
    </tbody>
    </table>
    </data-table>
    \`\`\`

---

### **Handling Code and Graphics**

* **Code Blocks:** Always in Markdown format. If LaTeX code is explicitly requested, use this format as well.
    \`\`\`python
    def calculate_area(radius):
        """Calculates the area of a circle"""
        return 3.1416 * radius ** 2

    print(calculate_area(5))  # Example usage
    \`\`\`
* **Graphics (only if explicitly requested):** Use the following format, including a brief description in the <plotly-chart> tag.
    \`\`\`plotly-js
    // Chart data
    const data = [{
      x: ['Jan', 'Feb', 'Mar', 'Apr'],
      y: [20, 14, 25, 16],
      type: 'bar',
      marker: {
        color: 'rgb(55, 83, 109)'
      }
    }];

    // Layout configuration
    const layout = {
      title: 'Sales by Month',
      xaxis: {
        title: 'Month'
      },
      yaxis: {
        title: 'Sales (thousands)'
      },
      margin: {
        l: 50,
        r: 50,
        b: 50,
        t: 50,
        pad: 4
      }
    };

    // Render the chart
    Plotly.newPlot('graph-container', data, layout);
    \`\`\`
    <plotly-chart>
    This bar chart shows monthly sales for the first quarter, with a peak in March followed by a decrease in April.
    </plotly-chart>
`
    }
};

// --- STREAMING ---
async function queryDeepSeekAPI(userMessage, onPartial, onComplete) {
    const mode = isMathTutorMode ? 'tutor' : 'normal';
    const systemContent = systemPrompts[currentLanguage]?.[mode] || systemPrompts['en'][mode];

    const response = await fetch("https://backend-6eik.onrender.com/chat", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            model: currentModel,
            messages: [
                { role: "system", content: systemContent },
                { role: "user", content: userMessage }
            ],
            temperature: isMathTutorMode ? 0.2 : 0.3,
            max_tokens: 2048,
            stream: true
        })
    });

    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(`Error ${response.status}: ${response.statusText}. ${errorData.message || ''}`);
    }

    let fullText = "";
    let pendingText = "";
    let lastUpdate = Date.now();
    let buffer = "";

    try {
        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop(); // mantener l√≠nea incompleta

            for (const line of lines) {
                if (!line.trim()) continue;

                if (line.startsWith("data: ")) {
                    const data = line.replace("data: ", "");
                    if (data === "[DONE]") {
                        if (onComplete) onComplete(fullText);
                        return fullText;
                    }
                    try {
                        const parsed = JSON.parse(data);
                        const delta = parsed.choices?.[0]?.delta?.content || "";
                        if (delta) {
                            fullText += delta;
                            pendingText += delta;
                        }
                    } catch (err) {
                        console.warn("Stream parse error:", err, line);
                    }
                }
            }

            // üîπ Throttle updates cada 400ms
            if (Date.now() - lastUpdate > 400 && pendingText.length > 0) {
                if (onPartial) onPartial(fullText);
                pendingText = "";
                lastUpdate = Date.now();
            }
        }

        // Ultima actualizaci√≥n pendiente
        if (pendingText.length > 0 && onPartial) {
            onPartial(fullText);
        }

        if (onComplete) onComplete(fullText);
        return fullText;

    } catch (err) {
        throw new Error(`Error leyendo el stream: ${err.message}`);
    }
}


// --- ENV√çO ---
async function sendMessage() {
    closeCustomKeyboard();
    const userMessage = mathField.getValue().trim();
    if (!userMessage) return;

    // Mensaje del usuario

    appendMessage("user", userMessage, { renderMath: false });
    appendMessage("user", userMessage, { renderMath: true });

    mathField.setValue("");
    mathField.focus();

    const box = document.getElementById("chatBox");
    const msg = document.createElement("div");
    msg.className = "chat-msg bot";

    const bubble = document.createElement("div");
    bubble.className = "chat-bubble bot-content";
    bubble.innerHTML = `
        <div class="loading-indicator">
            <div class="loading-dot" style="animation-delay: 0s"></div>
            <div class="loading-dot" style="animation-delay: 0.2s"></div>
            <div class="loading-dot" style="animation-delay: 0.4s"></div>
        </div>
    `;
    msg.appendChild(bubble);
    box.appendChild(msg);
    box.scrollTop = box.scrollHeight;

    try {
        const context = getContextPrompt();
        const messageWithContext = userMessage + context;
        const cacheKey = messageWithContext.toLowerCase().trim();

        if (responseCache.has(cacheKey)) {
            const cachedResponse = responseCache.get(cacheKey);
            bubble.innerHTML = formatBotResponse(cachedResponse);
            processNewContent(bubble);
            updateContext(userMessage, cachedResponse);
            return;
        }

        await queryDeepSeekAPI(
            messageWithContext,
            // onPartial ‚Üí versi√≥n ligera (solo LaTeX)
            (partialText) => {
                bubble.innerHTML = formatBotResponseLite(partialText);
                if (window.MathJax) {
                    MathJax.typesetPromise([bubble]).catch(() => {});
                }
                box.scrollTop = box.scrollHeight;
            },
            // onComplete ‚Üí versi√≥n completa
            (fullText) => {
                bubble.innerHTML = formatBotResponse(fullText);
                processNewContent(bubble);
                responseCache.set(cacheKey, fullText);
                updateContext(userMessage, fullText);
                box.scrollTop = box.scrollHeight;
            }
        );

    } catch (error) {
        bubble.innerHTML = `<div class="error-message">‚ö†Ô∏è ${escapeHtml(error.message)}</div>`;
        box.scrollTop = box.scrollHeight;
    }
}


// --- VERSI√ìN LIGERA PARA STREAM ---
function formatBotResponseLite(text) {
    if (!text) return "";

    // üîπ Inline math $...$
    text = text.replace(/(^|[^\\])\$([^\$]+?)\$/g, (m, pre, eq) => `${pre}\\(${eq}\\)`);

    // üîπ Block math $$...$$
    text = text.replace(/\$\$([\s\S]*?)\$\$/g, (m, eq) => `\\[${eq}\\]`);

    // üîπ Markdown b√°sico
    text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
    text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
    text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    text = text.replace(/^-{3,}$/gm, '<hr>');

    // üîπ Escapar cosas peligrosas
    text = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");

    // üîπ Restaurar etiquetas que s√≠ queremos permitir
    const allowedTags = ['h1','h2','h3','strong','em','hr'];
    for (const tag of allowedTags) {
        text = text.replace(new RegExp(`&lt;(${tag})([^&>]*)&gt;`, 'g'), `<$1$2>`);
        text = text.replace(new RegExp(`&lt;\/(${tag})&gt;`, 'g'), `</$1>`);
    }

    return `<div class="math-equation-stream">${text}</div>`;
}




function formatBotResponse(text, isMathTutorMode = false) {
    // 0. Primero extraer los bloques plotly-js y guardarlos con placeholders
    const plotlyBlocks = [];
    text = text.replace(/```plotly-js\n([\s\S]*?)```/g, (_match, code) => {
        const id = `plotly-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        plotlyBlocks.push({ id, code });
        return `~~~PLOTLY_BLOCK_${id}~~~`;
    });

    // 1. Normalizar ecuaciones matem√°ticas
    // - Mantener $$...$$ como est√° (bloques)
    // - Convertir $...$ (inline) en \( ... \)
    // - Respetar \(...\) y \[...\]
    text = text
        // Primero, asegurar que no tocamos los $$...$$
        .replace(/\$\$([\s\S]*?)\$\$/g, (m, eq) => `\\[${eq}\\]`)
        // Luego, los $...$ inline
        .replace(/(^|[^\\])\$([^\$]+?)\$/g, (m, pre, eq) => `${pre}\\(${eq}\\)`);

    
    // 2. Procesar bloques de c√≥digo normales
    let formattedText = text.replace(/```([a-z-]*)\n([\s\S]*?)\n```/gi, 
        (_match, lang, code) => {
            lang = lang.trim().toLowerCase();
            return `<div class="code-block" data-lang="${lang}">
                <span class="code-lang">${lang}</span>
                <button class="copy-btn"><i class="fas fa-copy"></i> Copiar</button>
                <pre><code class="language-${lang}">${escapeHtml(code.trim())}</code></pre>
            </div>`;
        });

    // 3. Procesar ecuaciones matem√°ticas (SOLO formatos permitidos)
    const mathPlaceholders = [];
    formattedText = formattedText.replace(/(\\\([\s\S]*?\\\)|\$\$[\s\S]*?\$\$|\\\[[\s\S]*?\\\])/g, 
        (match) => {
            const placeholder = `~~~MATH_${mathPlaceholders.length}~~~`;
            mathPlaceholders.push(match);
            return placeholder;
        });

    // --- Markdown b√°sico y etiquetas personalizadas ---
    formattedText = formattedText.replace(/^# (.*$)/gm, '<h1>$1</h1>');
    formattedText = formattedText.replace(/^## (.*$)/gm, '<h2 class="title">$1</h2>');
    formattedText = formattedText.replace(/^### (.*$)/gm, '<h3 class="subtitle">$1</h3>');
    formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    formattedText = formattedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
    formattedText = formattedText.replace(/^-{3,}$/gm, '<hr>');
    formattedText = formattedText.replace(/^\* (.*$)/gm, '<li>$1</li>');
    formattedText = formattedText.replace(/(<li>.*?<\/li>)+/gs, '<ul>$1</ul>');
    formattedText = formattedText.replace(/^\d+\. (.*$)/gm, '<li>$1</li>');
    formattedText = formattedText.replace(/(<li>.*?<\/li>)+/gs, '<ol>$1</ol>');

    // Etiquetas personalizadas
    if (isMathTutorMode) {
        formattedText = formattedText
            .replace(/<hint>(.*?)<\/hint>/gs, '<div class="tutor-hint"><strong>Pista:</strong> $1</div>')
            .replace(/<guide>(.*?)<\/guide>/gs, '<div class="tutor-guide"><strong>Pregunta gu√≠a:</strong> $1</div>')
            .replace(/<concept>(.*?)<\/concept>/gs, '<div class="tutor-concept"><strong>Concepto:</strong> $1</div>')
            .replace(/<step>(.*?)<\/step>/gs, '<div class="tutor-step"><strong>Sugerencia:</strong> $1</div>')
            .replace(/<check>(.*?)<\/check>/gs, '<div class="tutor-check"><strong>Feedback:</strong> $1</div>');
    } else {
        formattedText = formattedText
            .replace(/<step>(.*?)<\/step>/gs, (_match, content) => {
                return `<div class="step">${content}<a class="explain-link" onclick="explainStep(this)">""Ask to Chat</a></div>`;
            })
            .replace(/<definition>(.*?)<\/definition>/gs, (_match, content) => {
                return `<div class="definition">${content}</div>`;
            })
            .replace(/<example-section>(.*?)<\/example-section>/gs, (_match, content) => {
                return `<div class="example-section">${content}</div>`;
            })
            .replace(/<problem-statement>(.*?)<\/problem-statement>/gs, (_match, content) => {
                return `<div class="problem-statement"><h4>Problema:</h4>${content}</div>`;
            })
            .replace(/<sol>(.*?)<\/sol>/gs, (_match, solution) => {
                return `<div class="full-solution">
                    <h3 class="subtitle">Soluci√≥n final:</h3>
                    <div class="solution-content">${solution}</div>
                    <div class="copy-full-latex" onclick="sendLatexToInput(this.previousElementSibling.textContent.trim())">
                        <i class="fas fa-paper-plane"></i> Probar este c√≥digo en LaTeX
                    </div>
                </div>`;
            })
            .replace(/<data-table>(.*?)<\/data-table>/gs, (_match, content) => {
                return `<div class="data-table">${content}</div>`;
            })
            .replace(/<alert-info>(.*?)<\/alert-info>/gs, '<div class="alert-info"><i class="fas fa-info-circle"></i> <strong>Informaci√≥n:</strong> $1</div>')
            .replace(/<alert-warning>(.*?)<\/alert-warning>/gs, '<div class="alert-warning"><i class="fas fa-exclamation-triangle"></i> <strong>¬°Advertencia!</strong> $1</div>')
            .replace(/<alert-success>(.*?)<\/alert-success>/gs, '<div class="alert-success"><i class="fas fa-check-circle"></i> <strong>√âxito:</strong> $1</div>')
            .replace(/<alert-tip>(.*?)<\/alert-tip>/gs, '<div class="alert-tip"><i class="fas fa-lightbulb"></i> <strong>Consejo:</strong> $1</div>')
            .replace(/<reference>(.*?)<\/reference>/gs, '<div class="reference"><small><strong>Fuente:</strong> $1</small></div>')
            .replace(/<highlight>(.*?)<\/highlight>/gs, '<span class="highlight">$1</span>')
            .replace(/<important>(.*?)<\/important>/gs, '<span class="important">$1</span>')
            .replace(/<note>(.*?)<\/note>/gs, '<div class="note">$1</div>')
            .replace(/<math-text>(.*?)<\/math-text>/gs, '<span class="math-text">$1</span>')
            .replace(/<math-block>(.*?)<\/math-block>/gs, '<div class="math-block">$1</div>');
    }

    // 4. Restaurar ecuaciones matem√°ticas (bloques: bot√≥n; inline: sin tocar)
    mathPlaceholders.forEach((math, index) => {
        const isBlock = /^\$\$[\s\S]*\$\$$/.test(math) || /^\\\[/.test(math);

        if (isBlock) {
            // Obtener raw LaTeX sin delimitadores
            const rawLatex = math
                .replace(/^\$\$|\$\$$/g, '')   // quitar $$ ... $$
                .replace(/^\\\[|\\\]$/g, '');  // quitar \[ ... \]

            // Codificar para que no rompa atributos HTML (escape de comillas, saltos, etc.)
            const encoded = encodeURIComponent(rawLatex);

            // Contenedor con data-latex (MathJax renderizar√° el math dentro)
            const html = `
                <div class="clickable-math-block" data-latex="${encoded}">
                    <div class="math-equation">${math}</div>
                </div>
            `;

            formattedText = formattedText.replace(`~~~MATH_${index}~~~`, html);
        } else {
            // inline: dejar tal cual (sin envoltorio ni bot√≥n)
            formattedText = formattedText.replace(`~~~MATH_${index}~~~`, math);
        }
    });

    plotlyBlocks.forEach(block => {
        const plotlyHtml = `
            <div id="${block.id}" class="plotly-graph-container">
                <div class="plotly-loading">Cargando gr√°fico...</div>
            </div>
            <script>
                (function() {
                    function renderPlotly() { // <-- ESTA es la funci√≥n dentro del script que se inyecta
                        const container = document.getElementById('${block.id}');
                        if (!container) return;
                        
                        if (typeof Plotly === 'undefined') {
                            container.innerHTML = '<div class="plotly-error">Error: Plotly.js no est√° cargado</div>';
                            return;
                        }
                        
                        try {
                            // Limpiar y validar el c√≥digo
                            const cleanCode = ${JSON.stringify(block.code)}
                                .replace(/\\beval\\b|\\bnew Function\\b/g, '')
                                .replace(/['"]graph-container['"]/g, '${block.id}');
                            
                            // *******************************************************************
                            // ******** AQU√ç ES DONDE VAMOS A A√ëADIR LOS CONSOLE.LOGS ************
                            // *******************************************************************

                            // 1. Log del c√≥digo limpio que se intenta procesar
                            console.log('Plotly Debug: cleanCode para ID ${block.id}:', cleanCode);
                            
                            // Extraer datos y layout de forma segura
                            const dataMatch = cleanCode.match(/const data = (\\[[\\s\\S]*?\\]);/);
                            const layoutMatch = cleanCode.match(/const layout = (\\{[\\s\\S]*?\\});/);
                            
                            if (!dataMatch || !layoutMatch) {
                                // 2. Log si no se encuentran los patrones de data o layout
                                console.error('Plotly Debug: Formato de c√≥digo inv√°lido. No se encontraron "data" o "layout" en el cleanCode. ID:', '${block.id}', 'cleanCode:', cleanCode);
                                throw new Error('Formato de c√≥digo inv√°lido');
                            }
                            
                            // Parsear con validaci√≥n
                            const parsePlotlyObj = (str) => {
                                const fixedStr = str
                                    .replace(/([\\{\\,]\\s*)(\\w+)\\s*:/g, '$1"$2":')
                                    .replace(/'/g, '"');
                                // 3. Log de la cadena arreglada antes de JSON.parse
                                console.log('Plotly Debug: String a parsear (fixedStr):', fixedStr.substring(0, 500)); // Limitamos para no llenar la consola

                                return JSON.parse(fixedStr);
                            };
                            
                            const data = parsePlotlyObj(dataMatch[1]);
                            const layout = parsePlotlyObj(layoutMatch[1]);
                            
                            // 4. Log de los objetos data y layout ya parseados
                            console.log('Plotly Debug: Objeto data parseado para ID ${block.id}:', data);
                            console.log('Plotly Debug: Objeto layout parseado para ID ${block.id}:', layout);

                            // Configuraci√≥n responsive
                            layout.autosize = true;
                            layout.margin = layout.margin || { l: 50, r: 50, b: 50, t: 50, pad: 4 };
                            
                            // 5. Opcional: A√±adir un peque√±o retraso aqu√≠ para ver si es un problema de renderizado del DOM
                            // setTimeout(() => { // Descomenta esta l√≠nea
                                // Renderizar
                                Plotly.newPlot('${block.id}', data, layout)
                                    .then(() => {
                                        console.log('Plotly Debug: Gr√°fico renderizado con √©xito para ID ${block.id}'); // <-- √âxito
                                        container.querySelector('.plotly-loading')?.remove();
                                    })
                                    .catch(e => {
                                        // 6. Log del error espec√≠fico de Plotly.newPlot
                                        console.error('Plotly Debug: Error en Plotly.newPlot para ID ${block.id}:', e);
                                        throw new Error('Error al renderizar: ' + e.message);
                                    });
                            // }, 100); // Descomenta esta l√≠nea y su correspondiente }
                                
                        } catch(e) {
                            container.innerHTML = '<div class="plotly-error">' + 
                                'Error en el gr√°fico: ' + e.message.replace(/</g, '&lt;') + '</div>';
                            // 7. Log del error general del bloque de Plotly
                            console.error('Plotly Debug: Error general del bloque de gr√°fico para ID ${block.id}:', e);
                        }
                    }
                    
                    // Esperar a que todo est√© listo
                    if (document.readyState === 'complete') {
                        renderPlotly();
                    } else {
                        window.addEventListener('load', renderPlotly);
                    }
                })();
            </scr"+"ipt>
        `;
        formattedText = formattedText.replace(`~~~PLOTLY_BLOCK_${block.id}~~~`, plotlyHtml);
    });
    // --- Escapado seguro ---
    let finalFormattedText = formattedText
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    const allowedTags = [
        'h1', 'h2', 'h3', 'h4', 'strong', 'em', 'hr', 'ul', 'ol', 'li',
        'div', 'a', 'i', 'span', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'small', 'p',
        'button', 'code', 'pre', 'script'
    ];

    for (const tag of allowedTags) {
        finalFormattedText = finalFormattedText.replace(new RegExp(`&lt;(${tag})([^&>]*)&gt;`, 'g'), `<$1$2>`);
        finalFormattedText = finalFormattedText.replace(new RegExp(`&lt;\/(${tag})&gt;`, 'g'), `</$1>`);
    }

    return finalFormattedText;
}

function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;")
        .replace(/\//g, "&#x2F;");  // Escapar tambi√©n barras diagonales
}


function processNewContent(container) {
    if (!container) return;

    // 1. Procesar MathJax con reintentos
    const processMathJax = () => {
        if (window.MathJax) { // <--- Esta es la comprobaci√≥n
            MathJax.typesetPromise([container]).catch(err => {
                console.error("MathJax error, retrying...", err);
                setTimeout(processMathJax, 500);
            });
        }
    };
    processMathJax(); // <--- Aqu√≠ es donde se llama la primera vez

    // 2. Resaltado de sintaxis
    if (window.hljs) {
        container.querySelectorAll('pre code').forEach(block => {
            hljs.highlightElement(block);
        });
    }

    // 3. Verificar gr√°ficos Plotly peri√≥dicamente
    const plotlyContainers = container.querySelectorAll('.plotly-graph-container');
    plotlyContainers.forEach(container => {
        const checkPlotly = setInterval(() => {
            if (container.querySelector('div.plotly')) {
                clearInterval(checkPlotly);
                container.querySelector('.plotly-loading')?.remove();
            }
        }, 300);
        
        // Timeout despu√©s de 5 segundos
        setTimeout(() => {
            clearInterval(checkPlotly);
            if (!container.querySelector('div.plotly')) {
                container.innerHTML = '<div class="plotly-error">Error: El gr√°fico no se carg√≥</div>';
            }
        }, 5000);
    });
}

function formatUserMessage(text) {
    // Busca \text{...} de manera no codiciosa para evitar capturar m√∫ltiples bloques.
    const plainText = text.replace(/\\text\{([^{}]*)\}/g, '$1'); 

    return plainText;
}

function appendMessage(sender, text, options = { renderMath: true }) {
    const box = document.getElementById("chatBox");
    const msg = document.createElement("div");
    msg.className = `chat-msg ${sender}`;

    const bubble = document.createElement("div");
    bubble.className = "chat-bubble";

    if (sender === "user") {
        if (options.renderMath) {
            bubble.style.backgroundColor = "#7E7E7E";
            bubble.innerHTML = `\\[${text}\\]`;
            renderMathAndCode(bubble);
        } else {
            bubble.textContent = formatUserMessage(text);
        }
    } else {
        bubble.innerHTML = formatBotResponse(text);
        renderMathAndCode(bubble);
    }

    msg.appendChild(bubble);
    box.appendChild(msg);

    // üîπ Limitar mensajes: mantener siempre al menos 3, borrar los m√°s viejos solo si hay m√°s
    const MAX_MESSAGES = 3;
    while (box.children.length > MAX_MESSAGES) {
        const oldest = box.firstElementChild;
        if (!oldest) break;
        oldest.remove();
    }

    box.scrollTop = box.scrollHeight;
    processNewContent(bubble);
}


</script></body>
</html>